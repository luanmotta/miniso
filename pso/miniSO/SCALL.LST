Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 1
scall.ASM



      1				     $comm   macro   name,dist,size,count
      2					     comm    dist name[size]:BYTE:count
      3					     endm
      4					     ?debug  V 300h
      5					     ?debug  S "scall.c"
      6					     ?debug  C E903197847077363616C6C2E63
      7					     ?debug  C E9EE217847086D696E69534F2E68
      8					     ?debug  C E925548441077363616C6C2E68
      9					     ?debug  C E925548441056C69622E68
     10	0000			     _TEXT   segment byte public 'CODE'
     11	0000			     _TEXT   ends
     12				     DGROUP  group   _DATA,_BSS
     13					     assume  cs:_TEXT,ds:DGROUP
     14	0000			     _DATA   segment word public 'DATA'
     15	0000			     d@	     label   byte
     16	0000			     d@w     label   word
     17	0000			     _DATA   ends
     18	0000			     _BSS    segment word public 'BSS'
     19	0000			     b@	     label   byte
     20	0000			     b@w     label   word
     21	0000			     _BSS    ends
     22	0000			     _DATA   segment word public 'DATA'
     23	0000			     miniSO_col	     label   byte
     24	0000  50			     db	     80
     25	0001			     miniSO_cor	     label   byte
     26	0001  07			     db	     7
     27	0002			     miniSO_pag	     label   byte
     28	0002  00			     db	     0
     29	0003			     miniSO_iskey    label   byte
     30	0003  00			     db	     0
     31	0004			     miniSO_key	     label   byte
     32	0004  00			     db	     0
     33	0005			     nextsemid	     label   word
     34	0005  00			     db	     0
     35	0006  00			     db	     0
     36	0007			     _miniSO_ready   label   word
     37	0007  FF			     db	     255
     38	0008  FF			     db	     255
     39	0009			     _miniSO_free    label   word
     40	0009  FF			     db	     255
     41	000A  FF			     db	     255
     42	000B			     _miniSO_scall_table     label   word
     43	000B  00			     db	     0
     44	000C  01			     db	     1
     45	000D  00			     db	     0
     46	000E  00DAr			     dw	     _sc_putch
     47	0010  01			     db	     1
     48	0011  00			     db	     0
     49	0012  00			     db	     0
     50	0013  0170r			     dw	     _sc_getch
     51	0015  02			     db	     2
     52	0016  00			     db	     0
     53	0017  00			     db	     0
     54	0018  01C0r			     dw	     _sc_clrscr
     55	001A  03			     db	     3
     56	001B  00			     db	     0
     57	001C  00			     db	     0
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 2
scall.ASM



     58	001D  01E2r			     dw	     _sc_getcolor
     59	001F  04			     db	     4
     60	0020  01			     db	     1
     61	0021  00			     db	     0
     62	0022  01EDr			     dw	     _sc_setcolor
     63	0024  05			     db	     5
     64	0025  00			     db	     0
     65	0026  00			     db	     0
     66	0027  01FCr			     dw	     _sc_wherex
     67	0029  06			     db	     6
     68	002A  00			     db	     0
     69	002B  00			     db	     0
     70	002C  0209r			     dw	     _sc_wherey
     71	002E  07			     db	     7
     72	002F  02			     db	     2
     73	0030  00			     db	     0
     74	0031  021Ar			     dw	     _sc_gotoxy
     75	0033  08			     db	     8
     76	0034  02			     db	     2
     77	0035  00			     db	     0
     78	0036  0248r			     dw	     _sc_getdate
     79	0038  09			     db	     9
     80	0039  02			     db	     2
     81	003A  00			     db	     0
     82	003B  02F8r			     dw	     _sc_gettime
     83	003D  0A			     db	     10
     84	003E  00			     db	     0
     85	003F  00			     db	     0
     86	0040  05B8r			     dw	     _sc_reboot
     87	0042  0B			     db	     11
     88	0043  02			     db	     2
     89	0044  00			     db	     0
     90	0045  05D8r			     dw	     _sc_fork
     91	0047  0C			     db	     12
     92	0048  01			     db	     1
     93	0049  00			     db	     0
     94	004A  0834r			     dw	     _sc_kill
     95	004C  0D			     db	     13
     96	004D  03			     db	     3
     97	004E  00			     db	     0
     98	004F  0B2Er			     dw	     _sc_waitpid
     99	0051  0E			     db	     14
    100	0052  02			     db	     2
    101	0053  00			     db	     0
    102	0054  0D01r			     dw	     _sc_wait
    103	0056  0F			     db	     15
    104	0057  01			     db	     1
    105	0058  00			     db	     0
    106	0059  0E81r			     dw	     _sc_exit
    107	005B  10			     db	     16
    108	005C  00			     db	     0
    109	005D  00			     db	     0
    110	005E  1106r			     dw	     _sc_getpid
    111	0060  11			     db	     17
    112	0061  00			     db	     0
    113	0062  00			     db	     0
    114	0063  111Br			     dw	     _sc_getppid
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 3
scall.ASM



    115	0065  12			     db	     18
    116	0066  02			     db	     2
    117	0067  00			     db	     0
    118	0068  1130r			     dw	     _sc_sendsignal
    119	006A  13			     db	     19
    120	006B  01			     db	     1
    121	006C  00			     db	     0
    122	006D  1230r			     dw	     _sc_waitsignal
    123	006F  14			     db	     20
    124	0070  01			     db	     1
    125	0071  00			     db	     0
    126	0072  1366r			     dw	     _sc_semcreate
    127	0074  15			     db	     21
    128	0075  02			     db	     2
    129	0076  00			     db	     0
    130	0077  13F1r			     dw	     _sc_semset
    131	0079  16			     db	     22
    132	007A  01			     db	     1
    133	007B  00			     db	     0
    134	007C  142Ar			     dw	     _sc_semup
    135	007E  17			     db	     23
    136	007F  01			     db	     1
    137	0080  00			     db	     0
    138	0081  1517r			     dw	     _sc_semdown
    139	0083  18			     db	     24
    140	0084  01			     db	     1
    141	0085  00			     db	     0
    142	0086  165Dr			     dw	     _sc_semdestroy
    143	0088			     _DATA   ends
    144	0000			     _TEXT   segment byte public 'CODE'
    145					;
    146					;    int scall(unsigned	servico,unsigned bx,unsigned cx,unsigned dx)
    147					;
    148					     assume  cs:_TEXT
    149	0000			     _scall  proc    near
    150	0000  55			     push    bp
    151	0001  8B EC			     mov     bp,sp
    152	0003  56			     push    si
    153	0004  57			     push    di
    154	0005  8B 7E 06			     mov     di,word ptr [bp+6]
    155					;
    156					;    {
    157					;	     int     i;
    158					;
    159					;	     for     (i=0;i<miniSO_NUMSCALL;++i) {
    160					;
    161	0008  33 F6			     xor     si,si
    162	000A  EB 7C 90			     jmp     @1@338
    163	000D			     @1@58:
    164					;
    165					;		     if	     (servico==(unsigned)miniSO_scall_table[i].ah) {
    166					;
    167	000D  8B C6			     mov     ax,si
    168	000F  BA 0005			     mov     dx,5
    169	0012  F7 EA			     imul    dx
    170	0014  8B D8			     mov     bx,ax
    171	0016  8A 87 000Br		     mov     al,byte ptr DGROUP:_miniSO_scall_table[bx]
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 4
scall.ASM



    172	001A  98			     cbw
    173	001B  3B 46 04			     cmp     ax,word ptr [bp+4]
    174	001E  75 67			     jne     short @1@310
    175					;
    176					;			     switch  (miniSO_scall_table[i].numparam)  {
    177					;
    178	0020  8B C6			     mov     ax,si
    179	0022  BA 0005			     mov     dx,5
    180	0025  F7 EA			     imul    dx
    181	0027  8B D8			     mov     bx,ax
    182	0029  8B 9F 000Cr		     mov     bx,word ptr DGROUP:_miniSO_scall_table[bx+1]
    183	002D  83 FB 03			     cmp     bx,3
    184	0030  77 55			     ja	     short @1@310
    185	0032  D1 E3			     shl     bx,1
    186	0034  2E: FF A7	0098r		     jmp     word ptr cs:@1@C434[bx]
    187	0039			     @1@170:
    188					;
    189					;				     case    0:
    190					;					     return miniSO_scall_table[i].function.p0();
    191					;
    192	0039  8B C6			     mov     ax,si
    193	003B  BA 0005			     mov     dx,5
    194	003E  F7 EA			     imul    dx
    195	0040  8B D8			     mov     bx,ax
    196	0042  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    197	0046			     @1@198:
    198	0046  EB 4C			     jmp     short @1@394
    199	0048			     @1@226:
    200					;
    201					;				     case    1:
    202					;					     return miniSO_scall_table[i].function.p1(bx);
    203					;
    204	0048  57			     push    di
    205	0049  8B C6			     mov     ax,si
    206	004B  BA 0005			     mov     dx,5
    207	004E  F7 EA			     imul    dx
    208	0050  8B D8			     mov     bx,ax
    209	0052  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    210	0056  59			     pop     cx
    211	0057  EB ED			     jmp     short @1@198
    212	0059			     @1@254:
    213					;
    214					;				     case    2:
    215					;					     return miniSO_scall_table[i].function.p2(bx,cx);
    216					;
    217	0059  FF 76 08			     push    word ptr [bp+8]
    218	005C  57			     push    di
    219	005D  8B C6			     mov     ax,si
    220	005F  BA 0005			     mov     dx,5
    221	0062  F7 EA			     imul    dx
    222	0064  8B D8			     mov     bx,ax
    223	0066  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    224	006A  59			     pop     cx
    225	006B  59			     pop     cx
    226	006C  EB D8			     jmp     short @1@198
    227	006E			     @1@282:
    228					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 5
scall.ASM



    229					;				     case    3:
    230					;					     return miniSO_scall_table[i].function.p3(bx,cx,+
    231				     dx);
    232					;
    233	006E  FF 76 0A			     push    word ptr [bp+10]
    234	0071  FF 76 08			     push    word ptr [bp+8]
    235	0074  57			     push    di
    236	0075  8B C6			     mov     ax,si
    237	0077  BA 0005			     mov     dx,5
    238	007A  F7 EA			     imul    dx
    239	007C  8B D8			     mov     bx,ax
    240	007E  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    241	0082  83 C4 06			     add     sp,6
    242	0085  EB BF			     jmp     short @1@198
    243	0087			     @1@310:
    244	0087  46			     inc     si
    245	0088			     @1@338:
    246	0088  83 FE 19			     cmp     si,25
    247	008B  7D 03			     jge     @@0
    248	008D  E9 FF7D			     jmp     @1@58
    249	0090			     @@0:
    250					;
    251					;			     }
    252					;		     }
    253					;	     }
    254					;	     return 0;
    255					;
    256	0090  33 C0			     xor     ax,ax
    257	0092  EB B2			     jmp     short @1@198
    258	0094			     @1@394:
    259					;
    260					;    }
    261					;
    262	0094  5F			     pop     di
    263	0095  5E			     pop     si
    264	0096  5D			     pop     bp
    265	0097  C3			     ret
    266	0098			     _scall  endp
    267	0098			     @1@C434 label   word
    268	0098  0039r			     dw	     @1@170
    269	009A  0048r			     dw	     @1@226
    270	009C  0059r			     dw	     @1@254
    271	009E  006Er			     dw	     @1@282
    272					;
    273					;    void setCursorPosition(int	pos)
    274					;
    275					     assume  cs:_TEXT
    276	00A0			     setCursorPosition	     proc    near
    277	00A0  55			     push    bp
    278	00A1  8B EC			     mov     bp,sp
    279					;
    280					;    {
    281					;	     mov_dx(pos);
    282					;
    283	00A3  8B 56 04			     mov     dx,word ptr [bp+4]
    284					;
    285					;	     mov_bh(miniSO_pag);
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 6
scall.ASM



    286					;
    287	00A6  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    288					;
    289					;	     mov_ah(2);
    290					;
    291	00AA  B4 02			     mov     ah,2
    292					;
    293					;	     int_10h();
    294					;
    295	00AC  CD 10			     int      10h
    296					;
    297					;    }
    298					;
    299	00AE  5D			     pop     bp
    300	00AF  C3			     ret
    301	00B0			     setCursorPosition	     endp
    302					;
    303					;    int getCursorPosition()
    304					;
    305					     assume  cs:_TEXT
    306	00B0			     getCursorPosition	     proc    near
    307	00B0  55			     push    bp
    308	00B1  8B EC			     mov     bp,sp
    309					;
    310					;    {
    311					;	     mov_bh(miniSO_pag);
    312					;
    313	00B3  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    314					;
    315					;	     mov_ah(3);
    316					;
    317	00B7  B4 03			     mov     ah,3
    318					;
    319					;	     int_10h();
    320					;
    321	00B9  CD 10			     int      10h
    322					;
    323					;	     return _DX;
    324					;
    325	00BB  8B C2			     mov     ax,dx
    326	00BD  EB 00			     jmp     short @3@114
    327	00BF			     @3@114:
    328					;
    329					;    }
    330					;
    331	00BF  5D			     pop     bp
    332	00C0  C3			     ret
    333	00C1			     getCursorPosition	     endp
    334					;
    335					;    void scroll()
    336					;
    337					     assume  cs:_TEXT
    338	00C1			     scroll  proc    near
    339	00C1  55			     push    bp
    340	00C2  8B EC			     mov     bp,sp
    341					;
    342					;    {
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 7
scall.ASM



    343					;	     mov_al(1);	/* número de linhas para scroll	*/
    344					;
    345	00C4  B0 01			     mov     al,1
    346					;
    347					;	     mov_cx(0);
    348					;
    349	00C6  33 C9			     xor     cx,cx
    350					;
    351					;	     mov_ah(6);
    352					;
    353	00C8  B4 06			     mov     ah,6
    354					;
    355					;	     mov_dh(24);
    356					;
    357	00CA  B6 18			     mov     dh,24
    358					;
    359					;	     mov_dl(miniSO_col);
    360					;
    361	00CC  8A 16 0000r		     mov     dl,byte ptr DGROUP:miniSO_col
    362					;
    363					;	     dec_dl();
    364					;
    365	00D0  FE CA			     dec      dl
    366					;
    367					;	     mov_bh(miniSO_cor);
    368					;
    369	00D2  8A 3E 0001r		     mov     bh,byte ptr DGROUP:miniSO_cor
    370					;
    371					;	     int_10h();
    372					;
    373	00D6  CD 10			     int      10h
    374					;
    375					;    }
    376					;
    377	00D8  5D			     pop     bp
    378	00D9  C3			     ret
    379	00DA			     scroll  endp
    380					;
    381					;    int sc_putch(int car)
    382					;
    383					     assume  cs:_TEXT
    384	00DA			     _sc_putch	     proc    near
    385	00DA  55			     push    bp
    386	00DB  8B EC			     mov     bp,sp
    387	00DD  83 EC 02			     sub     sp,2
    388	00E0  56			     push    si
    389	00E1  57			     push    di
    390					;
    391					;    {
    392					;	     int     curpos,lin,col;
    393					;
    394					;	     car = car & 0x00ff;
    395					;
    396	00E2  8B 46 04			     mov     ax,word ptr [bp+4]
    397	00E5  25 00FF			     and     ax,255
    398	00E8  89 46 04			     mov     word ptr [bp+4],ax
    399					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 8
scall.ASM



    400					;	     if	     (car==10)	{
    401					;
    402	00EB  83 7E 04 0A		     cmp     word ptr [bp+4],10
    403	00EF  75 22			     jne     short @5@170
    404					;
    405					;		     curpos = getCursorPosition();
    406					;
    407	00F1  E8 FFBC			     call    near ptr getCursorPosition
    408	00F4  8B F8			     mov     di,ax
    409					;
    410					;		     lin = (curpos >> 8) & 0x00ff;
    411					;
    412	00F6  8B C7			     mov     ax,di
    413	00F8  B1 08			     mov     cl,8
    414	00FA  D3 F8			     sar     ax,cl
    415	00FC  25 00FF			     and     ax,255
    416	00FF  8B F0			     mov     si,ax
    417					;
    418					;		     col = 0;
    419					;
    420	0101  C7 46 FE 0000		     mov     word ptr [bp-2],0
    421					;
    422					;		     if	     (lin<24)
    423					;
    424	0106  83 FE 18			     cmp     si,24
    425	0109  7D 03			     jge     short @5@114
    426					;
    427					;			     ++lin;
    428					;
    429	010B  46			     inc     si
    430	010C  EB 03			     jmp     short @5@142
    431	010E			     @5@114:
    432					;
    433					;		     else
    434					;			     scroll();
    435					;
    436	010E  E8 FFB0			     call    near ptr scroll
    437	0111			     @5@142:
    438					;
    439					;	     }
    440					;
    441	0111  EB 43			     jmp     short @5@338
    442	0113			     @5@170:
    443					;
    444					;	     else    {
    445					;		     /*	Imprime	o caracter */
    446					;		     mov_bl(miniSO_cor);
    447					;
    448	0113  8A 1E 0001r		     mov     bl,byte ptr DGROUP:miniSO_cor
    449					;
    450					;		     mov_bh(miniSO_pag);
    451					;
    452	0117  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    453					;
    454					;		     mov_cx(1);
    455					;
    456	011B  B9 0001			     mov     cx,1
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 9
scall.ASM



    457					;
    458					;		     mov_ah(0x9);
    459					;
    460	011E  B4 09			     mov     ah,9
    461					;
    462					;		     int_10h();
    463					;
    464	0120  CD 10			     int      10h
    465					;
    466					;		     curpos = getCursorPosition();
    467					;
    468	0122  E8 FF8B			     call    near ptr getCursorPosition
    469	0125  8B F8			     mov     di,ax
    470					;
    471					;		     lin = (curpos >> 8) & 0x00ff;
    472					;
    473	0127  8B C7			     mov     ax,di
    474	0129  B1 08			     mov     cl,8
    475	012B  D3 F8			     sar     ax,cl
    476	012D  25 00FF			     and     ax,255
    477	0130  8B F0			     mov     si,ax
    478					;
    479					;		     col = curpos & 0x00ff;
    480					;
    481	0132  8B C7			     mov     ax,di
    482	0134  25 00FF			     and     ax,255
    483	0137  89 46 FE			     mov     word ptr [bp-2],ax
    484					;
    485					;		     ++col;
    486					;
    487	013A  FF 46 FE			     inc     word ptr [bp-2]
    488					;
    489					;		     if	     (col==miniSO_col)	{
    490					;
    491	013D  A0 0000r			     mov     al,byte ptr DGROUP:miniSO_col
    492	0140  98			     cbw
    493	0141  3B 46 FE			     cmp     ax,word ptr [bp-2]
    494	0144  75 10			     jne     short @5@338
    495					;
    496					;			     col = 0;
    497					;
    498	0146  C7 46 FE 0000		     mov     word ptr [bp-2],0
    499					;
    500					;			     if	     (lin<24)
    501					;
    502	014B  83 FE 18			     cmp     si,24
    503	014E  7D 03			     jge     short @5@310
    504					;
    505					;				     ++lin;
    506					;
    507	0150  46			     inc     si
    508	0151  EB 03			     jmp     short @5@338
    509	0153			     @5@310:
    510					;
    511					;			     else
    512					;				     scroll();
    513					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 10
scall.ASM



    514	0153  E8 FF6B			     call    near ptr scroll
    515	0156			     @5@338:
    516					;
    517					;		     }
    518					;	     }
    519					;	     curpos = (lin << 8)|col;
    520					;
    521	0156  8B C6			     mov     ax,si
    522	0158  B1 08			     mov     cl,8
    523	015A  D3 E0			     shl     ax,cl
    524	015C  0B 46 FE			     or	     ax,word ptr [bp-2]
    525	015F  8B F8			     mov     di,ax
    526					;
    527					;	     setCursorPosition(curpos);
    528					;
    529	0161  57			     push    di
    530	0162  E8 FF3B			     call    near ptr setCursorPosition
    531	0165  59			     pop     cx
    532					;
    533					;	     return 0;
    534					;
    535	0166  33 C0			     xor     ax,ax
    536	0168  EB 00			     jmp     short @5@366
    537	016A			     @5@366:
    538					;
    539					;    }
    540					;
    541	016A  5F			     pop     di
    542	016B  5E			     pop     si
    543	016C  8B E5			     mov     sp,bp
    544	016E  5D			     pop     bp
    545	016F  C3			     ret
    546	0170			     _sc_putch	     endp
    547					;
    548					;    int sc_getch()
    549					;
    550					     assume  cs:_TEXT
    551	0170			     _sc_getch	     proc    near
    552	0170  55			     push    bp
    553	0171  8B EC			     mov     bp,sp
    554	0173  83 EC 02			     sub     sp,2
    555					;
    556					;    {
    557					;      int ax,al,ah;
    558					;
    559					;      if (miniSO_iskey!=0)  {
    560					;
    561	0176  80 3E 0003r 00		     cmp     byte ptr DGROUP:miniSO_iskey,0
    562	017B  74 0B			     je	     short @6@114
    563					;
    564					;	  miniSO_iskey = 0;
    565					;
    566	017D  C6 06 0003r 00		     mov     byte ptr DGROUP:miniSO_iskey,0
    567					;
    568					;	  return miniSO_key;
    569					;
    570	0182  A0 0004r			     mov     al,byte ptr DGROUP:miniSO_key
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 11
scall.ASM



    571	0185  98			     cbw
    572	0186			     @6@86:
    573	0186  EB 34			     jmp     short @6@282
    574	0188			     @6@114:
    575					;
    576					;      }
    577					;
    578					;      mov_ah(0x10);
    579					;
    580	0188  B4 10			     mov     ah,16
    581					;
    582					;      int_16h();
    583					;
    584	018A  CD 16			     int      16h
    585					;
    586					;
    587					;      ax = get_ax();
    588					;
    589	018C  8B D8			     mov     bx,ax
    590					;
    591					;      ah = (ax	>> 8) &	0x00ff;
    592					;
    593	018E  8B C3			     mov     ax,bx
    594	0190  B1 08			     mov     cl,8
    595	0192  D3 F8			     sar     ax,cl
    596	0194  25 00FF			     and     ax,255
    597	0197  89 46 FE			     mov     word ptr [bp-2],ax
    598					;
    599					;      al = 0x00ff & ax;
    600					;
    601	019A  B8 00FF			     mov     ax,255
    602	019D  23 C3			     and     ax,bx
    603	019F  8B D0			     mov     dx,ax
    604					;
    605					;
    606					;      if (al==0xe0 || al==0x00)  {
    607					;
    608	01A1  81 FA 00E0		     cmp     dx,224
    609	01A5  74 04			     je	     short @6@226
    610	01A7  0B D2			     or	     dx,dx
    611	01A9  75 0D			     jne     short @6@254
    612	01AB			     @6@226:
    613					;
    614					;	  miniSO_iskey = 1;
    615					;
    616	01AB  C6 06 0003r 01		     mov     byte ptr DGROUP:miniSO_iskey,1
    617					;
    618					;	  miniSO_key = ah;
    619					;
    620	01B0  8A 46 FE			     mov     al,byte ptr [bp-2]
    621	01B3  A2 0004r			     mov     byte ptr DGROUP:miniSO_key,al
    622					;
    623					;	  al = 0;
    624					;
    625	01B6  33 D2			     xor     dx,dx
    626	01B8			     @6@254:
    627					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 12
scall.ASM



    628					;      }
    629					;      return al;
    630					;
    631	01B8  8B C2			     mov     ax,dx
    632	01BA  EB CA			     jmp     short @6@86
    633	01BC			     @6@282:
    634					;
    635					;    }
    636					;
    637	01BC  8B E5			     mov     sp,bp
    638	01BE  5D			     pop     bp
    639	01BF  C3			     ret
    640	01C0			     _sc_getch	     endp
    641					;
    642					;    int sc_clrscr()
    643					;
    644					     assume  cs:_TEXT
    645	01C0			     _sc_clrscr	     proc    near
    646	01C0  55			     push    bp
    647	01C1  8B EC			     mov     bp,sp
    648					;
    649					;    {
    650					;      mov_al(0);
    651					;
    652	01C3  B0 00			     mov     al,0
    653					;
    654					;      mov_cx(0);
    655					;
    656	01C5  33 C9			     xor     cx,cx
    657					;
    658					;      mov_dh(24);
    659					;
    660	01C7  B6 18			     mov     dh,24
    661					;
    662					;      mov_dl(miniSO_col);
    663					;
    664	01C9  8A 16 0000r		     mov     dl,byte ptr DGROUP:miniSO_col
    665					;
    666					;      dec_dl();
    667					;
    668	01CD  FE CA			     dec      dl
    669					;
    670					;      mov_ah(6);
    671					;
    672	01CF  B4 06			     mov     ah,6
    673					;
    674					;      mov_bh(7);
    675					;
    676	01D1  B7 07			     mov     bh,7
    677					;
    678					;      int_10h();
    679					;
    680	01D3  CD 10			     int      10h
    681					;
    682					;      setCursorPosition(0);
    683					;
    684	01D5  33 C0			     xor     ax,ax
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 13
scall.ASM



    685	01D7  50			     push    ax
    686	01D8  E8 FEC5			     call    near ptr setCursorPosition
    687	01DB  59			     pop     cx
    688					;
    689					;      return 0;
    690					;
    691	01DC  33 C0			     xor     ax,ax
    692	01DE  EB 00			     jmp     short @7@170
    693	01E0			     @7@170:
    694					;
    695					;    }
    696					;
    697	01E0  5D			     pop     bp
    698	01E1  C3			     ret
    699	01E2			     _sc_clrscr	     endp
    700					;
    701					;    int sc_getcolor()
    702					;
    703					     assume  cs:_TEXT
    704	01E2			     _sc_getcolor    proc    near
    705	01E2  55			     push    bp
    706	01E3  8B EC			     mov     bp,sp
    707					;
    708					;    {
    709					;      return miniSO_cor;
    710					;
    711	01E5  A0 0001r			     mov     al,byte ptr DGROUP:miniSO_cor
    712	01E8  98			     cbw
    713	01E9  EB 00			     jmp     short @8@58
    714	01EB			     @8@58:
    715					;
    716					;    }
    717					;
    718	01EB  5D			     pop     bp
    719	01EC  C3			     ret
    720	01ED			     _sc_getcolor    endp
    721					;
    722					;    int sc_setcolor(int cor)
    723					;
    724					     assume  cs:_TEXT
    725	01ED			     _sc_setcolor    proc    near
    726	01ED  55			     push    bp
    727	01EE  8B EC			     mov     bp,sp
    728					;
    729					;    {
    730					;      miniSO_cor = cor;
    731					;
    732	01F0  8A 46 04			     mov     al,byte ptr [bp+4]
    733	01F3  A2 0001r			     mov     byte ptr DGROUP:miniSO_cor,al
    734					;
    735					;      return 0;
    736					;
    737	01F6  33 C0			     xor     ax,ax
    738	01F8  EB 00			     jmp     short @9@58
    739	01FA			     @9@58:
    740					;
    741					;    }
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 14
scall.ASM



    742					;
    743	01FA  5D			     pop     bp
    744	01FB  C3			     ret
    745	01FC			     _sc_setcolor    endp
    746					;
    747					;    int sc_wherex()
    748					;
    749					     assume  cs:_TEXT
    750	01FC			     _sc_wherex	     proc    near
    751	01FC  55			     push    bp
    752	01FD  8B EC			     mov     bp,sp
    753					;
    754					;    {
    755					;      return getCursorPosition() & 0x00ff;
    756					;
    757	01FF  E8 FEAE			     call    near ptr getCursorPosition
    758	0202  25 00FF			     and     ax,255
    759	0205  EB 00			     jmp     short @10@58
    760	0207			     @10@58:
    761					;
    762					;    }
    763					;
    764	0207  5D			     pop     bp
    765	0208  C3			     ret
    766	0209			     _sc_wherex	     endp
    767					;
    768					;    int sc_wherey()
    769					;
    770					     assume  cs:_TEXT
    771	0209			     _sc_wherey	     proc    near
    772	0209  55			     push    bp
    773	020A  8B EC			     mov     bp,sp
    774					;
    775					;    {
    776					;      return (getCursorPosition()>>8) & 0x00ff;
    777					;
    778	020C  E8 FEA1			     call    near ptr getCursorPosition
    779	020F  B1 08			     mov     cl,8
    780	0211  D3 F8			     sar     ax,cl
    781	0213  25 00FF			     and     ax,255
    782	0216  EB 00			     jmp     short @11@58
    783	0218			     @11@58:
    784					;
    785					;    }
    786					;
    787	0218  5D			     pop     bp
    788	0219  C3			     ret
    789	021A			     _sc_wherey	     endp
    790					;
    791					;    int sc_gotoxy(int x, int y)
    792					;
    793					     assume  cs:_TEXT
    794	021A			     _sc_gotoxy	     proc    near
    795	021A  55			     push    bp
    796	021B  8B EC			     mov     bp,sp
    797	021D  56			     push    si
    798	021E  57			     push    di
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 15
scall.ASM



    799	021F  8B 76 04			     mov     si,word ptr [bp+4]
    800	0222  8B 7E 06			     mov     di,word ptr [bp+6]
    801					;
    802					;    {
    803					;      x = x & 0x00ff;
    804					;
    805	0225  8B C6			     mov     ax,si
    806	0227  25 00FF			     and     ax,255
    807	022A  8B F0			     mov     si,ax
    808					;
    809					;      y = (y<<8) & 0xff00;
    810					;
    811	022C  8B C7			     mov     ax,di
    812	022E  B1 08			     mov     cl,8
    813	0230  D3 E0			     shl     ax,cl
    814	0232  25 FF00			     and     ax,-256
    815	0235  8B F8			     mov     di,ax
    816					;
    817					;      setCursorPosition(x|y);
    818					;
    819	0237  8B C6			     mov     ax,si
    820	0239  0B C7			     or	     ax,di
    821	023B  50			     push    ax
    822	023C  E8 FE61			     call    near ptr setCursorPosition
    823	023F  59			     pop     cx
    824					;
    825					;      return 0;
    826					;
    827	0240  33 C0			     xor     ax,ax
    828	0242  EB 00			     jmp     short @12@58
    829	0244			     @12@58:
    830					;
    831					;    }
    832					;
    833	0244  5F			     pop     di
    834	0245  5E			     pop     si
    835	0246  5D			     pop     bp
    836	0247  C3			     ret
    837	0248			     _sc_gotoxy	     endp
    838					;
    839					;    int sc_getdate(unsigned seg, unsigned off)
    840					;
    841					     assume  cs:_TEXT
    842	0248			     _sc_getdate     proc    near
    843	0248  55			     push    bp
    844	0249  8B EC			     mov     bp,sp
    845	024B  83 EC 08			     sub     sp,8
    846	024E  56			     push    si
    847					;
    848					;    {
    849					;      struct date far *dt;
    850					;      unsigned	d,m,a;
    851					;
    852					;      dt = MK_FP(seg,off);
    853					;
    854	024F  FF 76 06			     push    word ptr [bp+6]
    855	0252  FF 76 04			     push    word ptr [bp+4]
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 16
scall.ASM



    856	0255  E8 0000e			     call    near ptr _MK_FP
    857	0258  59			     pop     cx
    858	0259  59			     pop     cx
    859	025A  89 56 FE			     mov     word ptr [bp-2],dx
    860	025D  89 46 FC			     mov     word ptr [bp-4],ax
    861					;
    862					;      mov_ah(4);
    863					;
    864	0260  B4 04			     mov     ah,4
    865					;
    866					;      int_1ah();
    867					;
    868	0262  CD 1A			     int      1ah
    869					;
    870					;      d=get_dl();
    871					;
    872	0264  8A C2			     mov     al,dl
    873	0266  B4 00			     mov     ah,0
    874	0268  89 46 FA			     mov     word ptr [bp-6],ax
    875					;
    876					;      m=get_dh();
    877					;
    878	026B  8A C6			     mov     al,dh
    879	026D  B4 00			     mov     ah,0
    880	026F  89 46 F8			     mov     word ptr [bp-8],ax
    881					;
    882					;      a=get_cx();
    883					;
    884	0272  8B F1			     mov     si,cx
    885					;
    886					;      dt->da_day  = 10*((d & 0xf0)>>4)	+ (d & 0x0f);
    887					;
    888	0274  8B 46 FA			     mov     ax,word ptr [bp-6]
    889	0277  25 00F0			     and     ax,240
    890	027A  B1 04			     mov     cl,4
    891	027C  D3 E8			     shr     ax,cl
    892	027E  BA 000A			     mov     dx,10
    893	0281  F7 EA			     imul    dx
    894	0283  8A 56 FA			     mov     dl,byte ptr [bp-6]
    895	0286  80 E2 0F			     and     dl,15
    896	0289  02 C2			     add     al,dl
    897	028B  C4 5E FC			     les     bx,dword ptr [bp-4]
    898	028E  26: 88 47	02		     mov     byte ptr es:[bx+2],al
    899					;
    900					;      dt->da_mon  = 10*((m & 0xf0)>>4)	+ (m & 0x0f);
    901					;
    902	0292  8B 46 F8			     mov     ax,word ptr [bp-8]
    903	0295  25 00F0			     and     ax,240
    904	0298  B1 04			     mov     cl,4
    905	029A  D3 E8			     shr     ax,cl
    906	029C  BA 000A			     mov     dx,10
    907	029F  F7 EA			     imul    dx
    908	02A1  8A 56 F8			     mov     dl,byte ptr [bp-8]
    909	02A4  80 E2 0F			     and     dl,15
    910	02A7  02 C2			     add     al,dl
    911	02A9  C4 5E FC			     les     bx,dword ptr [bp-4]
    912	02AC  26: 88 47	03		     mov     byte ptr es:[bx+3],al
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 17
scall.ASM



    913					;
    914					;      dt->da_year = 1000*((a &	0xf000)>>12) + 100*((a & 0x0f00)>>8) + 10*((a &	0x00f0)>>4) +
    915				     + (a & 0x000f);
    916					;
    917	02B0  8B C6			     mov     ax,si
    918	02B2  25 F000			     and     ax,-4096
    919	02B5  B1 0C			     mov     cl,12
    920	02B7  D3 E8			     shr     ax,cl
    921	02B9  BA 03E8			     mov     dx,1000
    922	02BC  F7 EA			     imul    dx
    923	02BE  50			     push    ax
    924	02BF  8B C6			     mov     ax,si
    925	02C1  25 0F00			     and     ax,3840
    926	02C4  B1 08			     mov     cl,8
    927	02C6  D3 E8			     shr     ax,cl
    928	02C8  BA 0064			     mov     dx,100
    929	02CB  F7 EA			     imul    dx
    930	02CD  5A			     pop     dx
    931	02CE  03 D0			     add     dx,ax
    932	02D0  8B C6			     mov     ax,si
    933	02D2  25 00F0			     and     ax,240
    934	02D5  B1 04			     mov     cl,4
    935	02D7  D3 E8			     shr     ax,cl
    936	02D9  BB 000A			     mov     bx,10
    937	02DC  52			     push    dx
    938	02DD  F7 EB			     imul    bx
    939	02DF  5A			     pop     dx
    940	02E0  03 D0			     add     dx,ax
    941	02E2  8B C6			     mov     ax,si
    942	02E4  25 000F			     and     ax,15
    943	02E7  03 D0			     add     dx,ax
    944	02E9  C4 5E FC			     les     bx,dword ptr [bp-4]
    945	02EC  26: 89 17			     mov     word ptr es:[bx],dx
    946					;
    947					;      return 0;
    948					;
    949	02EF  33 C0			     xor     ax,ax
    950	02F1  EB 00			     jmp     short @13@114
    951	02F3			     @13@114:
    952					;
    953					;    }
    954					;
    955	02F3  5E			     pop     si
    956	02F4  8B E5			     mov     sp,bp
    957	02F6  5D			     pop     bp
    958	02F7  C3			     ret
    959	02F8			     _sc_getdate     endp
    960					;
    961					;    int sc_gettime(unsigned seg,unsigned off)
    962					;
    963					     assume  cs:_TEXT
    964	02F8			     _sc_gettime     proc    near
    965	02F8  55			     push    bp
    966	02F9  8B EC			     mov     bp,sp
    967	02FB  83 EC 0A			     sub     sp,10
    968					;
    969					;    {
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 18
scall.ASM



    970					;      struct time far *tm;
    971					;      unsigned	h,m,s;
    972					;
    973					;      tm = MK_FP(seg,off);
    974					;
    975	02FE  FF 76 06			     push    word ptr [bp+6]
    976	0301  FF 76 04			     push    word ptr [bp+4]
    977	0304  E8 0000e			     call    near ptr _MK_FP
    978	0307  59			     pop     cx
    979	0308  59			     pop     cx
    980	0309  89 56 FE			     mov     word ptr [bp-2],dx
    981	030C  89 46 FC			     mov     word ptr [bp-4],ax
    982					;
    983					;      mov_ah(2);
    984					;
    985	030F  B4 02			     mov     ah,2
    986					;
    987					;      int_1ah();
    988					;
    989	0311  CD 1A			     int      1ah
    990					;
    991					;      h=get_ch();
    992					;
    993	0313  8A C5			     mov     al,ch
    994	0315  B4 00			     mov     ah,0
    995	0317  89 46 FA			     mov     word ptr [bp-6],ax
    996					;
    997					;      m=get_cl();
    998					;
    999	031A  8A C1			     mov     al,cl
   1000	031C  B4 00			     mov     ah,0
   1001	031E  89 46 F8			     mov     word ptr [bp-8],ax
   1002					;
   1003					;      s=get_dh();
   1004					;
   1005	0321  8A C6			     mov     al,dh
   1006	0323  B4 00			     mov     ah,0
   1007	0325  89 46 F6			     mov     word ptr [bp-10],ax
   1008					;
   1009					;      tm->ti_hour = 10*((h & 0xf0)>>4)	+ (h & 0x0f);
   1010					;
   1011	0328  8B 46 FA			     mov     ax,word ptr [bp-6]
   1012	032B  25 00F0			     and     ax,240
   1013	032E  B1 04			     mov     cl,4
   1014	0330  D3 E8			     shr     ax,cl
   1015	0332  BA 000A			     mov     dx,10
   1016	0335  F7 EA			     imul    dx
   1017	0337  8A 56 FA			     mov     dl,byte ptr [bp-6]
   1018	033A  80 E2 0F			     and     dl,15
   1019	033D  02 C2			     add     al,dl
   1020	033F  C4 5E FC			     les     bx,dword ptr [bp-4]
   1021	0342  26: 88 47	01		     mov     byte ptr es:[bx+1],al
   1022					;
   1023					;      tm->ti_min  = 10*((m & 0xf0)>>4)	+ (m & 0x0f);
   1024					;
   1025	0346  8B 46 F8			     mov     ax,word ptr [bp-8]
   1026	0349  25 00F0			     and     ax,240
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 19
scall.ASM



   1027	034C  B1 04			     mov     cl,4
   1028	034E  D3 E8			     shr     ax,cl
   1029	0350  BA 000A			     mov     dx,10
   1030	0353  F7 EA			     imul    dx
   1031	0355  8A 56 F8			     mov     dl,byte ptr [bp-8]
   1032	0358  80 E2 0F			     and     dl,15
   1033	035B  02 C2			     add     al,dl
   1034	035D  C4 5E FC			     les     bx,dword ptr [bp-4]
   1035	0360  26: 88 07			     mov     byte ptr es:[bx],al
   1036					;
   1037					;      tm->ti_sec  = 10*((s & 0xf0)>>4)	+ (s & 0x0f);
   1038					;
   1039	0363  8B 46 F6			     mov     ax,word ptr [bp-10]
   1040	0366  25 00F0			     and     ax,240
   1041	0369  B1 04			     mov     cl,4
   1042	036B  D3 E8			     shr     ax,cl
   1043	036D  BA 000A			     mov     dx,10
   1044	0370  F7 EA			     imul    dx
   1045	0372  8A 56 F6			     mov     dl,byte ptr [bp-10]
   1046	0375  80 E2 0F			     and     dl,15
   1047	0378  02 C2			     add     al,dl
   1048	037A  C4 5E FC			     les     bx,dword ptr [bp-4]
   1049	037D  26: 88 47	03		     mov     byte ptr es:[bx+3],al
   1050					;
   1051					;      tm->ti_hund = 0;
   1052					;
   1053	0381  C4 5E FC			     les     bx,dword ptr [bp-4]
   1054	0384  26: C6 47	02 00		     mov     byte ptr es:[bx+2],0
   1055					;
   1056					;      return 0;
   1057					;
   1058	0389  33 C0			     xor     ax,ax
   1059	038B  EB 00			     jmp     short @14@114
   1060	038D			     @14@114:
   1061					;
   1062					;    }
   1063					;
   1064	038D  8B E5			     mov     sp,bp
   1065	038F  5D			     pop     bp
   1066	0390  C3			     ret
   1067	0391			     _sc_gettime     endp
   1068					;
   1069					;    void miniSO_contextswitch ()
   1070					;
   1071					     assume  cs:_TEXT
   1072	0391			     _miniSO_contextswitch   proc    near
   1073	0391  55			     push    bp
   1074	0392  8B EC			     mov     bp,sp
   1075					;
   1076					;    {
   1077					;      if ( miniSO_nextthread == miniSO_NONE )
   1078					;
   1079	0394  83 3E 0004r FF		     cmp     word ptr DGROUP:_miniSO_nextthread,-1
   1080	0399  75 11			     jne     short @15@86
   1081					;
   1082					;	  miniSO_nextthread=miniSO_thread[miniSO_ready].next;
   1083					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 20
scall.ASM



   1084	039B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1085	039E  BA 001A			     mov     dx,26
   1086	03A1  F7 EA			     imul    dx
   1087	03A3  8B D8			     mov     bx,ax
   1088	03A5  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   1089	03A9  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   1090	03AC			     @15@86:
   1091					;
   1092					;      /* Se houve alteracao de	thread corrente	... */
   1093					;      if (miniSO_nextthread!=miniSO_ready)  {
   1094					;
   1095	03AC  A1 0004r			     mov     ax,word ptr DGROUP:_miniSO_nextthread
   1096	03AF  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   1097	03B3  75 03			     jne     @@1
   1098	03B5  EB 7E 90			     jmp     @15@254
   1099	03B8			     @@1:
   1100					;
   1101					;	  if (miniSO_delcurthread)	    /* Se a thread corrente foi	excluida ... */
   1102					;
   1103	03B8  80 3E 0006r 00		     cmp     byte ptr DGROUP:_miniSO_delcurthread,0
   1104	03BD  74 07			     je	     short @15@170
   1105					;
   1106					;	     miniSO_delcurthread=0;	   /* zera o flag para deletado	e nao captura SS:SP +
   1107				     */
   1108					;
   1109	03BF  C6 06 0006r 00		     mov     byte ptr DGROUP:_miniSO_delcurthread,0
   1110	03C4  EB 3D			     jmp     short @15@226
   1111	03C6			     @15@170:
   1112					;
   1113					;	  else	{
   1114					;	     /*	Salva SS:SP da thread corrente no BCP */
   1115					;	     miniSO_thread[miniSO_ready].ss=_SS;
   1116					;
   1117	03C6  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1118	03C9  BA 001A			     mov     dx,26
   1119	03CC  F7 EA			     imul    dx
   1120	03CE  8B D8			     mov     bx,ax
   1121	03D0  8C 97 000Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+6],ss
   1122					;
   1123					;	     miniSO_thread[miniSO_ready].sp=_SP;
   1124					;
   1125	03D4  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1126	03D7  BA 001A			     mov     dx,26
   1127	03DA  F7 EA			     imul    dx
   1128	03DC  8B D8			     mov     bx,ax
   1129	03DE  89 A7 000Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+8],sp
   1130					;
   1131					;	     if	(miniSO_thread[miniSO_ready].status==RUNNING)
   1132					;
   1133	03E2  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1134	03E5  BA 001A			     mov     dx,26
   1135	03E8  F7 EA			     imul    dx
   1136	03EA  8B D8			     mov     bx,ax
   1137	03EC  83 BF 000Br 01		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],1
   1138	03F1  75 10			     jne     short @15@226
   1139					;
   1140					;		miniSO_thread[miniSO_ready].status=READY;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 21
scall.ASM



   1141					;
   1142	03F3  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1143	03F6  BA 001A			     mov     dx,26
   1144	03F9  F7 EA			     imul    dx
   1145	03FB  8B D8			     mov     bx,ax
   1146	03FD  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   1147	0403			     @15@226:
   1148					;
   1149					;	  }
   1150					;	  /* Atualiza thread corrente */
   1151					;	  miniSO_ready=miniSO_nextthread;
   1152					;
   1153	0403  A1 0004r			     mov     ax,word ptr DGROUP:_miniSO_nextthread
   1154	0406  A3 0007r			     mov     word ptr DGROUP:_miniSO_ready,ax
   1155					;
   1156					;	  miniSO_thread[miniSO_ready].status=RUNNING;
   1157					;
   1158	0409  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1159	040C  BA 001A			     mov     dx,26
   1160	040F  F7 EA			     imul    dx
   1161	0411  8B D8			     mov     bx,ax
   1162	0413  C7 87 000Br 0001		     mov     word ptr DGROUP:_miniSO_thread[bx+4],1
   1163					;
   1164					;	  /* Define SS:SP para a thread	corrente */
   1165					;	  _SS=miniSO_thread[miniSO_ready].ss;
   1166					;
   1167	0419  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1168	041C  BA 001A			     mov     dx,26
   1169	041F  F7 EA			     imul    dx
   1170	0421  8B D8			     mov     bx,ax
   1171	0423  8E 97 000Dr		     mov     ss,word ptr DGROUP:_miniSO_thread[bx+6]
   1172					;
   1173					;	  _SP=miniSO_thread[miniSO_ready].sp;
   1174					;
   1175	0427  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1176	042A  BA 001A			     mov     dx,26
   1177	042D  F7 EA			     imul    dx
   1178	042F  8B D8			     mov     bx,ax
   1179	0431  8B A7 000Fr		     mov     sp,word ptr DGROUP:_miniSO_thread[bx+8]
   1180	0435			     @15@254:
   1181					;
   1182					;
   1183					;      }
   1184					;      miniSO_nextthread = miniSO_NONE;
   1185					;
   1186	0435  C7 06 0004r FFFF		     mov     word ptr DGROUP:_miniSO_nextthread,-1
   1187					;
   1188					;    }
   1189					;
   1190	043B  5D			     pop     bp
   1191	043C  C3			     ret
   1192	043D			     _miniSO_contextswitch   endp
   1193					;
   1194					;    static void end_mso(char *msg)
   1195					;
   1196					     assume  cs:_TEXT
   1197	043D			     end_mso proc    near
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 22
scall.ASM



   1198	043D  55			     push    bp
   1199	043E  8B EC			     mov     bp,sp
   1200					;
   1201					;    {
   1202					;      /* Restaura a interrupção do relógio original */
   1203					;      setvect(miniSO_CLOCKINT,miniSO_oldisr);
   1204					;
   1205	0440  FF 36 0002r		     push    word ptr DGROUP:_miniSO_oldisr+2
   1206	0444  FF 36 0000r		     push    word ptr DGROUP:_miniSO_oldisr
   1207	0448  B8 001C			     mov     ax,28
   1208	044B  50			     push    ax
   1209	044C  E8 0000e			     call    near ptr _setvect
   1210	044F  83 C4 06			     add     sp,6
   1211					;
   1212					;      enable();
   1213					;
   1214	0452  E8 0000e			     call    near ptr _enable
   1215					;
   1216					;      putstr("\n\n");
   1217					;
   1218	0455  1E			     push    ds
   1219	0456  B8 008Ar			     mov     ax,offset DGROUP:s@
   1220	0459  50			     push    ax
   1221	045A  E8 0000e			     call    near ptr _putstr
   1222	045D  59			     pop     cx
   1223	045E  59			     pop     cx
   1224					;
   1225					;      putstr(msg);
   1226					;
   1227	045F  1E			     push    ds
   1228	0460  FF 76 04			     push    word ptr [bp+4]
   1229	0463  E8 0000e			     call    near ptr _putstr
   1230	0466  59			     pop     cx
   1231	0467  59			     pop     cx
   1232					;
   1233					;      putch('\n');
   1234					;
   1235	0468  B8 000A			     mov     ax,10
   1236	046B  50			     push    ax
   1237	046C  E8 0000e			     call    near ptr _putch
   1238	046F  59			     pop     cx
   1239					;
   1240					;      putstr("Pressione uma tecla para	reiniciar...\n");
   1241					;
   1242	0470  1E			     push    ds
   1243	0471  B8 008Dr			     mov     ax,offset DGROUP:s@+3
   1244	0474  50			     push    ax
   1245	0475  E8 0000e			     call    near ptr _putstr
   1246	0478  59			     pop     cx
   1247	0479  59			     pop     cx
   1248					;
   1249					;      getch();
   1250					;
   1251	047A  E8 0000e			     call    near ptr _getch
   1252					;
   1253					;      /* Reinicializa a máquina */
   1254					;      sc_reboot();
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 23
scall.ASM



   1255					;
   1256	047D  E8 0138			     call    near ptr _sc_reboot
   1257					;
   1258					;    }
   1259					;
   1260	0480  5D			     pop     bp
   1261	0481  C3			     ret
   1262	0482			     end_mso endp
   1263					;
   1264					;    static pcb_t get_pcb(pid_t	pid)
   1265					;
   1266					     assume  cs:_TEXT
   1267	0482			     get_pcb proc    near
   1268	0482  55			     push    bp
   1269	0483  8B EC			     mov     bp,sp
   1270					;
   1271					;    {
   1272					;	     pcb_t   pcb;
   1273					;
   1274					;	     for     (pcb=0;pcb<miniSO_MAXTHREADS;++pcb)  {
   1275					;
   1276	0485  33 C9			     xor     cx,cx
   1277	0487  EB 27			     jmp     short @17@198
   1278	0489			     @17@58:
   1279					;
   1280					;		     if	     ( miniSO_thread[pcb].status!=FREE && miniSO_thread		    +
   1281				     [pcb].pid==pid )
   1282					;
   1283	0489  8B C1			     mov     ax,cx
   1284	048B  BA 001A			     mov     dx,26
   1285	048E  F7 EA			     imul    dx
   1286	0490  8B D8			     mov     bx,ax
   1287	0492  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   1288	0497  74 16			     je	     short @17@170
   1289	0499  8B C1			     mov     ax,cx
   1290	049B  BA 001A			     mov     dx,26
   1291	049E  F7 EA			     imul    dx
   1292	04A0  8B D8			     mov     bx,ax
   1293	04A2  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   1294	04A6  3B 46 04			     cmp     ax,word ptr [bp+4]
   1295	04A9  75 04			     jne     short @17@170
   1296					;
   1297					;			     return pcb;
   1298					;
   1299	04AB  8B C1			     mov     ax,cx
   1300	04AD			     @17@142:
   1301	04AD  EB 0B			     jmp     short @17@254
   1302	04AF			     @17@170:
   1303	04AF  41			     inc     cx
   1304	04B0			     @17@198:
   1305	04B0  83 F9 10			     cmp     cx,16
   1306	04B3  7C D4			     jl	     short @17@58
   1307					;
   1308					;	     }
   1309					;	     return -1;
   1310					;
   1311	04B5  B8 FFFF			     mov     ax,-1
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 24
scall.ASM



   1312	04B8  EB F3			     jmp     short @17@142
   1313	04BA			     @17@254:
   1314					;
   1315					;    }
   1316					;
   1317	04BA  5D			     pop     bp
   1318	04BB  C3			     ret
   1319	04BC			     get_pcb endp
   1320					;
   1321					;    void miniSO_init_semtable()
   1322					;
   1323					     assume  cs:_TEXT
   1324	04BC			     _miniSO_init_semtable   proc    near
   1325	04BC  55			     push    bp
   1326	04BD  8B EC			     mov     bp,sp
   1327					;
   1328					;    {
   1329					;	     int i;
   1330					;
   1331					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   1332					;
   1333	04BF  33 C0			     xor     ax,ax
   1334	04C1  EB 0D			     jmp     short @18@114
   1335	04C3			     @18@58:
   1336					;
   1337					;		     miniSO_sem[i].status = FREE;
   1338					;
   1339	04C3  8B D8			     mov     bx,ax
   1340	04C5  B1 03			     mov     cl,3
   1341	04C7  D3 E3			     shl     bx,cl
   1342	04C9  C7 87 01A7r FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx],-1
   1343	04CF  40			     inc     ax
   1344	04D0			     @18@114:
   1345	04D0  3D 000A			     cmp     ax,10
   1346	04D3  7C EE			     jl	     short @18@58
   1347					;
   1348					;    }
   1349					;
   1350	04D5  5D			     pop     bp
   1351	04D6  C3			     ret
   1352	04D7			     _miniSO_init_semtable   endp
   1353					;
   1354					;    void miniSO_init_proctable()
   1355					;
   1356					     assume  cs:_TEXT
   1357	04D7			     _miniSO_init_proctable  proc    near
   1358	04D7  55			     push    bp
   1359	04D8  8B EC			     mov     bp,sp
   1360	04DA  56			     push    si
   1361					;
   1362					;    {
   1363					;      pcb_t i;
   1364					;
   1365					;      disable();
   1366					;
   1367	04DB  E8 0000e			     call    near ptr _disable
   1368					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 25
scall.ASM



   1369					;
   1370					;      /* Inicializa a tabela de semaforos */
   1371					;      miniSO_init_semtable();
   1372					;
   1373	04DE  E8 FFDB			     call    near ptr _miniSO_init_semtable
   1374					;
   1375					;      /* Inicializa tabela de threads */
   1376					;      miniSO_ready =  0;
   1377					;
   1378	04E1  C7 06 0007r 0000		     mov     word ptr DGROUP:_miniSO_ready,0
   1379					;
   1380					;      miniSO_thread[miniSO_ready].pid	    = 0;
   1381					;
   1382	04E7  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1383	04EA  BA 001A			     mov     dx,26
   1384	04ED  F7 EA			     imul    dx
   1385	04EF  8B D8			     mov     bx,ax
   1386	04F1  C7 87 0007r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx],0
   1387					;
   1388					;      miniSO_thread[miniSO_ready].ppid	    = -1;
   1389					;
   1390	04F7  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1391	04FA  BA 001A			     mov     dx,26
   1392	04FD  F7 EA			     imul    dx
   1393	04FF  8B D8			     mov     bx,ax
   1394	0501  C7 87 0009r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+2],-1
   1395					;
   1396					;      miniSO_thread[miniSO_ready].next	    = miniSO_ready;
   1397					;
   1398	0507  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1399	050A  BA 001A			     mov     dx,26
   1400	050D  F7 EA			     imul    dx
   1401	050F  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1402	0513  8B D8			     mov     bx,ax
   1403	0515  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1404					;
   1405					;      miniSO_thread[miniSO_ready].prev	    = miniSO_ready;
   1406					;
   1407	0519  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1408	051C  BA 001A			     mov     dx,26
   1409	051F  F7 EA			     imul    dx
   1410	0521  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1411	0525  8B D8			     mov     bx,ax
   1412	0527  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   1413					;
   1414					;      miniSO_thread[miniSO_ready].status   = RUNNING;
   1415					;
   1416	052B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1417	052E  BA 001A			     mov     dx,26
   1418	0531  F7 EA			     imul    dx
   1419	0533  8B D8			     mov     bx,ax
   1420	0535  C7 87 000Br 0001		     mov     word ptr DGROUP:_miniSO_thread[bx+4],1
   1421					;
   1422					;      miniSO_thread[miniSO_ready].recvsig  = 0;
   1423					;
   1424	053B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1425	053E  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 26
scall.ASM



   1426	0541  F7 EA			     imul    dx
   1427	0543  8B D8			     mov     bx,ax
   1428	0545  C7 87 0011r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+10],0
   1429					;
   1430					;      miniSO_thread[miniSO_ready].wait	    = -1;
   1431					;
   1432	054B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1433	054E  BA 001A			     mov     dx,26
   1434	0551  F7 EA			     imul    dx
   1435	0553  8B D8			     mov     bx,ax
   1436	0555  C7 87 0015r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+14],-1
   1437					;
   1438					;      miniSO_thread[miniSO_ready].zombies  = -1;
   1439					;
   1440	055B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1441	055E  BA 001A			     mov     dx,26
   1442	0561  F7 EA			     imul    dx
   1443	0563  8B D8			     mov     bx,ax
   1444	0565  C7 87 001Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+20],-1
   1445					;
   1446					;      /* O resto dos BCPs permanece na	lista de livres	*/
   1447					;      miniSO_free  =  1;
   1448					;
   1449	056B  C7 06 0009r 0001		     mov     word ptr DGROUP:_miniSO_free,1
   1450					;
   1451					;      for ( i=1 ; i<miniSO_MAXTHREADS-1 ; ++i)	 {
   1452					;
   1453	0571  BE 0001			     mov     si,1
   1454	0574  EB 20			     jmp     short @19@114
   1455	0576			     @19@58:
   1456					;
   1457					;	   miniSO_thread[i].next   = i+1;
   1458					;
   1459	0576  8B C6			     mov     ax,si
   1460	0578  BA 001A			     mov     dx,26
   1461	057B  F7 EA			     imul    dx
   1462	057D  8B D6			     mov     dx,si
   1463	057F  42			     inc     dx
   1464	0580  8B D8			     mov     bx,ax
   1465	0582  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1466					;
   1467					;	   miniSO_thread[i].status = FREE;
   1468					;
   1469	0586  8B C6			     mov     ax,si
   1470	0588  BA 001A			     mov     dx,26
   1471	058B  F7 EA			     imul    dx
   1472	058D  8B D8			     mov     bx,ax
   1473	058F  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   1474	0595  46			     inc     si
   1475	0596			     @19@114:
   1476	0596  83 FE 0F			     cmp     si,15
   1477	0599  7C DB			     jl	     short @19@58
   1478					;
   1479					;      }
   1480					;      miniSO_thread[miniSO_MAXTHREADS-1].next	 = -1;
   1481					;
   1482	059B  C7 06 01A5r FFFF		     mov     word ptr DGROUP:_miniSO_thread+414,-1
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 27
scall.ASM



   1483					;
   1484					;      miniSO_thread[miniSO_MAXTHREADS-1].status = FREE;
   1485					;
   1486	05A1  C7 06 0191r FFFF		     mov     word ptr DGROUP:_miniSO_thread+394,-1
   1487					;
   1488					;      /* Zera tempos do sistema */
   1489					;      miniSO_delcurthread  = 0;
   1490					;
   1491	05A7  C6 06 0006r 00		     mov     byte ptr DGROUP:_miniSO_delcurthread,0
   1492					;
   1493					;      miniSO_nextthread = miniSO_NONE;
   1494					;
   1495	05AC  C7 06 0004r FFFF		     mov     word ptr DGROUP:_miniSO_nextthread,-1
   1496					;
   1497					;      /* Habilita as interrupcoes e retorna */
   1498					;      enable();
   1499					;
   1500	05B2  E8 0000e			     call    near ptr _enable
   1501					;
   1502					;    }
   1503					;
   1504	05B5  5E			     pop     si
   1505	05B6  5D			     pop     bp
   1506	05B7  C3			     ret
   1507	05B8			     _miniSO_init_proctable  endp
   1508					;
   1509					;    int sc_reboot()
   1510					;
   1511					     assume  cs:_TEXT
   1512	05B8			     _sc_reboot	     proc    near
   1513	05B8  55			     push    bp
   1514	05B9  8B EC			     mov     bp,sp
   1515					;
   1516					;    {
   1517					;	     /*	Restaura a interrupção do relógio original */
   1518					;	     setvect(miniSO_CLOCKINT,miniSO_oldisr);
   1519					;
   1520	05BB  FF 36 0002r		     push    word ptr DGROUP:_miniSO_oldisr+2
   1521	05BF  FF 36 0000r		     push    word ptr DGROUP:_miniSO_oldisr
   1522	05C3  B8 001C			     mov     ax,28
   1523	05C6  50			     push    ax
   1524	05C7  E8 0000e			     call    near ptr _setvect
   1525	05CA  83 C4 06			     add     sp,6
   1526					;
   1527					;	     enable();
   1528					;
   1529	05CD  E8 0000e			     call    near ptr _enable
   1530					;
   1531					;	     asm     {
   1532					;		     int     19h
   1533					;
   1534	05D0  CD 19			     int	     19h
   1535					;
   1536					;	     }
   1537					;	     return 0;
   1538					;
   1539	05D2  33 C0			     xor     ax,ax
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 28
scall.ASM



   1540	05D4  EB 00			     jmp     short @20@114
   1541	05D6			     @20@114:
   1542					;
   1543					;    }
   1544					;
   1545	05D6  5D			     pop     bp
   1546	05D7  C3			     ret
   1547	05D8			     _sc_reboot	     endp
   1548	05D8			     _TEXT   ends
   1549	0088			     _DATA   segment word public 'DATA'
   1550	0088  01			     db	     1
   1551	0089  00			     db	     0
   1552	008A			     _DATA   ends
   1553	05D8			     _TEXT   segment byte public 'CODE'
   1554					;
   1555					;    int sc_fork(unsigned cs, unsigned ip)
   1556					;
   1557					     assume  cs:_TEXT
   1558	05D8			     _sc_fork	     proc    near
   1559	05D8  55			     push    bp
   1560	05D9  8B EC			     mov     bp,sp
   1561	05DB  83 EC 06			     sub     sp,6
   1562	05DE  56			     push    si
   1563	05DF  57			     push    di
   1564					;
   1565					;    {
   1566					;	     pid_t	     pid;
   1567					;	     pcb_t	     pcb,last;
   1568					;	     unsigned far *  stack;
   1569					;	     static pid_t    nextpid=1;	/* Número do próximo pid */
   1570					;	     extern void     miniSO_return_addr(void);
   1571					;
   1572					;	     /*	Se o nucleo esta' instalado e existem BCPs livres insere no fim	da lista ...+
   1573				     */
   1574					;	     if	     (miniSO_free == -1)
   1575					;
   1576	05E0  83 3E 0009r FF		     cmp     word ptr DGROUP:_miniSO_free,-1
   1577	05E5  75 06			     jne     short @21@114
   1578					;
   1579					;		     return miniSO_ERROR;
   1580					;
   1581	05E7  B8 FFFF			     mov     ax,-1
   1582	05EA			     @21@86:
   1583	05EA  E9 0241			     jmp     @21@338
   1584	05ED			     @21@114:
   1585					;
   1586					;	     disable();
   1587					;
   1588	05ED  E8 0000e			     call    near ptr _disable
   1589					;
   1590					;	     /*	Gera um	pid para a thread */
   1591					;	     pcb = 0;
   1592					;
   1593	05F0  33 F6			     xor     si,si
   1594	05F2  EB 27			     jmp     short @21@282
   1595	05F4			     @21@142:
   1596					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 29
scall.ASM



   1597					;	     while   (pcb!=-1)	{
   1598					;		     pcb = get_pcb (nextpid);
   1599					;
   1600	05F4  FF 36 0088r		     push    word ptr DGROUP:d@w+136
   1601	05F8  E8 FE87			     call    near ptr get_pcb
   1602	05FB  59			     pop     cx
   1603	05FC  8B F0			     mov     si,ax
   1604					;
   1605					;		     if	     (pcb==-1)
   1606					;
   1607	05FE  83 FE FF			     cmp     si,-1
   1608	0601  75 04			     jne     short @21@198
   1609					;
   1610					;			     pid = nextpid;
   1611					;
   1612	0603  8B 3E 0088r		     mov     di,word ptr DGROUP:d@w+136
   1613	0607			     @21@198:
   1614					;
   1615					;		     if	     (nextpid==32767)
   1616					;
   1617	0607  81 3E 0088r 7FFF		     cmp     word ptr DGROUP:d@w+136,32767
   1618	060D  75 08			     jne     short @21@254
   1619					;
   1620					;			     nextpid=1;
   1621					;
   1622	060F  C7 06 0088r 0001		     mov     word ptr DGROUP:d@w+136,1
   1623	0615  EB 04			     jmp     short @21@282
   1624	0617			     @21@254:
   1625					;
   1626					;		     else
   1627					;			     nextpid++;
   1628					;
   1629	0617  FF 06 0088r		     inc     word ptr DGROUP:d@w+136
   1630	061B			     @21@282:
   1631	061B  83 FE FF			     cmp     si,-1
   1632	061E  75 D4			     jne     short @21@142
   1633					;
   1634					;	     }
   1635					;	     /*	Retira um BCP da lista de BCPs livres */
   1636					;	     pcb     = miniSO_free;
   1637					;
   1638	0620  8B 36 0009r		     mov     si,word ptr DGROUP:_miniSO_free
   1639					;
   1640					;	     miniSO_free = miniSO_thread[miniSO_free].next;
   1641					;
   1642	0624  A1 0009r			     mov     ax,word ptr DGROUP:_miniSO_free
   1643	0627  BA 001A			     mov     dx,26
   1644	062A  F7 EA			     imul    dx
   1645	062C  8B D8			     mov     bx,ax
   1646	062E  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   1647	0632  A3 0009r			     mov     word ptr DGROUP:_miniSO_free,ax
   1648					;
   1649					;	     miniSO_thread[pcb].pid = pid;
   1650					;
   1651	0635  8B C6			     mov     ax,si
   1652	0637  BA 001A			     mov     dx,26
   1653	063A  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 30
scall.ASM



   1654	063C  8B D8			     mov     bx,ax
   1655	063E  89 BF 0007r		     mov     word ptr DGROUP:_miniSO_thread[bx],di
   1656					;
   1657					;	     miniSO_thread[pcb].ppid = miniSO_thread[miniSO_ready].pid;
   1658					;
   1659	0642  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1660	0645  BA 001A			     mov     dx,26
   1661	0648  F7 EA			     imul    dx
   1662	064A  8B D8			     mov     bx,ax
   1663	064C  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   1664	0650  50			     push    ax
   1665	0651  8B C6			     mov     ax,si
   1666	0653  BA 001A			     mov     dx,26
   1667	0656  F7 EA			     imul    dx
   1668	0658  8B D8			     mov     bx,ax
   1669	065A  58			     pop     ax
   1670	065B  89 87 0009r		     mov     word ptr DGROUP:_miniSO_thread[bx+2],ax
   1671					;
   1672					;	     /*	Cria pilha da thread */
   1673					;	     stack=(unsigned far *)MK_FP(miniSO_INITSTACKS+(miniSO_STACKSIZE>>4)*	    +
   1674				     (miniSO_MAXTHREADS-1-pcb),miniSO_STACKSIZE);
   1675					;
   1676	065F  B8 0600			     mov     ax,1536
   1677	0662  50			     push    ax
   1678	0663  B8 000F			     mov     ax,15
   1679	0666  2B C6			     sub     ax,si
   1680	0668  BA 0060			     mov     dx,96
   1681	066B  F7 EA			     imul    dx
   1682	066D  05 0D00			     add     ax,3328
   1683	0670  50			     push    ax
   1684	0671  E8 0000e			     call    near ptr _MK_FP
   1685	0674  59			     pop     cx
   1686	0675  59			     pop     cx
   1687	0676  89 56 FC			     mov     word ptr [bp-4],dx
   1688	0679  89 46 FA			     mov     word ptr [bp-6],ax
   1689					;
   1690					;	     /*	Empilha	o endereco da funcao sc_exit, de modo que se	*/
   1691					;	     /*	 a thread sair da funcao sem chamar sc_exit, a thread */
   1692					;	     /*	 seja automaticamente excluida */
   1693					;	     *(--stack)=0; /* Empilha código de	fim a ser enviado para sc_exit */
   1694					;
   1695	067C  83 6E FA 02		     sub     word ptr [bp-6],2
   1696	0680  C4 5E FA			     les     bx,dword ptr [bp-6]
   1697	0683  26: C7 07	0000		     mov     word ptr es:[bx],0
   1698					;
   1699					;	     *(--stack)=miniSO_CODESEGMENT;
   1700					;
   1701	0688  83 6E FA 02		     sub     word ptr [bp-6],2
   1702	068C  C4 5E FA			     les     bx,dword ptr [bp-6]
   1703	068F  26: C7 07	07E0		     mov     word ptr es:[bx],2016
   1704					;
   1705					;	     *(--stack)=(unsigned)sc_exit;
   1706					;
   1707	0694  83 6E FA 02		     sub     word ptr [bp-6],2
   1708	0698  C4 5E FA			     les     bx,dword ptr [bp-6]
   1709	069B  26: C7 07	0E81r		     mov     word ptr es:[bx],offset _sc_exit
   1710					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 31
scall.ASM



   1711					;	     *(--stack)=0x0200 ;       /* FLAGS	*/
   1712					;
   1713	06A0  83 6E FA 02		     sub     word ptr [bp-6],2
   1714	06A4  C4 5E FA			     les     bx,dword ptr [bp-6]
   1715	06A7  26: C7 07	0200		     mov     word ptr es:[bx],512
   1716					;
   1717					;	     *(--stack)=cs;	       /* CS */
   1718					;
   1719	06AC  83 6E FA 02		     sub     word ptr [bp-6],2
   1720	06B0  C4 5E FA			     les     bx,dword ptr [bp-6]
   1721	06B3  8B 46 04			     mov     ax,word ptr [bp+4]
   1722	06B6  26: 89 07			     mov     word ptr es:[bx],ax
   1723					;
   1724					;	     *(--stack)=ip;	       /* IP */
   1725					;
   1726	06B9  83 6E FA 02		     sub     word ptr [bp-6],2
   1727	06BD  C4 5E FA			     les     bx,dword ptr [bp-6]
   1728	06C0  8B 46 06			     mov     ax,word ptr [bp+6]
   1729	06C3  26: 89 07			     mov     word ptr es:[bx],ax
   1730					;
   1731					;	     *(--stack)=0;	       /* AX */
   1732					;
   1733	06C6  83 6E FA 02		     sub     word ptr [bp-6],2
   1734	06CA  C4 5E FA			     les     bx,dword ptr [bp-6]
   1735	06CD  26: C7 07	0000		     mov     word ptr es:[bx],0
   1736					;
   1737					;	     *(--stack)=0;	       /* BX */
   1738					;
   1739	06D2  83 6E FA 02		     sub     word ptr [bp-6],2
   1740	06D6  C4 5E FA			     les     bx,dword ptr [bp-6]
   1741	06D9  26: C7 07	0000		     mov     word ptr es:[bx],0
   1742					;
   1743					;	     *(--stack)=0;	       /* CX */
   1744					;
   1745	06DE  83 6E FA 02		     sub     word ptr [bp-6],2
   1746	06E2  C4 5E FA			     les     bx,dword ptr [bp-6]
   1747	06E5  26: C7 07	0000		     mov     word ptr es:[bx],0
   1748					;
   1749					;	     *(--stack)=0;	       /* DX */
   1750					;
   1751	06EA  83 6E FA 02		     sub     word ptr [bp-6],2
   1752	06EE  C4 5E FA			     les     bx,dword ptr [bp-6]
   1753	06F1  26: C7 07	0000		     mov     word ptr es:[bx],0
   1754					;
   1755					;	     *(--stack)=0;	       /* ES */
   1756					;
   1757	06F6  83 6E FA 02		     sub     word ptr [bp-6],2
   1758	06FA  C4 5E FA			     les     bx,dword ptr [bp-6]
   1759	06FD  26: C7 07	0000		     mov     word ptr es:[bx],0
   1760					;
   1761					;	     *(--stack)=miniSO_DATASEGMENT;/* DS */
   1762					;
   1763	0702  83 6E FA 02		     sub     word ptr [bp-6],2
   1764	0706  C4 5E FA			     les     bx,dword ptr [bp-6]
   1765	0709  26: C7 07	0B3C		     mov     word ptr es:[bx],2876
   1766					;
   1767					;	     *(--stack)=0;	       /* SI */
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 32
scall.ASM



   1768					;
   1769	070E  83 6E FA 02		     sub     word ptr [bp-6],2
   1770	0712  C4 5E FA			     les     bx,dword ptr [bp-6]
   1771	0715  26: C7 07	0000		     mov     word ptr es:[bx],0
   1772					;
   1773					;	     *(--stack)=0;	       /* DI */
   1774					;
   1775	071A  83 6E FA 02		     sub     word ptr [bp-6],2
   1776	071E  C4 5E FA			     les     bx,dword ptr [bp-6]
   1777	0721  26: C7 07	0000		     mov     word ptr es:[bx],0
   1778					;
   1779					;	     *(--stack)=0;	       /* BP */
   1780					;
   1781	0726  83 6E FA 02		     sub     word ptr [bp-6],2
   1782	072A  C4 5E FA			     les     bx,dword ptr [bp-6]
   1783	072D  26: C7 07	0000		     mov     word ptr es:[bx],0
   1784					;
   1785					;	     *(--stack)=(unsigned)miniSO_return_addr;
   1786					;
   1787	0732  83 6E FA 02		     sub     word ptr [bp-6],2
   1788	0736  C4 5E FA			     les     bx,dword ptr [bp-6]
   1789	0739  26: C7 07	0000e		     mov     word ptr es:[bx],offset _miniSO_return_addr
   1790					;
   1791					;	     *(--stack)=0;	       /* BP */
   1792					;
   1793	073E  83 6E FA 02		     sub     word ptr [bp-6],2
   1794	0742  C4 5E FA			     les     bx,dword ptr [bp-6]
   1795	0745  26: C7 07	0000		     mov     word ptr es:[bx],0
   1796					;
   1797					;	     /*	Inicializa campos da nova thread */
   1798					;	     miniSO_thread[pcb].ss	 = FP_SEG(stack);
   1799					;
   1800	074A  FF 76 FC			     push    word ptr [bp-4]
   1801	074D  FF 76 FA			     push    word ptr [bp-6]
   1802	0750  E8 0000e			     call    near ptr _FP_SEG
   1803	0753  59			     pop     cx
   1804	0754  59			     pop     cx
   1805	0755  50			     push    ax
   1806	0756  8B C6			     mov     ax,si
   1807	0758  BA 001A			     mov     dx,26
   1808	075B  F7 EA			     imul    dx
   1809	075D  8B D8			     mov     bx,ax
   1810	075F  58			     pop     ax
   1811	0760  89 87 000Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+6],ax
   1812					;
   1813					;	     miniSO_thread[pcb].sp	 = FP_OFF(stack);
   1814					;
   1815	0764  FF 76 FC			     push    word ptr [bp-4]
   1816	0767  FF 76 FA			     push    word ptr [bp-6]
   1817	076A  E8 0000e			     call    near ptr _FP_OFF
   1818	076D  59			     pop     cx
   1819	076E  59			     pop     cx
   1820	076F  50			     push    ax
   1821	0770  8B C6			     mov     ax,si
   1822	0772  BA 001A			     mov     dx,26
   1823	0775  F7 EA			     imul    dx
   1824	0777  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 33
scall.ASM



   1825	0779  58			     pop     ax
   1826	077A  89 87 000Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+8],ax
   1827					;
   1828					;	     miniSO_thread[pcb].status	 = READY;
   1829					;
   1830	077E  8B C6			     mov     ax,si
   1831	0780  BA 001A			     mov     dx,26
   1832	0783  F7 EA			     imul    dx
   1833	0785  8B D8			     mov     bx,ax
   1834	0787  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   1835					;
   1836					;	     miniSO_thread[pcb].recvsig	 = 0;
   1837					;
   1838	078D  8B C6			     mov     ax,si
   1839	078F  BA 001A			     mov     dx,26
   1840	0792  F7 EA			     imul    dx
   1841	0794  8B D8			     mov     bx,ax
   1842	0796  C7 87 0011r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+10],0
   1843					;
   1844					;	     miniSO_thread[pcb].waitsig	 = 0;
   1845					;
   1846	079C  8B C6			     mov     ax,si
   1847	079E  BA 001A			     mov     dx,26
   1848	07A1  F7 EA			     imul    dx
   1849	07A3  8B D8			     mov     bx,ax
   1850	07A5  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   1851					;
   1852					;	     miniSO_thread[pcb].wait	 = -1;
   1853					;
   1854	07AB  8B C6			     mov     ax,si
   1855	07AD  BA 001A			     mov     dx,26
   1856	07B0  F7 EA			     imul    dx
   1857	07B2  8B D8			     mov     bx,ax
   1858	07B4  C7 87 0015r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+14],-1
   1859					;
   1860					;	     miniSO_thread[pcb].waitfor	 = -1;
   1861					;
   1862	07BA  8B C6			     mov     ax,si
   1863	07BC  BA 001A			     mov     dx,26
   1864	07BF  F7 EA			     imul    dx
   1865	07C1  8B D8			     mov     bx,ax
   1866	07C3  C7 87 0017r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+16],-1
   1867					;
   1868					;	     miniSO_thread[pcb].zombies	 = -1;
   1869					;
   1870	07C9  8B C6			     mov     ax,si
   1871	07CB  BA 001A			     mov     dx,26
   1872	07CE  F7 EA			     imul    dx
   1873	07D0  8B D8			     mov     bx,ax
   1874	07D2  C7 87 001Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+20],-1
   1875					;
   1876					;	     /*	Descobre qual a	ultima thread */
   1877					;	     last = miniSO_thread[miniSO_ready].prev;
   1878					;
   1879	07D8  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1880	07DB  BA 001A			     mov     dx,26
   1881	07DE  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 34
scall.ASM



   1882	07E0  8B D8			     mov     bx,ax
   1883	07E2  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   1884	07E6  89 46 FE			     mov     word ptr [bp-2],ax
   1885					;
   1886					;	     /*	Acerta links para incluir a nova thread	*/
   1887					;	     miniSO_thread[pcb].prev	  = last;
   1888					;
   1889	07E9  8B C6			     mov     ax,si
   1890	07EB  BA 001A			     mov     dx,26
   1891	07EE  F7 EA			     imul    dx
   1892	07F0  8B 56 FE			     mov     dx,word ptr [bp-2]
   1893	07F3  8B D8			     mov     bx,ax
   1894	07F5  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   1895					;
   1896					;	     miniSO_thread[pcb].next	  = miniSO_ready;
   1897					;
   1898	07F9  8B C6			     mov     ax,si
   1899	07FB  BA 001A			     mov     dx,26
   1900	07FE  F7 EA			     imul    dx
   1901	0800  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1902	0804  8B D8			     mov     bx,ax
   1903	0806  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1904					;
   1905					;	     miniSO_thread[last].next	  = pcb;
   1906					;
   1907	080A  8B 46 FE			     mov     ax,word ptr [bp-2]
   1908	080D  BA 001A			     mov     dx,26
   1909	0810  F7 EA			     imul    dx
   1910	0812  8B D8			     mov     bx,ax
   1911	0814  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   1912					;
   1913					;	     miniSO_thread[miniSO_ready].prev =	pcb;
   1914					;
   1915	0818  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1916	081B  BA 001A			     mov     dx,26
   1917	081E  F7 EA			     imul    dx
   1918	0820  8B D8			     mov     bx,ax
   1919	0822  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   1920					;
   1921					;	     enable();
   1922					;
   1923	0826  E8 0000e			     call    near ptr _enable
   1924					;
   1925					;	     return pid;
   1926					;
   1927	0829  8B C7			     mov     ax,di
   1928	082B  E9 FDBC			     jmp     @21@86
   1929	082E			     @21@338:
   1930					;
   1931					;    }
   1932					;
   1933	082E  5F			     pop     di
   1934	082F  5E			     pop     si
   1935	0830  8B E5			     mov     sp,bp
   1936	0832  5D			     pop     bp
   1937	0833  C3			     ret
   1938	0834			     _sc_fork	     endp
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 35
scall.ASM



   1939					;
   1940					;    int sc_kill(pid_t pid)
   1941					;
   1942					     assume  cs:_TEXT
   1943	0834			     _sc_kill	     proc    near
   1944	0834  55			     push    bp
   1945	0835  8B EC			     mov     bp,sp
   1946	0837  83 EC 08			     sub     sp,8
   1947	083A  56			     push    si
   1948	083B  57			     push    di
   1949					;
   1950					;    {
   1951					;	     pcb_t pcb,pcbw,last,prevthread,nextthread,pai,i,ant;
   1952					;
   1953					;	     disable();
   1954					;
   1955	083C  E8 0000e			     call    near ptr _disable
   1956					;
   1957					;	     /*	Se remover a thread 0 ... */
   1958					;	     if	     (pid==0)
   1959					;
   1960	083F  83 7E 04 00		     cmp     word ptr [bp+4],0
   1961	0843  75 08			     jne     short @22@86
   1962					;
   1963					;		     end_mso("kill(): thread 0 excluida!");
   1964					;
   1965	0845  B8 00B4r			     mov     ax,offset DGROUP:s@+42
   1966	0848  50			     push    ax
   1967	0849  E8 FBF1			     call    near ptr end_mso
   1968	084C  59			     pop     cx
   1969	084D			     @22@86:
   1970					;
   1971					;	     /*	Tem que	verificar se existe a thread */
   1972					;	     pcb = get_pcb(pid);
   1973					;
   1974	084D  FF 76 04			     push    word ptr [bp+4]
   1975	0850  E8 FC2F			     call    near ptr get_pcb
   1976	0853  59			     pop     cx
   1977	0854  8B F0			     mov     si,ax
   1978					;
   1979					;	     /*	Se nao existe uma thread com este numero, entao	retorna	*/
   1980					;	     if	     (pcb==-1)	{
   1981					;
   1982	0856  83 FE FF			     cmp     si,-1
   1983	0859  75 09			     jne     short @22@170
   1984	085B			     @22@114:
   1985					;
   1986					;		     enable();
   1987					;
   1988	085B  E8 0000e			     call    near ptr _enable
   1989					;
   1990					;		     return miniSO_ERROR;
   1991					;
   1992	085E  B8 FFFF			     mov     ax,-1
   1993	0861			     @22@142:
   1994	0861  E9 02B8			     jmp     @22@1206
   1995	0864			     @22@170:
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 36
scall.ASM



   1996	0864  EB 40			     jmp     short @22@226
   1997	0866			     @22@198:
   1998					;
   1999					;	     }
   2000					;	     /*	Trata os zumbis	do processo, colocando-os na lista de livres */
   2001					;	     i = miniSO_thread[pcb].zombies;
   2002					;	     while   (i!= -1)  {
   2003					;		     miniSO_thread[pcb].zombies	= miniSO_thread[i].next;
   2004					;
   2005	0866  8B C7			     mov     ax,di
   2006	0868  BA 001A			     mov     dx,26
   2007	086B  F7 EA			     imul    dx
   2008	086D  8B D8			     mov     bx,ax
   2009	086F  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2010	0873  50			     push    ax
   2011	0874  8B C6			     mov     ax,si
   2012	0876  BA 001A			     mov     dx,26
   2013	0879  F7 EA			     imul    dx
   2014	087B  8B D8			     mov     bx,ax
   2015	087D  58			     pop     ax
   2016	087E  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   2017					;
   2018					;		     miniSO_thread[i].next   = miniSO_free;
   2019					;
   2020	0882  8B C7			     mov     ax,di
   2021	0884  BA 001A			     mov     dx,26
   2022	0887  F7 EA			     imul    dx
   2023	0889  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2024	088D  8B D8			     mov     bx,ax
   2025	088F  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2026					;
   2027					;		     miniSO_free	     = i;
   2028					;
   2029	0893  89 3E 0009r		     mov     word ptr DGROUP:_miniSO_free,di
   2030					;
   2031					;		     miniSO_thread[i].status = FREE;
   2032					;
   2033	0897  8B C7			     mov     ax,di
   2034	0899  BA 001A			     mov     dx,26
   2035	089C  F7 EA			     imul    dx
   2036	089E  8B D8			     mov     bx,ax
   2037	08A0  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2038					;
   2039					;		     i = miniSO_thread[pcb].zombies;
   2040					;
   2041	08A6			     @22@226:
   2042	08A6  8B C6			     mov     ax,si
   2043	08A8  BA 001A			     mov     dx,26
   2044	08AB  F7 EA			     imul    dx
   2045	08AD  8B D8			     mov     bx,ax
   2046	08AF  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2047	08B3  83 FF FF			     cmp     di,-1
   2048	08B6  75 AE			     jne     short @22@198
   2049					;
   2050					;	     }
   2051					;	     /*	Passa os filhos	do processo para o avo */
   2052					;	     for     (i=0;i<miniSO_MAXTHREADS;++i)  {
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 37
scall.ASM



   2053					;
   2054	08B8  33 FF			     xor     di,di
   2055	08BA  EB 4B			     jmp     short @22@422
   2056	08BC			     @22@310:
   2057					;
   2058					;		     if	     (miniSO_thread[i].status!=FREE && miniSO_thread[i].ppid ==	    +
   2059				     miniSO_thread[pcb].pid)
   2060					;
   2061	08BC  8B C7			     mov     ax,di
   2062	08BE  BA 001A			     mov     dx,26
   2063	08C1  F7 EA			     imul    dx
   2064	08C3  8B D8			     mov     bx,ax
   2065	08C5  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2066	08CA  74 3A			     je	     short @22@394
   2067	08CC  8B C7			     mov     ax,di
   2068	08CE  BA 001A			     mov     dx,26
   2069	08D1  F7 EA			     imul    dx
   2070	08D3  8B D8			     mov     bx,ax
   2071	08D5  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2072	08D9  50			     push    ax
   2073	08DA  8B C6			     mov     ax,si
   2074	08DC  BA 001A			     mov     dx,26
   2075	08DF  F7 EA			     imul    dx
   2076	08E1  8B D8			     mov     bx,ax
   2077	08E3  58			     pop     ax
   2078	08E4  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   2079	08E8  75 1C			     jne     short @22@394
   2080					;
   2081					;			     miniSO_thread[i].ppid = miniSO_thread[pcb].ppid;
   2082					;
   2083	08EA  8B C6			     mov     ax,si
   2084	08EC  BA 001A			     mov     dx,26
   2085	08EF  F7 EA			     imul    dx
   2086	08F1  8B D8			     mov     bx,ax
   2087	08F3  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2088	08F7  50			     push    ax
   2089	08F8  8B C7			     mov     ax,di
   2090	08FA  BA 001A			     mov     dx,26
   2091	08FD  F7 EA			     imul    dx
   2092	08FF  8B D8			     mov     bx,ax
   2093	0901  58			     pop     ax
   2094	0902  89 87 0009r		     mov     word ptr DGROUP:_miniSO_thread[bx+2],ax
   2095	0906			     @22@394:
   2096	0906  47			     inc     di
   2097	0907			     @22@422:
   2098	0907  83 FF 10			     cmp     di,16
   2099	090A  7C B0			     jl	     short @22@310
   2100					;
   2101					;	     }
   2102					;	     /*	Salva anterior e proximo da thread que sera deletada */
   2103					;	     prevthread	= miniSO_thread[pcb].prev;
   2104					;
   2105	090C  8B C6			     mov     ax,si
   2106	090E  BA 001A			     mov     dx,26
   2107	0911  F7 EA			     imul    dx
   2108	0913  8B D8			     mov     bx,ax
   2109	0915  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 38
scall.ASM



   2110	0919  89 46 FC			     mov     word ptr [bp-4],ax
   2111					;
   2112					;	     nextthread	= miniSO_thread[pcb].next;
   2113					;
   2114	091C  8B C6			     mov     ax,si
   2115	091E  BA 001A			     mov     dx,26
   2116	0921  F7 EA			     imul    dx
   2117	0923  8B D8			     mov     bx,ax
   2118	0925  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2119	0929  89 46 FA			     mov     word ptr [bp-6],ax
   2120					;
   2121					;	     /*	A thread pode estar em um de varios estados... */
   2122					;	     switch  (miniSO_thread[pcb].status)  {
   2123					;
   2124	092C  8B C6			     mov     ax,si
   2125	092E  BA 001A			     mov     dx,26
   2126	0931  F7 EA			     imul    dx
   2127	0933  8B D8			     mov     bx,ax
   2128	0935  8B 9F 000Br		     mov     bx,word ptr DGROUP:_miniSO_thread[bx+4]
   2129	0939  83 FB 05			     cmp     bx,5
   2130	093C  77 53			     ja	     short @22@758
   2131	093E  D1 E3			     shl     bx,1
   2132	0940  2E: FF A7	0B22r		     jmp     word ptr cs:@22@C1250[bx]
   2133	0945			     @22@562:
   2134					;
   2135					;		     case    READY:
   2136					;		     case    RUNNING:
   2137					;			     /*	Exclui o nodo da lista de prontos */
   2138					;			     miniSO_thread[prevthread].next=nextthread;
   2139					;
   2140	0945  8B 46 FC			     mov     ax,word ptr [bp-4]
   2141	0948  BA 001A			     mov     dx,26
   2142	094B  F7 EA			     imul    dx
   2143	094D  8B 56 FA			     mov     dx,word ptr [bp-6]
   2144	0950  8B D8			     mov     bx,ax
   2145	0952  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2146					;
   2147					;			     miniSO_thread[nextthread].prev=prevthread;
   2148					;
   2149	0956  8B 46 FA			     mov     ax,word ptr [bp-6]
   2150	0959  BA 001A			     mov     dx,26
   2151	095C  F7 EA			     imul    dx
   2152	095E  8B 56 FC			     mov     dx,word ptr [bp-4]
   2153	0961  8B D8			     mov     bx,ax
   2154	0963  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2155					;
   2156					;			     if	     (pcb==miniSO_ready)  {
   2157					;
   2158	0967  3B 36 0007r		     cmp     si,word ptr DGROUP:_miniSO_ready
   2159	096B  75 1E			     jne     short @22@674
   2160					;
   2161					;				     if	     (nextthread==miniSO_ready)
   2162					;
   2163	096D  8B 46 FA			     mov     ax,word ptr [bp-6]
   2164	0970  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   2165	0974  75 0A			     jne     short @22@646
   2166					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 39
scall.ASM



   2167					;					     end_mso("kill(): nao ha' mais threads	    +
   2168				     executando!");
   2169					;
   2170	0976  B8 00CFr			     mov     ax,offset DGROUP:s@+69
   2171	0979  50			     push    ax
   2172	097A  E8 FAC0			     call    near ptr end_mso
   2173	097D  59			     pop     cx
   2174	097E  EB 0B			     jmp     short @22@674
   2175	0980			     @22@646:
   2176					;
   2177					;				     else  {
   2178					;					     miniSO_nextthread=nextthread;
   2179					;
   2180	0980  8B 46 FA			     mov     ax,word ptr [bp-6]
   2181	0983  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   2182					;
   2183					;					     miniSO_delcurthread=1;
   2184					;
   2185	0986  C6 06 0006r 01		     mov     byte ptr DGROUP:_miniSO_delcurthread,1
   2186	098B			     @22@674:
   2187					;
   2188					;				     }
   2189					;			     }
   2190					;			     break;
   2191					;
   2192	098B  EB 07			     jmp     short @22@786
   2193	098D			     @22@702:
   2194					;
   2195					;		     case    WAITSEM:
   2196					;			     /*	Exclui o nodo da lista do semaforo */
   2197					;			     break;
   2198					;
   2199	098D  EB 05			     jmp     short @22@786
   2200	098F			     @22@730:
   2201					;
   2202					;		     case    WAIT:
   2203					;		     case    WAITSIG:
   2204					;			     break;
   2205					;
   2206	098F  EB 03			     jmp     short @22@786
   2207	0991			     @22@758:
   2208	0991  E9 FEC7			     jmp     @22@114
   2209	0994			     @22@786:
   2210					;
   2211					;		     case    ZOMBIE:
   2212					;		     default:
   2213					;			     enable();
   2214					;			     return miniSO_ERROR;
   2215					;	     }
   2216					;	     /*	Coloca o BCP da	thread na lista	de filhos zumbis do pai	*/
   2217					;	     pai = get_pcb(miniSO_thread[pcb].ppid);
   2218					;
   2219	0994  8B C6			     mov     ax,si
   2220	0996  BA 001A			     mov     dx,26
   2221	0999  F7 EA			     imul    dx
   2222	099B  8B D8			     mov     bx,ax
   2223	099D  FF B7 0009r		     push    word ptr DGROUP:_miniSO_thread[bx+2]
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 40
scall.ASM



   2224	09A1  E8 FADE			     call    near ptr get_pcb
   2225	09A4  59			     pop     cx
   2226	09A5  89 46 F8			     mov     word ptr [bp-8],ax
   2227					;
   2228					;	     if	     (pai==-1) { /* Se nao encontrou o pai, */
   2229					;
   2230	09A8  83 7E F8 FF		     cmp     word ptr [bp-8],-1
   2231	09AC  75 27			     jne     short @22@842
   2232					;
   2233					;		     /*	coloca o processo na lista de livres */
   2234					;		     miniSO_thread[pcb].status = FREE;
   2235					;
   2236	09AE  8B C6			     mov     ax,si
   2237	09B0  BA 001A			     mov     dx,26
   2238	09B3  F7 EA			     imul    dx
   2239	09B5  8B D8			     mov     bx,ax
   2240	09B7  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2241					;
   2242					;		     miniSO_thread[pcb].next = miniSO_free;
   2243					;
   2244	09BD  8B C6			     mov     ax,si
   2245	09BF  BA 001A			     mov     dx,26
   2246	09C2  F7 EA			     imul    dx
   2247	09C4  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2248	09C8  8B D8			     mov     bx,ax
   2249	09CA  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2250					;
   2251					;		     miniSO_free=pcb;
   2252					;
   2253	09CE  89 36 0009r		     mov     word ptr DGROUP:_miniSO_free,si
   2254					;
   2255					;	     }
   2256					;
   2257	09D2  E9 0095			     jmp     @22@1038
   2258	09D5			     @22@842:
   2259					;
   2260					;	     else  {
   2261					;		     /*	senao, coloca o	processo na lista de zumbis do pai */
   2262					;		     miniSO_thread[pcb].status = ZOMBIE;
   2263					;
   2264	09D5  8B C6			     mov     ax,si
   2265	09D7  BA 001A			     mov     dx,26
   2266	09DA  F7 EA			     imul    dx
   2267	09DC  8B D8			     mov     bx,ax
   2268	09DE  C7 87 000Br 0002		     mov     word ptr DGROUP:_miniSO_thread[bx+4],2
   2269					;
   2270					;		     if	     (miniSO_thread[pai].zombies==-1) {	/* Se a	lista esta vazia */
   2271					;
   2272	09E4  8B 46 F8			     mov     ax,word ptr [bp-8]
   2273	09E7  BA 001A			     mov     dx,26
   2274	09EA  F7 EA			     imul    dx
   2275	09EC  8B D8			     mov     bx,ax
   2276	09EE  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   2277	09F3  75 1F			     jne     short @22@898
   2278					;
   2279					;			     /*	Insere no inicio */
   2280					;			     miniSO_thread[pai].zombies	= pcb;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 41
scall.ASM



   2281					;
   2282	09F5  8B 46 F8			     mov     ax,word ptr [bp-8]
   2283	09F8  BA 001A			     mov     dx,26
   2284	09FB  F7 EA			     imul    dx
   2285	09FD  8B D8			     mov     bx,ax
   2286	09FF  89 B7 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],si
   2287					;
   2288					;			     miniSO_thread[pcb].prev = -1;
   2289					;
   2290	0A03  8B C6			     mov     ax,si
   2291	0A05  BA 001A			     mov     dx,26
   2292	0A08  F7 EA			     imul    dx
   2293	0A0A  8B D8			     mov     bx,ax
   2294	0A0C  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2295					;
   2296					;		     }
   2297					;
   2298	0A12  EB 47			     jmp     short @22@1010
   2299	0A14			     @22@898:
   2300					;
   2301					;		     else {
   2302					;			     /*	Senao insere no	final */
   2303					;			     i = miniSO_thread[pai].zombies;
   2304					;
   2305	0A14  8B 46 F8			     mov     ax,word ptr [bp-8]
   2306	0A17  BA 001A			     mov     dx,26
   2307	0A1A  F7 EA			     imul    dx
   2308	0A1C  8B D8			     mov     bx,ax
   2309	0A1E  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2310	0A22  EB 0D			     jmp     short @22@954
   2311	0A24			     @22@926:
   2312					;
   2313					;			     while   (miniSO_thread[i].next!=-1)
   2314					;				     i = miniSO_thread[i].next;
   2315					;
   2316	0A24  8B C7			     mov     ax,di
   2317	0A26  BA 001A			     mov     dx,26
   2318	0A29  F7 EA			     imul    dx
   2319	0A2B  8B D8			     mov     bx,ax
   2320	0A2D  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2321	0A31			     @22@954:
   2322	0A31  8B C7			     mov     ax,di
   2323	0A33  BA 001A			     mov     dx,26
   2324	0A36  F7 EA			     imul    dx
   2325	0A38  8B D8			     mov     bx,ax
   2326	0A3A  83 BF 001Fr FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2327	0A3F  75 E3			     jne     short @22@926
   2328					;
   2329					;			     miniSO_thread[i].next = pcb;
   2330					;
   2331	0A41  8B C7			     mov     ax,di
   2332	0A43  BA 001A			     mov     dx,26
   2333	0A46  F7 EA			     imul    dx
   2334	0A48  8B D8			     mov     bx,ax
   2335	0A4A  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   2336					;
   2337					;			     miniSO_thread[pcb].prev = i;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 42
scall.ASM



   2338					;
   2339	0A4E  8B C6			     mov     ax,si
   2340	0A50  BA 001A			     mov     dx,26
   2341	0A53  F7 EA			     imul    dx
   2342	0A55  8B D8			     mov     bx,ax
   2343	0A57  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   2344	0A5B			     @22@1010:
   2345					;
   2346					;		     }
   2347					;		     miniSO_thread[pcb].next = -1;
   2348					;
   2349	0A5B  8B C6			     mov     ax,si
   2350	0A5D  BA 001A			     mov     dx,26
   2351	0A60  F7 EA			     imul    dx
   2352	0A62  8B D8			     mov     bx,ax
   2353	0A64  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2354	0A6A			     @22@1038:
   2355					;
   2356					;	     }
   2357					;	     if	     (miniSO_thread[pai].status==WAIT) {
   2358					;
   2359	0A6A  8B 46 F8			     mov     ax,word ptr [bp-8]
   2360	0A6D  BA 001A			     mov     dx,26
   2361	0A70  F7 EA			     imul    dx
   2362	0A72  8B D8			     mov     bx,ax
   2363	0A74  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2364	0A79  75 00			     jne     short @22@1066
   2365	0A7B			     @22@1066:
   2366					;
   2367					;	     }
   2368					;	     /*	REVISAR	*/
   2369					;      /* Se o processo-pai esta' esperando em wait, coloca ele	na lista de prontos */
   2370					;      nextthread = miniSO_thread[pcb].wait;
   2371					;
   2372	0A7B  8B C6			     mov     ax,si
   2373	0A7D  BA 001A			     mov     dx,26
   2374	0A80  F7 EA			     imul    dx
   2375	0A82  8B D8			     mov     bx,ax
   2376	0A84  8B 87 0015r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+14]
   2377	0A88  89 46 FA			     mov     word ptr [bp-6],ax
   2378					;
   2379					;      if (nextthread != -1)  {
   2380					;
   2381	0A8B  83 7E FA FF		     cmp     word ptr [bp-6],-1
   2382	0A8F  75 03			     jne     @@2
   2383	0A91  EB 77 90			     jmp     @22@1122
   2384	0A94			     @@2:
   2385					;
   2386					;	  /* Descobre qual a ultima thread */
   2387					;	  last = miniSO_thread[miniSO_ready].prev;
   2388					;
   2389	0A94  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2390	0A97  BA 001A			     mov     dx,26
   2391	0A9A  F7 EA			     imul    dx
   2392	0A9C  8B D8			     mov     bx,ax
   2393	0A9E  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2394	0AA2  89 46 FE			     mov     word ptr [bp-2],ax
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 43
scall.ASM



   2395					;
   2396					;	  /* Acerta links para incluir a thread	no final da lista de prontos*/
   2397					;	  miniSO_thread[nextthread].prev    = last;
   2398					;
   2399	0AA5  8B 46 FA			     mov     ax,word ptr [bp-6]
   2400	0AA8  BA 001A			     mov     dx,26
   2401	0AAB  F7 EA			     imul    dx
   2402	0AAD  8B 56 FE			     mov     dx,word ptr [bp-2]
   2403	0AB0  8B D8			     mov     bx,ax
   2404	0AB2  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2405					;
   2406					;	  miniSO_thread[nextthread].next    = miniSO_ready;
   2407					;
   2408	0AB6  8B 46 FA			     mov     ax,word ptr [bp-6]
   2409	0AB9  BA 001A			     mov     dx,26
   2410	0ABC  F7 EA			     imul    dx
   2411	0ABE  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   2412	0AC2  8B D8			     mov     bx,ax
   2413	0AC4  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2414					;
   2415					;	  miniSO_thread[last].next	    = nextthread;
   2416					;
   2417	0AC8  8B 46 FE			     mov     ax,word ptr [bp-2]
   2418	0ACB  BA 001A			     mov     dx,26
   2419	0ACE  F7 EA			     imul    dx
   2420	0AD0  8B 56 FA			     mov     dx,word ptr [bp-6]
   2421	0AD3  8B D8			     mov     bx,ax
   2422	0AD5  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2423					;
   2424					;	  miniSO_thread[miniSO_ready].prev  = nextthread;
   2425					;
   2426	0AD9  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2427	0ADC  BA 001A			     mov     dx,26
   2428	0ADF  F7 EA			     imul    dx
   2429	0AE1  8B 56 FA			     mov     dx,word ptr [bp-6]
   2430	0AE4  8B D8			     mov     bx,ax
   2431	0AE6  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2432					;
   2433					;	  miniSO_thread[nextthread].exitcode = miniSO_ERROR;
   2434					;
   2435	0AEA  8B 46 FA			     mov     ax,word ptr [bp-6]
   2436	0AED  BA 001A			     mov     dx,26
   2437	0AF0  F7 EA			     imul    dx
   2438	0AF2  8B D8			     mov     bx,ax
   2439	0AF4  C7 87 0019r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+18],-1
   2440					;
   2441					;	  miniSO_thread[nextthread].status  = READY;
   2442					;
   2443	0AFA  8B 46 FA			     mov     ax,word ptr [bp-6]
   2444	0AFD  BA 001A			     mov     dx,26
   2445	0B00  F7 EA			     imul    dx
   2446	0B02  8B D8			     mov     bx,ax
   2447	0B04  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   2448	0B0A			     @22@1122:
   2449					;
   2450					;      }
   2451					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 44
scall.ASM



   2452					;	     enable();
   2453					;
   2454	0B0A  E8 0000e			     call    near ptr _enable
   2455					;
   2456					;	     if	     (miniSO_delcurthread)
   2457					;
   2458	0B0D  80 3E 0006r 00		     cmp     byte ptr DGROUP:_miniSO_delcurthread,0
   2459	0B12  74 02			     je	     short @22@1178
   2460	0B14			     @22@1150:
   2461	0B14  EB FE			     jmp     short @22@1150
   2462	0B16			     @22@1178:
   2463					;
   2464					;		     while   (1)
   2465					;			     ;
   2466					;	     return miniSO_OK;
   2467					;
   2468	0B16  B8 0001			     mov     ax,1
   2469	0B19  E9 FD45			     jmp     @22@142
   2470	0B1C			     @22@1206:
   2471					;
   2472					;    }
   2473					;
   2474	0B1C  5F			     pop     di
   2475	0B1D  5E			     pop     si
   2476	0B1E  8B E5			     mov     sp,bp
   2477	0B20  5D			     pop     bp
   2478	0B21  C3			     ret
   2479	0B22			     _sc_kill	     endp
   2480	0B22			     @22@C1250	     label   word
   2481	0B22  0945r			     dw	     @22@562
   2482	0B24  0945r			     dw	     @22@562
   2483	0B26  0991r			     dw	     @22@758
   2484	0B28  098Fr			     dw	     @22@730
   2485	0B2A  098Fr			     dw	     @22@730
   2486	0B2C  098Dr			     dw	     @22@702
   2487					;
   2488					;    int sc_waitpid(pid_t pid,unsigned seg,unsigned off)
   2489					;
   2490					     assume  cs:_TEXT
   2491	0B2E			     _sc_waitpid     proc    near
   2492	0B2E  55			     push    bp
   2493	0B2F  8B EC			     mov     bp,sp
   2494	0B31  83 EC 08			     sub     sp,8
   2495	0B34  56			     push    si
   2496	0B35  57			     push    di
   2497					;
   2498					;    {
   2499					;	     pcb_t pcb,pcbw,prevthread,nextthread,atual;
   2500					;	     int far *p_ref;
   2501					;
   2502					;	     disable();
   2503					;
   2504	0B36  E8 0000e			     call    near ptr _disable
   2505					;
   2506					;	     /*	Tem que	verificar se existe a thread */
   2507					;	     pcb = get_pcb(pid);
   2508					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 45
scall.ASM



   2509	0B39  FF 76 04			     push    word ptr [bp+4]
   2510	0B3C  E8 F943			     call    near ptr get_pcb
   2511	0B3F  59			     pop     cx
   2512	0B40  89 46 FE			     mov     word ptr [bp-2],ax
   2513					;
   2514					;	     /*	Se nao existe uma thread com este numero ou se não é pai da thread, entao   +
   2515				     retorna */
   2516					;	     if	     (pcb==-1 || miniSO_thread[pcb].ppid != miniSO_thread[miniSO_ready].pid)+
   2517				     {
   2518					;
   2519	0B43  83 7E FE FF		     cmp     word ptr [bp-2],-1
   2520	0B47  74 20			     je	     short @23@86
   2521	0B49  8B 46 FE			     mov     ax,word ptr [bp-2]
   2522	0B4C  BA 001A			     mov     dx,26
   2523	0B4F  F7 EA			     imul    dx
   2524	0B51  8B D8			     mov     bx,ax
   2525	0B53  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2526	0B57  50			     push    ax
   2527	0B58  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2528	0B5B  BA 001A			     mov     dx,26
   2529	0B5E  F7 EA			     imul    dx
   2530	0B60  8B D8			     mov     bx,ax
   2531	0B62  58			     pop     ax
   2532	0B63  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   2533	0B67  74 09			     je	     short @23@142
   2534	0B69			     @23@86:
   2535					;
   2536					;		     enable();
   2537					;
   2538	0B69  E8 0000e			     call    near ptr _enable
   2539					;
   2540					;		     return miniSO_ERROR;
   2541					;
   2542	0B6C  B8 FFFF			     mov     ax,-1
   2543	0B6F			     @23@114:
   2544	0B6F  E9 0189			     jmp     @23@534
   2545	0B72			     @23@142:
   2546					;
   2547					;	     }
   2548					;	     if	     (miniSO_thread[pcb].status!=ZOMBIE)  {
   2549					;
   2550	0B72  8B 46 FE			     mov     ax,word ptr [bp-2]
   2551	0B75  BA 001A			     mov     dx,26
   2552	0B78  F7 EA			     imul    dx
   2553	0B7A  8B D8			     mov     bx,ax
   2554	0B7C  83 BF 000Br 02		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],2
   2555	0B81  75 03			     jne     @@3
   2556	0B83  E9 00B2			     jmp     @23@310
   2557	0B86			     @@3:
   2558					;
   2559					;		     /*	O processo-filho ainda esta em execucao... */
   2560					;		     atual = miniSO_ready;
   2561					;
   2562	0B86  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   2563					;
   2564					;		     prevthread	= miniSO_thread[atual].prev;
   2565					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 46
scall.ASM



   2566	0B8A  8B C6			     mov     ax,si
   2567	0B8C  BA 001A			     mov     dx,26
   2568	0B8F  F7 EA			     imul    dx
   2569	0B91  8B D8			     mov     bx,ax
   2570	0B93  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2571	0B97  89 46 FC			     mov     word ptr [bp-4],ax
   2572					;
   2573					;		     nextthread	= miniSO_thread[atual].next;
   2574					;
   2575	0B9A  8B C6			     mov     ax,si
   2576	0B9C  BA 001A			     mov     dx,26
   2577	0B9F  F7 EA			     imul    dx
   2578	0BA1  8B D8			     mov     bx,ax
   2579	0BA3  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2580					;
   2581					;		     /*	Se eh a	ultima thread ... */
   2582					;		     if	     (atual == nextthread)
   2583					;
   2584	0BA7  3B F7			     cmp     si,di
   2585	0BA9  75 08			     jne     short @23@226
   2586					;
   2587					;			     end_mso("waitpid(): nao ha' mais threads executando!");
   2588					;
   2589	0BAB  B8 00F8r			     mov     ax,offset DGROUP:s@+110
   2590	0BAE  50			     push    ax
   2591	0BAF  E8 F88B			     call    near ptr end_mso
   2592	0BB2  59			     pop     cx
   2593	0BB3			     @23@226:
   2594					;
   2595					;		     /*	Vincula	o BCP da thread	atual ao BCP da	thread "destino" */
   2596					;		     miniSO_thread[pcb].wait = atual;
   2597					;
   2598	0BB3  8B 46 FE			     mov     ax,word ptr [bp-2]
   2599	0BB6  BA 001A			     mov     dx,26
   2600	0BB9  F7 EA			     imul    dx
   2601	0BBB  8B D8			     mov     bx,ax
   2602	0BBD  89 B7 0015r		     mov     word ptr DGROUP:_miniSO_thread[bx+14],si
   2603					;
   2604					;		     miniSO_thread[atual].prev = -1;
   2605					;
   2606	0BC1  8B C6			     mov     ax,si
   2607	0BC3  BA 001A			     mov     dx,26
   2608	0BC6  F7 EA			     imul    dx
   2609	0BC8  8B D8			     mov     bx,ax
   2610	0BCA  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2611					;
   2612					;		     miniSO_thread[atual].next = -1;
   2613					;
   2614	0BD0  8B C6			     mov     ax,si
   2615	0BD2  BA 001A			     mov     dx,26
   2616	0BD5  F7 EA			     imul    dx
   2617	0BD7  8B D8			     mov     bx,ax
   2618	0BD9  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2619					;
   2620					;		     miniSO_thread[atual].waitfor = pcb;
   2621					;
   2622	0BDF  8B C6			     mov     ax,si
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 47
scall.ASM



   2623	0BE1  BA 001A			     mov     dx,26
   2624	0BE4  F7 EA			     imul    dx
   2625	0BE6  8B 56 FE			     mov     dx,word ptr [bp-2]
   2626	0BE9  8B D8			     mov     bx,ax
   2627	0BEB  89 97 0017r		     mov     word ptr DGROUP:_miniSO_thread[bx+16],dx
   2628					;
   2629					;		     miniSO_thread[atual].status = WAIT;
   2630					;
   2631	0BEF  8B C6			     mov     ax,si
   2632	0BF1  BA 001A			     mov     dx,26
   2633	0BF4  F7 EA			     imul    dx
   2634	0BF6  8B D8			     mov     bx,ax
   2635	0BF8  C7 87 000Br 0003		     mov     word ptr DGROUP:_miniSO_thread[bx+4],3
   2636					;
   2637					;		     /*	Exclui o nodo da lista de prontos */
   2638					;		     miniSO_thread[prevthread].next=nextthread;
   2639					;
   2640	0BFE  8B 46 FC			     mov     ax,word ptr [bp-4]
   2641	0C01  BA 001A			     mov     dx,26
   2642	0C04  F7 EA			     imul    dx
   2643	0C06  8B D8			     mov     bx,ax
   2644	0C08  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   2645					;
   2646					;		     miniSO_thread[nextthread].prev=prevthread;
   2647					;
   2648	0C0C  8B C7			     mov     ax,di
   2649	0C0E  BA 001A			     mov     dx,26
   2650	0C11  F7 EA			     imul    dx
   2651	0C13  8B 56 FC			     mov     dx,word ptr [bp-4]
   2652	0C16  8B D8			     mov     bx,ax
   2653	0C18  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2654					;
   2655					;		     miniSO_nextthread=nextthread;
   2656					;
   2657	0C1C  89 3E 0004r		     mov     word ptr DGROUP:_miniSO_nextthread,di
   2658					;
   2659					;		     enable();
   2660					;
   2661	0C20  E8 0000e			     call    near ptr _enable
   2662	0C23  EB 00			     jmp     short @23@254
   2663	0C25			     @23@254:
   2664					;
   2665					;		     while   (miniSO_thread[atual].status == WAIT)
   2666					;
   2667	0C25  8B C6			     mov     ax,si
   2668	0C27  BA 001A			     mov     dx,26
   2669	0C2A  F7 EA			     imul    dx
   2670	0C2C  8B D8			     mov     bx,ax
   2671	0C2E  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2672	0C33  74 F0			     je	     short @23@254
   2673					;
   2674					;			     ;
   2675					;		     disable();
   2676					;
   2677	0C35  E8 0000e			     call    near ptr _disable
   2678	0C38			     @23@310:
   2679					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 48
scall.ASM



   2680					;	     }
   2681					;	     /*	O processo filho ja terminou...	*/
   2682					;	     /*	Retira o processo filho	da lista de zumbis do pai */
   2683					;	     atual = pcb;
   2684					;
   2685	0C38  8B 76 FE			     mov     si,word ptr [bp-2]
   2686					;
   2687					;	     prevthread	= miniSO_thread[atual].prev;
   2688					;
   2689	0C3B  8B C6			     mov     ax,si
   2690	0C3D  BA 001A			     mov     dx,26
   2691	0C40  F7 EA			     imul    dx
   2692	0C42  8B D8			     mov     bx,ax
   2693	0C44  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2694	0C48  89 46 FC			     mov     word ptr [bp-4],ax
   2695					;
   2696					;	     nextthread	= miniSO_thread[atual].next;
   2697					;
   2698	0C4B  8B C6			     mov     ax,si
   2699	0C4D  BA 001A			     mov     dx,26
   2700	0C50  F7 EA			     imul    dx
   2701	0C52  8B D8			     mov     bx,ax
   2702	0C54  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2703					;
   2704					;	     if	     (prevthread == -1)	 { /* E	o primeiro da lista */
   2705					;
   2706	0C58  83 7E FC FF		     cmp     word ptr [bp-4],-1
   2707	0C5C  75 24			     jne     short @23@422
   2708					;
   2709					;		     miniSO_thread[miniSO_ready].zombies = nextthread;
   2710					;
   2711	0C5E  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2712	0C61  BA 001A			     mov     dx,26
   2713	0C64  F7 EA			     imul    dx
   2714	0C66  8B D8			     mov     bx,ax
   2715	0C68  89 BF 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],di
   2716					;
   2717					;		     if	     (nextthread != -1)
   2718					;
   2719	0C6C  83 FF FF			     cmp     di,-1
   2720	0C6F  74 0F			     je	     short @23@394
   2721					;
   2722					;			     miniSO_thread[nextthread].prev = -1;
   2723					;
   2724	0C71  8B C7			     mov     ax,di
   2725	0C73  BA 001A			     mov     dx,26
   2726	0C76  F7 EA			     imul    dx
   2727	0C78  8B D8			     mov     bx,ax
   2728	0C7A  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2729	0C80			     @23@394:
   2730					;
   2731					;	     }
   2732					;
   2733	0C80  EB 0E			     jmp     short @23@450
   2734	0C82			     @23@422:
   2735					;
   2736					;	     else
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 49
scall.ASM



   2737					;		     miniSO_thread[prevthread].next = nextthread;
   2738					;
   2739	0C82  8B 46 FC			     mov     ax,word ptr [bp-4]
   2740	0C85  BA 001A			     mov     dx,26
   2741	0C88  F7 EA			     imul    dx
   2742	0C8A  8B D8			     mov     bx,ax
   2743	0C8C  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   2744	0C90			     @23@450:
   2745					;
   2746					;	     if	     (nextthread != -1)
   2747					;
   2748	0C90  83 FF FF			     cmp     di,-1
   2749	0C93  74 10			     je	     short @23@506
   2750					;
   2751					;		     miniSO_thread[nextthread].prev = prevthread;
   2752					;
   2753	0C95  8B C7			     mov     ax,di
   2754	0C97  BA 001A			     mov     dx,26
   2755	0C9A  F7 EA			     imul    dx
   2756	0C9C  8B 56 FC			     mov     dx,word ptr [bp-4]
   2757	0C9F  8B D8			     mov     bx,ax
   2758	0CA1  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2759	0CA5			     @23@506:
   2760					;
   2761					;	     p_ref = MK_FP(seg,off);
   2762					;
   2763	0CA5  FF 76 08			     push    word ptr [bp+8]
   2764	0CA8  FF 76 06			     push    word ptr [bp+6]
   2765	0CAB  E8 0000e			     call    near ptr _MK_FP
   2766	0CAE  59			     pop     cx
   2767	0CAF  59			     pop     cx
   2768	0CB0  89 56 FA			     mov     word ptr [bp-6],dx
   2769	0CB3  89 46 F8			     mov     word ptr [bp-8],ax
   2770					;
   2771					;	     *p_ref = miniSO_thread[pcb].exitcode;
   2772					;
   2773	0CB6  8B 46 FE			     mov     ax,word ptr [bp-2]
   2774	0CB9  BA 001A			     mov     dx,26
   2775	0CBC  F7 EA			     imul    dx
   2776	0CBE  8B D8			     mov     bx,ax
   2777	0CC0  8B 87 0019r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+18]
   2778	0CC4  C4 5E F8			     les     bx,dword ptr [bp-8]
   2779	0CC7  26: 89 07			     mov     word ptr es:[bx],ax
   2780					;
   2781					;	     /*	Insere o processo na lista de BCPs livres */
   2782					;	     miniSO_thread[pcb].next = miniSO_free;
   2783					;
   2784	0CCA  8B 46 FE			     mov     ax,word ptr [bp-2]
   2785	0CCD  BA 001A			     mov     dx,26
   2786	0CD0  F7 EA			     imul    dx
   2787	0CD2  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2788	0CD6  8B D8			     mov     bx,ax
   2789	0CD8  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2790					;
   2791					;	     miniSO_free = pcb;
   2792					;
   2793	0CDC  8B 46 FE			     mov     ax,word ptr [bp-2]
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 50
scall.ASM



   2794	0CDF  A3 0009r			     mov     word ptr DGROUP:_miniSO_free,ax
   2795					;
   2796					;	     miniSO_thread[pcb].status = FREE;
   2797					;
   2798	0CE2  8B 46 FE			     mov     ax,word ptr [bp-2]
   2799	0CE5  BA 001A			     mov     dx,26
   2800	0CE8  F7 EA			     imul    dx
   2801	0CEA  8B D8			     mov     bx,ax
   2802	0CEC  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2803					;
   2804					;	     enable();
   2805					;
   2806	0CF2  E8 0000e			     call    near ptr _enable
   2807					;
   2808					;	     return pid;
   2809					;
   2810	0CF5  8B 46 04			     mov     ax,word ptr [bp+4]
   2811	0CF8  E9 FE74			     jmp     @23@114
   2812	0CFB			     @23@534:
   2813					;
   2814					;    }
   2815					;
   2816	0CFB  5F			     pop     di
   2817	0CFC  5E			     pop     si
   2818	0CFD  8B E5			     mov     sp,bp
   2819	0CFF  5D			     pop     bp
   2820	0D00  C3			     ret
   2821	0D01			     _sc_waitpid     endp
   2822					;
   2823					;    int sc_wait(unsigned seg,unsigned off)
   2824					;
   2825					     assume  cs:_TEXT
   2826	0D01			     _sc_wait	     proc    near
   2827	0D01  55			     push    bp
   2828	0D02  8B EC			     mov     bp,sp
   2829	0D04  83 EC 08			     sub     sp,8
   2830	0D07  56			     push    si
   2831	0D08  57			     push    di
   2832					;
   2833					;    {
   2834					;	     pcb_t   zombie,next,atual,prevthread,nextthread;
   2835					;	     int far *p_ref;
   2836					;
   2837					;	     disable();
   2838					;
   2839	0D09  E8 0000e			     call    near ptr _disable
   2840					;
   2841					;	     atual =miniSO_ready;
   2842					;
   2843	0D0C  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   2844					;
   2845					;	     if	     (miniSO_thread[miniSO_ready].zombies==-1) {
   2846					;
   2847	0D10  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2848	0D13  BA 001A			     mov     dx,26
   2849	0D16  F7 EA			     imul    dx
   2850	0D18  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 51
scall.ASM



   2851	0D1A  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   2852	0D1F  74 03			     je	     @@4
   2853	0D21  E9 00AA			     jmp     @24@198
   2854	0D24			     @@4:
   2855					;
   2856					;		     /*	O pai nao tem filhos-zumbi e vai bloquear */
   2857					;		     prevthread	= miniSO_thread[atual].prev;
   2858					;
   2859	0D24  8B C6			     mov     ax,si
   2860	0D26  BA 001A			     mov     dx,26
   2861	0D29  F7 EA			     imul    dx
   2862	0D2B  8B D8			     mov     bx,ax
   2863	0D2D  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2864	0D31  89 46 FE			     mov     word ptr [bp-2],ax
   2865					;
   2866					;		     nextthread	= miniSO_thread[atual].next;
   2867					;
   2868	0D34  8B C6			     mov     ax,si
   2869	0D36  BA 001A			     mov     dx,26
   2870	0D39  F7 EA			     imul    dx
   2871	0D3B  8B D8			     mov     bx,ax
   2872	0D3D  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2873	0D41  89 46 FC			     mov     word ptr [bp-4],ax
   2874					;
   2875					;		     /*	Se eh a	ultima thread ... */
   2876					;		     if	     (miniSO_ready == nextthread)
   2877					;
   2878	0D44  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2879	0D47  3B 46 FC			     cmp     ax,word ptr [bp-4]
   2880	0D4A  75 08			     jne     short @24@114
   2881					;
   2882					;			     end_mso("wait(): nao ha' mais threads executando!");
   2883					;
   2884	0D4C  B8 0124r			     mov     ax,offset DGROUP:s@+154
   2885	0D4F  50			     push    ax
   2886	0D50  E8 F6EA			     call    near ptr end_mso
   2887	0D53  59			     pop     cx
   2888	0D54			     @24@114:
   2889					;
   2890					;		     /*	Vincula	o BCP da thread	atual ao BCP da	thread "destino" */
   2891					;		     miniSO_thread[atual].prev = -1;
   2892					;
   2893	0D54  8B C6			     mov     ax,si
   2894	0D56  BA 001A			     mov     dx,26
   2895	0D59  F7 EA			     imul    dx
   2896	0D5B  8B D8			     mov     bx,ax
   2897	0D5D  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2898					;
   2899					;		     miniSO_thread[atual].next = -1;
   2900					;
   2901	0D63  8B C6			     mov     ax,si
   2902	0D65  BA 001A			     mov     dx,26
   2903	0D68  F7 EA			     imul    dx
   2904	0D6A  8B D8			     mov     bx,ax
   2905	0D6C  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2906					;
   2907					;		     miniSO_thread[atual].waitfor = -1;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 52
scall.ASM



   2908					;
   2909	0D72  8B C6			     mov     ax,si
   2910	0D74  BA 001A			     mov     dx,26
   2911	0D77  F7 EA			     imul    dx
   2912	0D79  8B D8			     mov     bx,ax
   2913	0D7B  C7 87 0017r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+16],-1
   2914					;
   2915					;		     miniSO_thread[atual].status = WAIT;
   2916					;
   2917	0D81  8B C6			     mov     ax,si
   2918	0D83  BA 001A			     mov     dx,26
   2919	0D86  F7 EA			     imul    dx
   2920	0D88  8B D8			     mov     bx,ax
   2921	0D8A  C7 87 000Br 0003		     mov     word ptr DGROUP:_miniSO_thread[bx+4],3
   2922					;
   2923					;		     /*	Exclui o nodo da lista de prontos */
   2924					;		     miniSO_thread[atual].next=nextthread;
   2925					;
   2926	0D90  8B C6			     mov     ax,si
   2927	0D92  BA 001A			     mov     dx,26
   2928	0D95  F7 EA			     imul    dx
   2929	0D97  8B 56 FC			     mov     dx,word ptr [bp-4]
   2930	0D9A  8B D8			     mov     bx,ax
   2931	0D9C  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2932					;
   2933					;		     miniSO_thread[atual].prev=prevthread;
   2934					;
   2935	0DA0  8B C6			     mov     ax,si
   2936	0DA2  BA 001A			     mov     dx,26
   2937	0DA5  F7 EA			     imul    dx
   2938	0DA7  8B 56 FE			     mov     dx,word ptr [bp-2]
   2939	0DAA  8B D8			     mov     bx,ax
   2940	0DAC  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2941					;
   2942					;		     miniSO_nextthread=nextthread;
   2943					;
   2944	0DB0  8B 46 FC			     mov     ax,word ptr [bp-4]
   2945	0DB3  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   2946					;
   2947					;		     enable();
   2948					;
   2949	0DB6  E8 0000e			     call    near ptr _enable
   2950	0DB9  EB 00			     jmp     short @24@142
   2951	0DBB			     @24@142:
   2952					;
   2953					;		     while   (miniSO_thread[atual].status == WAIT)
   2954					;
   2955	0DBB  8B C6			     mov     ax,si
   2956	0DBD  BA 001A			     mov     dx,26
   2957	0DC0  F7 EA			     imul    dx
   2958	0DC2  8B D8			     mov     bx,ax
   2959	0DC4  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2960	0DC9  74 F0			     je	     short @24@142
   2961					;
   2962					;			     ;
   2963					;		     disable();
   2964					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 53
scall.ASM



   2965	0DCB  E8 0000e			     call    near ptr _disable
   2966	0DCE			     @24@198:
   2967					;
   2968					;	     }
   2969					;	     /*	O pai tem pelo menos um	filho zumbi... */
   2970					;	     zombie = miniSO_thread[atual].zombies;
   2971					;
   2972	0DCE  8B C6			     mov     ax,si
   2973	0DD0  BA 001A			     mov     dx,26
   2974	0DD3  F7 EA			     imul    dx
   2975	0DD5  8B D8			     mov     bx,ax
   2976	0DD7  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2977					;
   2978					;	     miniSO_thread[atual].zombies = miniSO_thread[zombie].next;
   2979					;
   2980	0DDB  8B C7			     mov     ax,di
   2981	0DDD  BA 001A			     mov     dx,26
   2982	0DE0  F7 EA			     imul    dx
   2983	0DE2  8B D8			     mov     bx,ax
   2984	0DE4  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2985	0DE8  50			     push    ax
   2986	0DE9  8B C6			     mov     ax,si
   2987	0DEB  BA 001A			     mov     dx,26
   2988	0DEE  F7 EA			     imul    dx
   2989	0DF0  8B D8			     mov     bx,ax
   2990	0DF2  58			     pop     ax
   2991	0DF3  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   2992					;
   2993					;	     if	     (miniSO_thread[atual].zombies!=-1)
   2994					;
   2995	0DF7  8B C6			     mov     ax,si
   2996	0DF9  BA 001A			     mov     dx,26
   2997	0DFC  F7 EA			     imul    dx
   2998	0DFE  8B D8			     mov     bx,ax
   2999	0E00  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   3000	0E05  74 1A			     je	     short @24@254
   3001					;
   3002					;		     miniSO_thread[miniSO_thread[atual].zombies].prev =	-1;
   3003					;
   3004	0E07  8B C6			     mov     ax,si
   3005	0E09  BA 001A			     mov     dx,26
   3006	0E0C  F7 EA			     imul    dx
   3007	0E0E  8B D8			     mov     bx,ax
   3008	0E10  8B 87 001Br		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+20]
   3009	0E14  BA 001A			     mov     dx,26
   3010	0E17  F7 EA			     imul    dx
   3011	0E19  8B D8			     mov     bx,ax
   3012	0E1B  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3013	0E21			     @24@254:
   3014					;
   3015					;	     miniSO_thread[zombie].next	= miniSO_free;
   3016					;
   3017	0E21  8B C7			     mov     ax,di
   3018	0E23  BA 001A			     mov     dx,26
   3019	0E26  F7 EA			     imul    dx
   3020	0E28  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   3021	0E2C  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 54
scall.ASM



   3022	0E2E  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3023					;
   3024					;	     miniSO_thread[zombie].status = FREE;
   3025					;
   3026	0E32  8B C7			     mov     ax,di
   3027	0E34  BA 001A			     mov     dx,26
   3028	0E37  F7 EA			     imul    dx
   3029	0E39  8B D8			     mov     bx,ax
   3030	0E3B  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3031					;
   3032					;	     miniSO_free = zombie;
   3033					;
   3034	0E41  89 3E 0009r		     mov     word ptr DGROUP:_miniSO_free,di
   3035					;
   3036					;	     p_ref = MK_FP(seg,off);
   3037					;
   3038	0E45  FF 76 06			     push    word ptr [bp+6]
   3039	0E48  FF 76 04			     push    word ptr [bp+4]
   3040	0E4B  E8 0000e			     call    near ptr _MK_FP
   3041	0E4E  59			     pop     cx
   3042	0E4F  59			     pop     cx
   3043	0E50  89 56 FA			     mov     word ptr [bp-6],dx
   3044	0E53  89 46 F8			     mov     word ptr [bp-8],ax
   3045					;
   3046					;	     *p_ref = miniSO_thread[zombie].exitcode;
   3047					;
   3048	0E56  8B C7			     mov     ax,di
   3049	0E58  BA 001A			     mov     dx,26
   3050	0E5B  F7 EA			     imul    dx
   3051	0E5D  8B D8			     mov     bx,ax
   3052	0E5F  8B 87 0019r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+18]
   3053	0E63  C4 5E F8			     les     bx,dword ptr [bp-8]
   3054	0E66  26: 89 07			     mov     word ptr es:[bx],ax
   3055					;
   3056					;	     enable();
   3057					;
   3058	0E69  E8 0000e			     call    near ptr _enable
   3059					;
   3060					;	     return miniSO_thread[zombie].pid;
   3061					;
   3062	0E6C  8B C7			     mov     ax,di
   3063	0E6E  BA 001A			     mov     dx,26
   3064	0E71  F7 EA			     imul    dx
   3065	0E73  8B D8			     mov     bx,ax
   3066	0E75  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   3067	0E79  EB 00			     jmp     short @24@282
   3068	0E7B			     @24@282:
   3069					;
   3070					;    }
   3071					;
   3072	0E7B  5F			     pop     di
   3073	0E7C  5E			     pop     si
   3074	0E7D  8B E5			     mov     sp,bp
   3075	0E7F  5D			     pop     bp
   3076	0E80  C3			     ret
   3077	0E81			     _sc_wait	     endp
   3078					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 55
scall.ASM



   3079					;    void sc_exit(int codfim)
   3080					;
   3081					     assume  cs:_TEXT
   3082	0E81			     _sc_exit	     proc    near
   3083	0E81  55			     push    bp
   3084	0E82  8B EC			     mov     bp,sp
   3085	0E84  83 EC 06			     sub     sp,6
   3086	0E87  56			     push    si
   3087	0E88  57			     push    di
   3088					;
   3089					;    {
   3090					;	     pcb_t pai,i,last,prevthread,nextthread;
   3091					;
   3092					;	     disable();
   3093					;
   3094	0E89  E8 0000e			     call    near ptr _disable
   3095					;
   3096					;	     /*	Verifica se não	esta' encerrando a thread 0 */
   3097					;	     if	     (miniSO_ready == 0)
   3098					;
   3099	0E8C  83 3E 0007r 00		     cmp     word ptr DGROUP:_miniSO_ready,0
   3100	0E91  75 08			     jne     short @25@86
   3101					;
   3102					;		     end_mso("exit(): thread 0 encerrada!");
   3103					;
   3104	0E93  B8 014Dr			     mov     ax,offset DGROUP:s@+195
   3105	0E96  50			     push    ax
   3106	0E97  E8 F5A3			     call    near ptr end_mso
   3107	0E9A  59			     pop     cx
   3108	0E9B			     @25@86:
   3109	0E9B  EB 41			     jmp     short @25@142
   3110	0E9D			     @25@114:
   3111					;
   3112					;	     /*	Trata os zumbis	do processo atual, colocando-os	na lista de livres */
   3113					;	     i = miniSO_thread[miniSO_ready].zombies;
   3114					;	     while   (i!= -1)  {
   3115					;		     miniSO_thread[miniSO_ready].zombies = miniSO_thread[i].next;
   3116					;
   3117	0E9D  8B C6			     mov     ax,si
   3118	0E9F  BA 001A			     mov     dx,26
   3119	0EA2  F7 EA			     imul    dx
   3120	0EA4  8B D8			     mov     bx,ax
   3121	0EA6  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3122	0EAA  50			     push    ax
   3123	0EAB  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3124	0EAE  BA 001A			     mov     dx,26
   3125	0EB1  F7 EA			     imul    dx
   3126	0EB3  8B D8			     mov     bx,ax
   3127	0EB5  58			     pop     ax
   3128	0EB6  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   3129					;
   3130					;		     miniSO_thread[i].next   = miniSO_free;
   3131					;
   3132	0EBA  8B C6			     mov     ax,si
   3133	0EBC  BA 001A			     mov     dx,26
   3134	0EBF  F7 EA			     imul    dx
   3135	0EC1  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 56
scall.ASM



   3136	0EC5  8B D8			     mov     bx,ax
   3137	0EC7  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3138					;
   3139					;		     miniSO_thread[i].status = FREE;
   3140					;
   3141	0ECB  8B C6			     mov     ax,si
   3142	0ECD  BA 001A			     mov     dx,26
   3143	0ED0  F7 EA			     imul    dx
   3144	0ED2  8B D8			     mov     bx,ax
   3145	0ED4  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3146					;
   3147					;		     miniSO_free	     = i;
   3148					;
   3149	0EDA  89 36 0009r		     mov     word ptr DGROUP:_miniSO_free,si
   3150					;
   3151					;		     i = miniSO_thread[miniSO_ready].zombies;
   3152					;
   3153	0EDE			     @25@142:
   3154	0EDE  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3155	0EE1  BA 001A			     mov     dx,26
   3156	0EE4  F7 EA			     imul    dx
   3157	0EE6  8B D8			     mov     bx,ax
   3158	0EE8  8B B7 001Br		     mov     si,word ptr DGROUP:_miniSO_thread[bx+20]
   3159	0EEC  83 FE FF			     cmp     si,-1
   3160	0EEF  75 AC			     jne     short @25@114
   3161					;
   3162					;	     }
   3163					;	     /*	Passa os filhos	do atual para o	processo 0 */
   3164					;	     for     (i=0;i<miniSO_MAXTHREADS;++i)  {
   3165					;
   3166	0EF1  33 F6			     xor     si,si
   3167	0EF3  EB 3F			     jmp     short @25@338
   3168	0EF5			     @25@226:
   3169					;
   3170					;		     if	     (miniSO_thread[i].status!=FREE && miniSO_thread[i].ppid ==	    +
   3171				     miniSO_thread[miniSO_ready].pid)
   3172					;
   3173	0EF5  8B C6			     mov     ax,si
   3174	0EF7  BA 001A			     mov     dx,26
   3175	0EFA  F7 EA			     imul    dx
   3176	0EFC  8B D8			     mov     bx,ax
   3177	0EFE  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3178	0F03  74 2E			     je	     short @25@310
   3179	0F05  8B C6			     mov     ax,si
   3180	0F07  BA 001A			     mov     dx,26
   3181	0F0A  F7 EA			     imul    dx
   3182	0F0C  8B D8			     mov     bx,ax
   3183	0F0E  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   3184	0F12  50			     push    ax
   3185	0F13  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3186	0F16  BA 001A			     mov     dx,26
   3187	0F19  F7 EA			     imul    dx
   3188	0F1B  8B D8			     mov     bx,ax
   3189	0F1D  58			     pop     ax
   3190	0F1E  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   3191	0F22  75 0F			     jne     short @25@310
   3192					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 57
scall.ASM



   3193					;			     miniSO_thread[i].ppid = 0;
   3194					;
   3195	0F24  8B C6			     mov     ax,si
   3196	0F26  BA 001A			     mov     dx,26
   3197	0F29  F7 EA			     imul    dx
   3198	0F2B  8B D8			     mov     bx,ax
   3199	0F2D  C7 87 0009r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+2],0
   3200	0F33			     @25@310:
   3201	0F33  46			     inc     si
   3202	0F34			     @25@338:
   3203	0F34  83 FE 10			     cmp     si,16
   3204	0F37  7C BC			     jl	     short @25@226
   3205					;
   3206					;	     }
   3207					;	     pai = get_pcb(miniSO_thread[miniSO_ready].ppid);
   3208					;
   3209	0F39  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3210	0F3C  BA 001A			     mov     dx,26
   3211	0F3F  F7 EA			     imul    dx
   3212	0F41  8B D8			     mov     bx,ax
   3213	0F43  FF B7 0009r		     push    word ptr DGROUP:_miniSO_thread[bx+2]
   3214	0F47  E8 F538			     call    near ptr get_pcb
   3215	0F4A  59			     pop     cx
   3216	0F4B  8B F8			     mov     di,ax
   3217					;
   3218					;	     if	     (pai==-1)
   3219					;
   3220	0F4D  83 FF FF			     cmp     di,-1
   3221	0F50  75 08			     jne     short @25@422
   3222					;
   3223					;		     end_mso("exit(): pai nao encontrado!");
   3224					;
   3225	0F52  B8 0169r			     mov     ax,offset DGROUP:s@+223
   3226	0F55  50			     push    ax
   3227	0F56  E8 F4E4			     call    near ptr end_mso
   3228	0F59  59			     pop     cx
   3229	0F5A			     @25@422:
   3230					;
   3231					;	     /*	Se o processo-pai esta'	esperando em wait/waitpid, coloca ele na lista de   +
   3232				     prontos */
   3233					;	     if	     ( miniSO_thread[pai].status==WAIT &&
   3234					;
   3235					;
   3236					;		       (miniSO_thread[pai].waitfor==-1 || miniSO_thread			    +
   3237				     [pai].waitfor==miniSO_ready) ) {
   3238					;
   3239	0F5A  8B C7			     mov     ax,di
   3240	0F5C  BA 001A			     mov     dx,26
   3241	0F5F  F7 EA			     imul    dx
   3242	0F61  8B D8			     mov     bx,ax
   3243	0F63  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   3244	0F68  74 03			     je	     @@5
   3245	0F6A  E9 0080			     jmp     @25@534
   3246	0F6D			     @@5:
   3247	0F6D  8B C7			     mov     ax,di
   3248	0F6F  BA 001A			     mov     dx,26
   3249	0F72  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 58
scall.ASM



   3250	0F74  8B D8			     mov     bx,ax
   3251	0F76  83 BF 0017r FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+16],-1
   3252	0F7B  74 13			     je	     short @25@506
   3253	0F7D  8B C7			     mov     ax,di
   3254	0F7F  BA 001A			     mov     dx,26
   3255	0F82  F7 EA			     imul    dx
   3256	0F84  8B D8			     mov     bx,ax
   3257	0F86  8B 87 0017r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+16]
   3258	0F8A  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   3259	0F8E  75 5D			     jne     short @25@534
   3260	0F90			     @25@506:
   3261					;
   3262					;		     /*	Descobre qual a	ultima thread */
   3263					;		     last = miniSO_thread[miniSO_ready].prev;
   3264					;
   3265	0F90  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3266	0F93  BA 001A			     mov     dx,26
   3267	0F96  F7 EA			     imul    dx
   3268	0F98  8B D8			     mov     bx,ax
   3269	0F9A  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3270	0F9E  89 46 FE			     mov     word ptr [bp-2],ax
   3271					;
   3272					;		     /*	Acerta links para incluir a thread no final da lista de	prontos*/
   3273					;		     miniSO_thread[pai].prev	       = last;
   3274					;
   3275	0FA1  8B C7			     mov     ax,di
   3276	0FA3  BA 001A			     mov     dx,26
   3277	0FA6  F7 EA			     imul    dx
   3278	0FA8  8B 56 FE			     mov     dx,word ptr [bp-2]
   3279	0FAB  8B D8			     mov     bx,ax
   3280	0FAD  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3281					;
   3282					;		     miniSO_thread[pai].next	       = miniSO_ready;
   3283					;
   3284	0FB1  8B C7			     mov     ax,di
   3285	0FB3  BA 001A			     mov     dx,26
   3286	0FB6  F7 EA			     imul    dx
   3287	0FB8  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3288	0FBC  8B D8			     mov     bx,ax
   3289	0FBE  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3290					;
   3291					;		     miniSO_thread[last].next	       = pai;
   3292					;
   3293	0FC2  8B 46 FE			     mov     ax,word ptr [bp-2]
   3294	0FC5  BA 001A			     mov     dx,26
   3295	0FC8  F7 EA			     imul    dx
   3296	0FCA  8B D8			     mov     bx,ax
   3297	0FCC  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   3298					;
   3299					;		     miniSO_thread[miniSO_ready].prev  = pai;
   3300					;
   3301	0FD0  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3302	0FD3  BA 001A			     mov     dx,26
   3303	0FD6  F7 EA			     imul    dx
   3304	0FD8  8B D8			     mov     bx,ax
   3305	0FDA  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   3306					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 59
scall.ASM



   3307					;		     miniSO_thread[pai].status	       = READY;
   3308					;
   3309	0FDE  8B C7			     mov     ax,di
   3310	0FE0  BA 001A			     mov     dx,26
   3311	0FE3  F7 EA			     imul    dx
   3312	0FE5  8B D8			     mov     bx,ax
   3313	0FE7  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   3314	0FED			     @25@534:
   3315					;
   3316					;	     }
   3317					;	     /*	Salva anterior e proximo da thread que sera deletada */
   3318					;	     prevthread	= miniSO_thread[miniSO_ready].prev;
   3319					;
   3320	0FED  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3321	0FF0  BA 001A			     mov     dx,26
   3322	0FF3  F7 EA			     imul    dx
   3323	0FF5  8B D8			     mov     bx,ax
   3324	0FF7  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3325	0FFB  89 46 FC			     mov     word ptr [bp-4],ax
   3326					;
   3327					;	     nextthread	= miniSO_thread[miniSO_ready].next;
   3328					;
   3329	0FFE  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3330	1001  BA 001A			     mov     dx,26
   3331	1004  F7 EA			     imul    dx
   3332	1006  8B D8			     mov     bx,ax
   3333	1008  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3334	100C  89 46 FA			     mov     word ptr [bp-6],ax
   3335					;
   3336					;	     if	     (miniSO_ready == nextthread)
   3337					;
   3338	100F  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3339	1012  3B 46 FA			     cmp     ax,word ptr [bp-6]
   3340	1015  75 08			     jne     short @25@590
   3341					;
   3342					;		     end_mso("exit(): nao ha' mais threads executando!");
   3343					;
   3344	1017  B8 0185r			     mov     ax,offset DGROUP:s@+251
   3345	101A  50			     push    ax
   3346	101B  E8 F41F			     call    near ptr end_mso
   3347	101E  59			     pop     cx
   3348	101F			     @25@590:
   3349					;
   3350					;	     /*	Exclui o nodo da lista de prontos */
   3351					;	     miniSO_thread[prevthread].next=nextthread;
   3352					;
   3353	101F  8B 46 FC			     mov     ax,word ptr [bp-4]
   3354	1022  BA 001A			     mov     dx,26
   3355	1025  F7 EA			     imul    dx
   3356	1027  8B 56 FA			     mov     dx,word ptr [bp-6]
   3357	102A  8B D8			     mov     bx,ax
   3358	102C  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3359					;
   3360					;	     miniSO_thread[nextthread].prev=prevthread;
   3361					;
   3362	1030  8B 46 FA			     mov     ax,word ptr [bp-6]
   3363	1033  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 60
scall.ASM



   3364	1036  F7 EA			     imul    dx
   3365	1038  8B 56 FC			     mov     dx,word ptr [bp-4]
   3366	103B  8B D8			     mov     bx,ax
   3367	103D  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3368					;
   3369					;	     if	     (miniSO_thread[pai].zombies==-1) {
   3370					;
   3371	1041  8B C7			     mov     ax,di
   3372	1043  BA 001A			     mov     dx,26
   3373	1046  F7 EA			     imul    dx
   3374	1048  8B D8			     mov     bx,ax
   3375	104A  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   3376	104F  75 23			     jne     short @25@646
   3377					;
   3378					;		     miniSO_thread[pai].zombies	= miniSO_ready;
   3379					;
   3380	1051  8B C7			     mov     ax,di
   3381	1053  BA 001A			     mov     dx,26
   3382	1056  F7 EA			     imul    dx
   3383	1058  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3384	105C  8B D8			     mov     bx,ax
   3385	105E  89 97 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],dx
   3386					;
   3387					;		     miniSO_thread[miniSO_ready].prev =	-1;
   3388					;
   3389	1062  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3390	1065  BA 001A			     mov     dx,26
   3391	1068  F7 EA			     imul    dx
   3392	106A  8B D8			     mov     bx,ax
   3393	106C  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3394					;
   3395					;	     }
   3396					;
   3397	1072  EB 4B			     jmp     short @25@758
   3398	1074			     @25@646:
   3399					;
   3400					;	     else    {
   3401					;		     i = miniSO_thread[pai].zombies;
   3402					;
   3403	1074  8B C7			     mov     ax,di
   3404	1076  BA 001A			     mov     dx,26
   3405	1079  F7 EA			     imul    dx
   3406	107B  8B D8			     mov     bx,ax
   3407	107D  8B B7 001Br		     mov     si,word ptr DGROUP:_miniSO_thread[bx+20]
   3408	1081  EB 0D			     jmp     short @25@702
   3409	1083			     @25@674:
   3410					;
   3411					;		     while   (miniSO_thread[i].next!=-1)
   3412					;			     i = miniSO_thread[i].next;
   3413					;
   3414	1083  8B C6			     mov     ax,si
   3415	1085  BA 001A			     mov     dx,26
   3416	1088  F7 EA			     imul    dx
   3417	108A  8B D8			     mov     bx,ax
   3418	108C  8B B7 001Fr		     mov     si,word ptr DGROUP:_miniSO_thread[bx+24]
   3419	1090			     @25@702:
   3420	1090  8B C6			     mov     ax,si
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 61
scall.ASM



   3421	1092  BA 001A			     mov     dx,26
   3422	1095  F7 EA			     imul    dx
   3423	1097  8B D8			     mov     bx,ax
   3424	1099  83 BF 001Fr FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3425	109E  75 E3			     jne     short @25@674
   3426					;
   3427					;		     miniSO_thread[i].next = miniSO_ready;
   3428					;
   3429	10A0  8B C6			     mov     ax,si
   3430	10A2  BA 001A			     mov     dx,26
   3431	10A5  F7 EA			     imul    dx
   3432	10A7  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3433	10AB  8B D8			     mov     bx,ax
   3434	10AD  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3435					;
   3436					;		     miniSO_thread[miniSO_ready].prev =	i;
   3437					;
   3438	10B1  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3439	10B4  BA 001A			     mov     dx,26
   3440	10B7  F7 EA			     imul    dx
   3441	10B9  8B D8			     mov     bx,ax
   3442	10BB  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   3443	10BF			     @25@758:
   3444					;
   3445					;	     }
   3446					;	     miniSO_thread[miniSO_ready].next =	-1;
   3447					;
   3448	10BF  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3449	10C2  BA 001A			     mov     dx,26
   3450	10C5  F7 EA			     imul    dx
   3451	10C7  8B D8			     mov     bx,ax
   3452	10C9  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3453					;
   3454					;	     miniSO_thread[miniSO_ready].status	= ZOMBIE;
   3455					;
   3456	10CF  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3457	10D2  BA 001A			     mov     dx,26
   3458	10D5  F7 EA			     imul    dx
   3459	10D7  8B D8			     mov     bx,ax
   3460	10D9  C7 87 000Br 0002		     mov     word ptr DGROUP:_miniSO_thread[bx+4],2
   3461					;
   3462					;	     miniSO_thread[miniSO_ready].exitcode = codfim;
   3463					;
   3464	10DF  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3465	10E2  BA 001A			     mov     dx,26
   3466	10E5  F7 EA			     imul    dx
   3467	10E7  8B 56 04			     mov     dx,word ptr [bp+4]
   3468	10EA  8B D8			     mov     bx,ax
   3469	10EC  89 97 0019r		     mov     word ptr DGROUP:_miniSO_thread[bx+18],dx
   3470					;
   3471					;	     miniSO_nextthread=nextthread;
   3472					;
   3473	10F0  8B 46 FA			     mov     ax,word ptr [bp-6]
   3474	10F3  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   3475					;
   3476					;	     miniSO_delcurthread=1;
   3477					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 62
scall.ASM



   3478	10F6  C6 06 0006r 01		     mov     byte ptr DGROUP:_miniSO_delcurthread,1
   3479					;
   3480					;	     enable();
   3481					;
   3482	10FB  E8 0000e			     call    near ptr _enable
   3483	10FE			     @25@786:
   3484	10FE  EB FE			     jmp     short @25@786
   3485					;
   3486					;	     while   (1)
   3487					;		     ;
   3488					;    }
   3489					;
   3490	1100  5F			     pop     di
   3491	1101  5E			     pop     si
   3492	1102  8B E5			     mov     sp,bp
   3493	1104  5D			     pop     bp
   3494	1105  C3			     ret
   3495	1106			     _sc_exit	     endp
   3496					;
   3497					;    pid_t sc_getpid()
   3498					;
   3499					     assume  cs:_TEXT
   3500	1106			     _sc_getpid	     proc    near
   3501	1106  55			     push    bp
   3502	1107  8B EC			     mov     bp,sp
   3503					;
   3504					;    {
   3505					;	     return miniSO_thread[miniSO_ready].pid;
   3506					;
   3507	1109  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3508	110C  BA 001A			     mov     dx,26
   3509	110F  F7 EA			     imul    dx
   3510	1111  8B D8			     mov     bx,ax
   3511	1113  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   3512	1117  EB 00			     jmp     short @26@58
   3513	1119			     @26@58:
   3514					;
   3515					;    }
   3516					;
   3517	1119  5D			     pop     bp
   3518	111A  C3			     ret
   3519	111B			     _sc_getpid	     endp
   3520					;
   3521					;    pid_t sc_getppid()
   3522					;
   3523					     assume  cs:_TEXT
   3524	111B			     _sc_getppid     proc    near
   3525	111B  55			     push    bp
   3526	111C  8B EC			     mov     bp,sp
   3527					;
   3528					;    {
   3529					;	     return miniSO_thread[miniSO_ready].ppid;
   3530					;
   3531	111E  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3532	1121  BA 001A			     mov     dx,26
   3533	1124  F7 EA			     imul    dx
   3534	1126  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 63
scall.ASM



   3535	1128  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   3536	112C  EB 00			     jmp     short @27@58
   3537	112E			     @27@58:
   3538					;
   3539					;    }
   3540					;
   3541	112E  5D			     pop     bp
   3542	112F  C3			     ret
   3543	1130			     _sc_getppid     endp
   3544					;
   3545					;    int sc_sendsignal(pid_t pid, signal_t signal)
   3546					;
   3547					     assume  cs:_TEXT
   3548	1130			     _sc_sendsignal  proc    near
   3549	1130  55			     push    bp
   3550	1131  8B EC			     mov     bp,sp
   3551	1133  56			     push    si
   3552	1134  57			     push    di
   3553					;
   3554					;    {
   3555					;	     pcb_t   pcb,last;
   3556					;
   3557					;	     disable();
   3558					;
   3559	1135  E8 0000e			     call    near ptr _disable
   3560					;
   3561					;	     /*	Tem que	verificar se existe a thread */
   3562					;	     pcb = get_pcb(pid);
   3563					;
   3564	1138  FF 76 04			     push    word ptr [bp+4]
   3565	113B  E8 F344			     call    near ptr get_pcb
   3566	113E  59			     pop     cx
   3567	113F  8B F0			     mov     si,ax
   3568					;
   3569					;	     /*	Se nao existe uma thread com este numero, entao	retorna	*/
   3570					;	     if	     (pcb==-1)	{
   3571					;
   3572	1141  83 FE FF			     cmp     si,-1
   3573	1144  75 09			     jne     short @28@114
   3574					;
   3575					;		     enable();
   3576					;
   3577	1146  E8 0000e			     call    near ptr _enable
   3578					;
   3579					;		     return miniSO_ERROR;
   3580					;
   3581	1149  B8 FFFF			     mov     ax,-1
   3582	114C			     @28@86:
   3583	114C  E9 00DD			     jmp     @28@226
   3584	114F			     @28@114:
   3585					;
   3586					;	     }
   3587					;	     /*	Seta os	sinais recebidos */
   3588					;	     miniSO_thread[pcb].recvsig	|= signal;
   3589					;
   3590	114F  8B C6			     mov     ax,si
   3591	1151  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 64
scall.ASM



   3592	1154  F7 EA			     imul    dx
   3593	1156  8B 56 06			     mov     dx,word ptr [bp+6]
   3594	1159  8B D8			     mov     bx,ax
   3595	115B  09 97 0011r		     or	     word ptr DGROUP:_miniSO_thread[bx+10],dx
   3596					;
   3597					;	     /*	A thread pode estar esperando pelos sinais ou nao */
   3598					;	     if	     (miniSO_thread[pcb].status	== WAITSIG)  {
   3599					;
   3600	115F  8B C6			     mov     ax,si
   3601	1161  BA 001A			     mov     dx,26
   3602	1164  F7 EA			     imul    dx
   3603	1166  8B D8			     mov     bx,ax
   3604	1168  83 BF 000Br 04		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],4
   3605	116D  74 03			     je	     @@6
   3606	116F  E9 00B1			     jmp     @28@198
   3607	1172			     @@6:
   3608					;
   3609					;		     /*	Verifica se a thread estava esperando pelo sinal */
   3610					;		     if	     ( (miniSO_thread[pcb].recvsig & miniSO_thread[pcb].waitsig) == +
   3611				     miniSO_thread[pcb].waitsig	)  {
   3612					;
   3613	1172  8B C6			     mov     ax,si
   3614	1174  BA 001A			     mov     dx,26
   3615	1177  F7 EA			     imul    dx
   3616	1179  8B D8			     mov     bx,ax
   3617	117B  8B 87 0011r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+10]
   3618	117F  50			     push    ax
   3619	1180  8B C6			     mov     ax,si
   3620	1182  BA 001A			     mov     dx,26
   3621	1185  F7 EA			     imul    dx
   3622	1187  8B D8			     mov     bx,ax
   3623	1189  58			     pop     ax
   3624	118A  23 87 0013r		     and     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3625	118E  50			     push    ax
   3626	118F  8B C6			     mov     ax,si
   3627	1191  BA 001A			     mov     dx,26
   3628	1194  F7 EA			     imul    dx
   3629	1196  8B D8			     mov     bx,ax
   3630	1198  58			     pop     ax
   3631	1199  3B 87 0013r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3632	119D  74 03			     je	     @@7
   3633	119F  E9 0081			     jmp     @28@198
   3634	11A2			     @@7:
   3635					;
   3636					;			     /*	O sinal	recebido e' suficiente para tirar a thread da espera+
   3637				     */
   3638					;			     last = miniSO_thread[miniSO_ready].prev;
   3639					;
   3640	11A2  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3641	11A5  BA 001A			     mov     dx,26
   3642	11A8  F7 EA			     imul    dx
   3643	11AA  8B D8			     mov     bx,ax
   3644	11AC  8B BF 001Dr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+22]
   3645					;
   3646					;			     miniSO_thread[pcb].prev = last;
   3647					;
   3648	11B0  8B C6			     mov     ax,si
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 65
scall.ASM



   3649	11B2  BA 001A			     mov     dx,26
   3650	11B5  F7 EA			     imul    dx
   3651	11B7  8B D8			     mov     bx,ax
   3652	11B9  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   3653					;
   3654					;			     miniSO_thread[last].next=pcb;
   3655					;
   3656	11BD  8B C7			     mov     ax,di
   3657	11BF  BA 001A			     mov     dx,26
   3658	11C2  F7 EA			     imul    dx
   3659	11C4  8B D8			     mov     bx,ax
   3660	11C6  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   3661					;
   3662					;			     miniSO_thread[miniSO_ready].prev=pcb;
   3663					;
   3664	11CA  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3665	11CD  BA 001A			     mov     dx,26
   3666	11D0  F7 EA			     imul    dx
   3667	11D2  8B D8			     mov     bx,ax
   3668	11D4  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   3669					;
   3670					;			     miniSO_thread[pcb].next=miniSO_ready;
   3671					;
   3672	11D8  8B C6			     mov     ax,si
   3673	11DA  BA 001A			     mov     dx,26
   3674	11DD  F7 EA			     imul    dx
   3675	11DF  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3676	11E3  8B D8			     mov     bx,ax
   3677	11E5  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3678					;
   3679					;			     miniSO_thread[pcb].status = READY;
   3680					;
   3681	11E9  8B C6			     mov     ax,si
   3682	11EB  BA 001A			     mov     dx,26
   3683	11EE  F7 EA			     imul    dx
   3684	11F0  8B D8			     mov     bx,ax
   3685	11F2  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   3686					;
   3687					;			     /*	Seta sinais recebidos e	sinais esperados */
   3688					;			     miniSO_thread[pcb].recvsig	^= miniSO_thread[pcb].waitsig;
   3689					;
   3690	11F8  8B C6			     mov     ax,si
   3691	11FA  BA 001A			     mov     dx,26
   3692	11FD  F7 EA			     imul    dx
   3693	11FF  8B D8			     mov     bx,ax
   3694	1201  8B 87 0013r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3695	1205  50			     push    ax
   3696	1206  8B C6			     mov     ax,si
   3697	1208  BA 001A			     mov     dx,26
   3698	120B  F7 EA			     imul    dx
   3699	120D  8B D8			     mov     bx,ax
   3700	120F  58			     pop     ax
   3701	1210  31 87 0011r		     xor     word ptr DGROUP:_miniSO_thread[bx+10],ax
   3702					;
   3703					;			     miniSO_thread[pcb].waitsig	= 0;
   3704					;
   3705	1214  8B C6			     mov     ax,si
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 66
scall.ASM



   3706	1216  BA 001A			     mov     dx,26
   3707	1219  F7 EA			     imul    dx
   3708	121B  8B D8			     mov     bx,ax
   3709	121D  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   3710	1223			     @28@198:
   3711					;
   3712					;		     }
   3713					;	     }
   3714					;	     enable();
   3715					;
   3716	1223  E8 0000e			     call    near ptr _enable
   3717					;
   3718					;	     return miniSO_OK;
   3719					;
   3720	1226  B8 0001			     mov     ax,1
   3721	1229  E9 FF20			     jmp     @28@86
   3722	122C			     @28@226:
   3723					;
   3724					;    }
   3725					;
   3726	122C  5F			     pop     di
   3727	122D  5E			     pop     si
   3728	122E  5D			     pop     bp
   3729	122F  C3			     ret
   3730	1230			     _sc_sendsignal  endp
   3731					;
   3732					;    int sc_waitsignal(signal_t	signal)
   3733					;
   3734					     assume  cs:_TEXT
   3735	1230			     _sc_waitsignal  proc    near
   3736	1230  55			     push    bp
   3737	1231  8B EC			     mov     bp,sp
   3738	1233  83 EC 06			     sub     sp,6
   3739	1236  56			     push    si
   3740	1237  57			     push    di
   3741	1238  8B 7E 04			     mov     di,word ptr [bp+4]
   3742					;
   3743					;    {
   3744					;	     pcb_t   pcb,prevthread,nextthread;
   3745					;	     int     waitint=0;
   3746					;
   3747	123B  C7 46 FA 0000		     mov     word ptr [bp-6],0
   3748					;
   3749					;
   3750					;	     disable();
   3751					;
   3752	1240  E8 0000e			     call    near ptr _disable
   3753					;
   3754					;	     pcb = miniSO_ready;
   3755					;
   3756	1243  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   3757					;
   3758					;	     /*	Verifica se ja'	nao recebeu os sinais */
   3759					;	     if	     ( (miniSO_thread[pcb].recvsig & signal) ==	signal )  {
   3760					;
   3761	1247  8B C6			     mov     ax,si
   3762	1249  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 67
scall.ASM



   3763	124C  F7 EA			     imul    dx
   3764	124E  8B D8			     mov     bx,ax
   3765	1250  8B 87 0011r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+10]
   3766	1254  23 C7			     and     ax,di
   3767	1256  3B C7			     cmp     ax,di
   3768	1258  75 1F			     jne     short @29@86
   3769					;
   3770					;		     /*	Ele ja'	recebeu	os sinais */
   3771					;		     miniSO_thread[pcb].recvsig	^= signal;
   3772					;
   3773	125A  8B C6			     mov     ax,si
   3774	125C  BA 001A			     mov     dx,26
   3775	125F  F7 EA			     imul    dx
   3776	1261  8B D8			     mov     bx,ax
   3777	1263  31 BF 0011r		     xor     word ptr DGROUP:_miniSO_thread[bx+10],di
   3778					;
   3779					;		     miniSO_thread[pcb].waitsig	= 0;
   3780					;
   3781	1267  8B C6			     mov     ax,si
   3782	1269  BA 001A			     mov     dx,26
   3783	126C  F7 EA			     imul    dx
   3784	126E  8B D8			     mov     bx,ax
   3785	1270  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   3786					;
   3787					;	     }
   3788					;
   3789	1276  E9 0094			     jmp     @29@170
   3790	1279			     @29@86:
   3791					;
   3792					;	     else    {
   3793					;		     /*	Ele ainda nao recebeu os sinais	e vai para a lista de espera */
   3794					;		     miniSO_thread[pcb].waitsig	= signal;
   3795					;
   3796	1279  8B C6			     mov     ax,si
   3797	127B  BA 001A			     mov     dx,26
   3798	127E  F7 EA			     imul    dx
   3799	1280  8B D8			     mov     bx,ax
   3800	1282  89 BF 0013r		     mov     word ptr DGROUP:_miniSO_thread[bx+12],di
   3801					;
   3802					;		     /*	Se eh a	ultima thread ... */
   3803					;		     prevthread	= miniSO_thread[pcb].prev;
   3804					;
   3805	1286  8B C6			     mov     ax,si
   3806	1288  BA 001A			     mov     dx,26
   3807	128B  F7 EA			     imul    dx
   3808	128D  8B D8			     mov     bx,ax
   3809	128F  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3810	1293  89 46 FE			     mov     word ptr [bp-2],ax
   3811					;
   3812					;		     nextthread	= miniSO_thread[pcb].next;
   3813					;
   3814	1296  8B C6			     mov     ax,si
   3815	1298  BA 001A			     mov     dx,26
   3816	129B  F7 EA			     imul    dx
   3817	129D  8B D8			     mov     bx,ax
   3818	129F  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3819	12A3  89 46 FC			     mov     word ptr [bp-4],ax
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 68
scall.ASM



   3820					;
   3821					;		     if	     (pcb == nextthread)
   3822					;
   3823	12A6  3B 76 FC			     cmp     si,word ptr [bp-4]
   3824	12A9  75 08			     jne     short @29@142
   3825					;
   3826					;			     end_mso("waitsignal(): nao	ha' mais threads executando!");
   3827					;
   3828	12AB  B8 01AEr			     mov     ax,offset DGROUP:s@+292
   3829	12AE  50			     push    ax
   3830	12AF  E8 F18B			     call    near ptr end_mso
   3831	12B2  59			     pop     cx
   3832	12B3			     @29@142:
   3833					;
   3834					;		     /*	Retira o BCP da	thread corrente	da lista de prontos */
   3835					;		     miniSO_thread[pcb].next = -1;
   3836					;
   3837	12B3  8B C6			     mov     ax,si
   3838	12B5  BA 001A			     mov     dx,26
   3839	12B8  F7 EA			     imul    dx
   3840	12BA  8B D8			     mov     bx,ax
   3841	12BC  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3842					;
   3843					;		     miniSO_thread[pcb].prev  =	-1;
   3844					;
   3845	12C2  8B C6			     mov     ax,si
   3846	12C4  BA 001A			     mov     dx,26
   3847	12C7  F7 EA			     imul    dx
   3848	12C9  8B D8			     mov     bx,ax
   3849	12CB  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3850					;
   3851					;		     /*	Exclui o nodo da lista de prontos */
   3852					;		     miniSO_thread[prevthread].next=nextthread;
   3853					;
   3854	12D1  8B 46 FE			     mov     ax,word ptr [bp-2]
   3855	12D4  BA 001A			     mov     dx,26
   3856	12D7  F7 EA			     imul    dx
   3857	12D9  8B 56 FC			     mov     dx,word ptr [bp-4]
   3858	12DC  8B D8			     mov     bx,ax
   3859	12DE  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3860					;
   3861					;		     miniSO_thread[nextthread].prev=prevthread;
   3862					;
   3863	12E2  8B 46 FC			     mov     ax,word ptr [bp-4]
   3864	12E5  BA 001A			     mov     dx,26
   3865	12E8  F7 EA			     imul    dx
   3866	12EA  8B 56 FE			     mov     dx,word ptr [bp-2]
   3867	12ED  8B D8			     mov     bx,ax
   3868	12EF  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3869					;
   3870					;		     miniSO_thread[pcb].status = WAITSIG;
   3871					;
   3872	12F3  8B C6			     mov     ax,si
   3873	12F5  BA 001A			     mov     dx,26
   3874	12F8  F7 EA			     imul    dx
   3875	12FA  8B D8			     mov     bx,ax
   3876	12FC  C7 87 000Br 0004		     mov     word ptr DGROUP:_miniSO_thread[bx+4],4
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 69
scall.ASM



   3877					;
   3878					;		     miniSO_nextthread=nextthread;
   3879					;
   3880	1302  8B 46 FC			     mov     ax,word ptr [bp-4]
   3881	1305  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   3882					;
   3883					;		     waitint=1;
   3884					;
   3885	1308  C7 46 FA 0001		     mov     word ptr [bp-6],1
   3886	130D			     @29@170:
   3887					;
   3888					;	     }
   3889					;	     enable();
   3890					;
   3891	130D  E8 0000e			     call    near ptr _enable
   3892					;
   3893					;	     if	     (waitint)
   3894					;
   3895	1310  83 7E FA 00		     cmp     word ptr [bp-6],0
   3896	1314  74 12			     je	     short @29@254
   3897	1316  EB 00			     jmp     short @29@226
   3898	1318			     @29@226:
   3899					;
   3900					;		     while   (miniSO_thread[pcb].status	== WAITSIG)
   3901					;
   3902	1318  8B C6			     mov     ax,si
   3903	131A  BA 001A			     mov     dx,26
   3904	131D  F7 EA			     imul    dx
   3905	131F  8B D8			     mov     bx,ax
   3906	1321  83 BF 000Br 04		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],4
   3907	1326  74 F0			     je	     short @29@226
   3908	1328			     @29@254:
   3909					;
   3910					;			     ;
   3911					;	     return 0;
   3912					;
   3913	1328  33 C0			     xor     ax,ax
   3914	132A  EB 00			     jmp     short @29@282
   3915	132C			     @29@282:
   3916					;
   3917					;    }
   3918					;
   3919	132C  5F			     pop     di
   3920	132D  5E			     pop     si
   3921	132E  8B E5			     mov     sp,bp
   3922	1330  5D			     pop     bp
   3923	1331  C3			     ret
   3924	1332			     _sc_waitsignal  endp
   3925					;
   3926					;    static int	get_sem_pos(semid_t s)
   3927					;
   3928					     assume  cs:_TEXT
   3929	1332			     get_sem_pos     proc    near
   3930	1332  55			     push    bp
   3931	1333  8B EC			     mov     bp,sp
   3932					;
   3933					;    {
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 70
scall.ASM



   3934					;	     int i;
   3935					;
   3936					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   3937					;
   3938	1335  33 D2			     xor     dx,dx
   3939	1337  EB 21			     jmp     short @30@198
   3940	1339			     @30@58:
   3941					;
   3942					;		     if	     (miniSO_sem[i].status!=FREE && miniSO_sem[i].semid==s)
   3943					;
   3944	1339  8B DA			     mov     bx,dx
   3945	133B  B1 03			     mov     cl,3
   3946	133D  D3 E3			     shl     bx,cl
   3947	133F  83 BF 01A7r FF		     cmp     word ptr DGROUP:_miniSO_sem[bx],-1
   3948	1344  74 13			     je	     short @30@170
   3949	1346  8B DA			     mov     bx,dx
   3950	1348  B1 03			     mov     cl,3
   3951	134A  D3 E3			     shl     bx,cl
   3952	134C  8B 87 01A9r		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+2]
   3953	1350  3B 46 04			     cmp     ax,word ptr [bp+4]
   3954	1353  75 04			     jne     short @30@170
   3955					;
   3956					;			     return i;
   3957					;
   3958	1355  8B C2			     mov     ax,dx
   3959	1357			     @30@142:
   3960	1357  EB 0B			     jmp     short @30@254
   3961	1359			     @30@170:
   3962	1359  42			     inc     dx
   3963	135A			     @30@198:
   3964	135A  83 FA 0A			     cmp     dx,10
   3965	135D  7C DA			     jl	     short @30@58
   3966					;
   3967					;	     return miniSO_ERROR;
   3968					;
   3969	135F  B8 FFFF			     mov     ax,-1
   3970	1362  EB F3			     jmp     short @30@142
   3971	1364			     @30@254:
   3972					;
   3973					;    }
   3974					;
   3975	1364  5D			     pop     bp
   3976	1365  C3			     ret
   3977	1366			     get_sem_pos     endp
   3978					;
   3979					;    semid_t sc_semcreate (int value)
   3980					;
   3981					     assume  cs:_TEXT
   3982	1366			     _sc_semcreate   proc    near
   3983	1366  55			     push    bp
   3984	1367  8B EC			     mov     bp,sp
   3985	1369  56			     push    si
   3986					;
   3987					;    {
   3988					;	     int i;
   3989					;	     semid_t s;
   3990					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 71
scall.ASM



   3991					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   3992					;
   3993	136A  33 F6			     xor     si,si
   3994	136C  EB 74 90			     jmp     @31@310
   3995	136F			     @31@58:
   3996					;
   3997					;		     if	     (miniSO_sem[i].status==FREE) {
   3998					;
   3999	136F  8B DE			     mov     bx,si
   4000	1371  B1 03			     mov     cl,3
   4001	1373  D3 E3			     shl     bx,cl
   4002	1375  83 BF 01A7r FF		     cmp     word ptr DGROUP:_miniSO_sem[bx],-1
   4003	137A  75 65			     jne     short @31@282
   4004	137C  EB 14			     jmp     short @31@198
   4005	137E			     @31@114:
   4006					;
   4007					;			     /*	Gera um	semid */
   4008					;			     while   (get_sem_pos(nextsemid)!=miniSO_ERROR) {
   4009					;				     if	     (nextsemid==32767)
   4010					;
   4011	137E  81 3E 0005r 7FFF		     cmp     word ptr DGROUP:nextsemid,32767
   4012	1384  75 08			     jne     short @31@170
   4013					;
   4014					;					     nextsemid = 0;
   4015					;
   4016	1386  C7 06 0005r 0000		     mov     word ptr DGROUP:nextsemid,0
   4017	138C  EB 04			     jmp     short @31@198
   4018	138E			     @31@170:
   4019					;
   4020					;				     else
   4021					;					     nextsemid++;
   4022					;
   4023	138E  FF 06 0005r		     inc     word ptr DGROUP:nextsemid
   4024	1392			     @31@198:
   4025	1392  FF 36 0005r		     push    word ptr DGROUP:nextsemid
   4026	1396  E8 FF99			     call    near ptr get_sem_pos
   4027	1399  59			     pop     cx
   4028	139A  3D FFFF			     cmp     ax,-1
   4029	139D  75 DF			     jne     short @31@114
   4030					;
   4031					;			     }
   4032					;			     miniSO_sem[i].status=READY;
   4033					;
   4034	139F  8B DE			     mov     bx,si
   4035	13A1  B1 03			     mov     cl,3
   4036	13A3  D3 E3			     shl     bx,cl
   4037	13A5  C7 87 01A7r 0000		     mov     word ptr DGROUP:_miniSO_sem[bx],0
   4038					;
   4039					;			     miniSO_sem[i].semid=nextsemid++;
   4040					;
   4041	13AB  8B DE			     mov     bx,si
   4042	13AD  B1 03			     mov     cl,3
   4043	13AF  D3 E3			     shl     bx,cl
   4044	13B1  A1 0005r			     mov     ax,word ptr DGROUP:nextsemid
   4045	13B4  89 87 01A9r		     mov     word ptr DGROUP:_miniSO_sem[bx+2],ax
   4046	13B8  FF 06 0005r		     inc     word ptr DGROUP:nextsemid
   4047					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 72
scall.ASM



   4048					;			     miniSO_sem[i].value=value;
   4049					;
   4050	13BC  8B DE			     mov     bx,si
   4051	13BE  B1 03			     mov     cl,3
   4052	13C0  D3 E3			     shl     bx,cl
   4053	13C2  8B 46 04			     mov     ax,word ptr [bp+4]
   4054	13C5  89 87 01ABr		     mov     word ptr DGROUP:_miniSO_sem[bx+4],ax
   4055					;
   4056					;			     miniSO_sem[i].queue=-1;
   4057					;
   4058	13C9  8B DE			     mov     bx,si
   4059	13CB  B1 03			     mov     cl,3
   4060	13CD  D3 E3			     shl     bx,cl
   4061	13CF  C7 87 01ADr FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4062					;
   4063					;			     return miniSO_sem[i].semid;
   4064					;
   4065	13D5  8B DE			     mov     bx,si
   4066	13D7  B1 03			     mov     cl,3
   4067	13D9  D3 E3			     shl     bx,cl
   4068	13DB  8B 87 01A9r		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+2]
   4069	13DF			     @31@254:
   4070	13DF  EB 0D			     jmp     short @31@366
   4071	13E1			     @31@282:
   4072	13E1  46			     inc     si
   4073	13E2			     @31@310:
   4074	13E2  83 FE 0A			     cmp     si,10
   4075	13E5  7D 02			     jge     @@8
   4076	13E7  EB 86			     jmp     @31@58
   4077	13E9			     @@8:
   4078					;
   4079					;		     }
   4080					;	     return miniSO_ERROR;
   4081					;
   4082	13E9  B8 FFFF			     mov     ax,-1
   4083	13EC  EB F1			     jmp     short @31@254
   4084	13EE			     @31@366:
   4085					;
   4086					;    }
   4087					;
   4088	13EE  5E			     pop     si
   4089	13EF  5D			     pop     bp
   4090	13F0  C3			     ret
   4091	13F1			     _sc_semcreate   endp
   4092					;
   4093					;    int sc_semset (semid_t s,int value)
   4094					;
   4095					     assume  cs:_TEXT
   4096	13F1			     _sc_semset	     proc    near
   4097	13F1  55			     push    bp
   4098	13F2  8B EC			     mov     bp,sp
   4099	13F4  56			     push    si
   4100					;
   4101					;    {
   4102					;	     int sem;
   4103					;
   4104					;	     sem = get_sem_pos(s);
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 73
scall.ASM



   4105					;
   4106	13F5  FF 76 04			     push    word ptr [bp+4]
   4107	13F8  E8 FF37			     call    near ptr get_sem_pos
   4108	13FB  59			     pop     cx
   4109	13FC  8B F0			     mov     si,ax
   4110					;
   4111					;	     if	     (sem==miniSO_ERROR	|| miniSO_sem[sem].queue!=-1)
   4112					;
   4113	13FE  83 FE FF			     cmp     si,-1
   4114	1401  74 0D			     je	     short @32@86
   4115	1403  8B DE			     mov     bx,si
   4116	1405  B1 03			     mov     cl,3
   4117	1407  D3 E3			     shl     bx,cl
   4118	1409  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4119	140E  74 05			     je	     short @32@142
   4120	1410			     @32@86:
   4121					;
   4122					;		     return miniSO_ERROR;
   4123					;
   4124	1410  B8 FFFF			     mov     ax,-1
   4125	1413			     @32@114:
   4126	1413  EB 12			     jmp     short @32@170
   4127	1415			     @32@142:
   4128					;
   4129					;	     miniSO_sem[sem].value = value;
   4130					;
   4131	1415  8B DE			     mov     bx,si
   4132	1417  B1 03			     mov     cl,3
   4133	1419  D3 E3			     shl     bx,cl
   4134	141B  8B 46 06			     mov     ax,word ptr [bp+6]
   4135	141E  89 87 01ABr		     mov     word ptr DGROUP:_miniSO_sem[bx+4],ax
   4136					;
   4137					;	     return miniSO_OK;
   4138					;
   4139	1422  B8 0001			     mov     ax,1
   4140	1425  EB EC			     jmp     short @32@114
   4141	1427			     @32@170:
   4142					;
   4143					;    }
   4144					;
   4145	1427  5E			     pop     si
   4146	1428  5D			     pop     bp
   4147	1429  C3			     ret
   4148	142A			     _sc_semset	     endp
   4149					;
   4150					;    int sc_semup (semid_t s)
   4151					;
   4152					     assume  cs:_TEXT
   4153	142A			     _sc_semup	     proc    near
   4154	142A  55			     push    bp
   4155	142B  8B EC			     mov     bp,sp
   4156	142D  83 EC 02			     sub     sp,2
   4157	1430  56			     push    si
   4158	1431  57			     push    di
   4159					;
   4160					;    {
   4161					;	     int sem;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 74
scall.ASM



   4162					;	     pcb_t pcb,last,prevthread,nextthread;
   4163					;
   4164					;	     disable();
   4165					;
   4166	1432  E8 0000e			     call    near ptr _disable
   4167					;
   4168					;	     sem = get_sem_pos(s);
   4169					;
   4170	1435  FF 76 04			     push    word ptr [bp+4]
   4171	1438  E8 FEF7			     call    near ptr get_sem_pos
   4172	143B  59			     pop     cx
   4173	143C  8B F0			     mov     si,ax
   4174					;
   4175					;	     if	     (sem==miniSO_ERROR) {
   4176					;
   4177	143E  83 FE FF			     cmp     si,-1
   4178	1441  75 09			     jne     short @33@114
   4179					;
   4180					;		     enable();
   4181					;
   4182	1443  E8 0000e			     call    near ptr _enable
   4183					;
   4184					;		     return miniSO_ERROR;
   4185					;
   4186	1446  B8 FFFF			     mov     ax,-1
   4187	1449			     @33@86:
   4188	1449  E9 00C5			     jmp     @33@254
   4189	144C			     @33@114:
   4190					;
   4191					;	     }
   4192					;	     miniSO_sem[sem].value++;
   4193					;
   4194	144C  8B DE			     mov     bx,si
   4195	144E  B1 03			     mov     cl,3
   4196	1450  D3 E3			     shl     bx,cl
   4197	1452  FF 87 01ABr		     inc     word ptr DGROUP:_miniSO_sem[bx+4]
   4198					;
   4199					;	     if	     (miniSO_sem[sem].queue!=-1) {
   4200					;
   4201	1456  8B DE			     mov     bx,si
   4202	1458  B1 03			     mov     cl,3
   4203	145A  D3 E3			     shl     bx,cl
   4204	145C  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4205	1461  75 03			     jne     @@9
   4206	1463  E9 00A2			     jmp     @33@226
   4207	1466			     @@9:
   4208					;
   4209					;		     pcb = miniSO_sem[sem].queue;
   4210					;
   4211	1466  8B DE			     mov     bx,si
   4212	1468  B1 03			     mov     cl,3
   4213	146A  D3 E3			     shl     bx,cl
   4214	146C  8B BF 01ADr		     mov     di,word ptr DGROUP:_miniSO_sem[bx+6]
   4215					;
   4216					;		     miniSO_sem[sem].queue = miniSO_thread[pcb].next;
   4217					;
   4218	1470  8B C7			     mov     ax,di
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 75
scall.ASM



   4219	1472  BA 001A			     mov     dx,26
   4220	1475  F7 EA			     imul    dx
   4221	1477  8B D8			     mov     bx,ax
   4222	1479  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4223	147D  8B DE			     mov     bx,si
   4224	147F  B1 03			     mov     cl,3
   4225	1481  D3 E3			     shl     bx,cl
   4226	1483  89 87 01ADr		     mov     word ptr DGROUP:_miniSO_sem[bx+6],ax
   4227					;
   4228					;		     if	     (miniSO_sem[sem].queue!=-1)
   4229					;
   4230	1487  8B DE			     mov     bx,si
   4231	1489  B1 03			     mov     cl,3
   4232	148B  D3 E3			     shl     bx,cl
   4233	148D  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4234	1492  74 17			     je	     short @33@198
   4235					;
   4236					;			     miniSO_thread[miniSO_sem[sem].queue].prev = -1;
   4237					;
   4238	1494  8B DE			     mov     bx,si
   4239	1496  B1 03			     mov     cl,3
   4240	1498  D3 E3			     shl     bx,cl
   4241	149A  8B 87 01ADr		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+6]
   4242	149E  BA 001A			     mov     dx,26
   4243	14A1  F7 EA			     imul    dx
   4244	14A3  8B D8			     mov     bx,ax
   4245	14A5  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4246	14AB			     @33@198:
   4247					;
   4248					;		     last = miniSO_thread[miniSO_ready].prev;
   4249					;
   4250	14AB  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4251	14AE  BA 001A			     mov     dx,26
   4252	14B1  F7 EA			     imul    dx
   4253	14B3  8B D8			     mov     bx,ax
   4254	14B5  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   4255	14B9  89 46 FE			     mov     word ptr [bp-2],ax
   4256					;
   4257					;		     miniSO_thread[pcb].prev = last;
   4258					;
   4259	14BC  8B C7			     mov     ax,di
   4260	14BE  BA 001A			     mov     dx,26
   4261	14C1  F7 EA			     imul    dx
   4262	14C3  8B 56 FE			     mov     dx,word ptr [bp-2]
   4263	14C6  8B D8			     mov     bx,ax
   4264	14C8  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4265					;
   4266					;		     miniSO_thread[last].next=pcb;
   4267					;
   4268	14CC  8B 46 FE			     mov     ax,word ptr [bp-2]
   4269	14CF  BA 001A			     mov     dx,26
   4270	14D2  F7 EA			     imul    dx
   4271	14D4  8B D8			     mov     bx,ax
   4272	14D6  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   4273					;
   4274					;		     miniSO_thread[miniSO_ready].prev=pcb;
   4275					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 76
scall.ASM



   4276	14DA  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4277	14DD  BA 001A			     mov     dx,26
   4278	14E0  F7 EA			     imul    dx
   4279	14E2  8B D8			     mov     bx,ax
   4280	14E4  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   4281					;
   4282					;		     miniSO_thread[pcb].next=miniSO_ready;
   4283					;
   4284	14E8  8B C7			     mov     ax,di
   4285	14EA  BA 001A			     mov     dx,26
   4286	14ED  F7 EA			     imul    dx
   4287	14EF  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   4288	14F3  8B D8			     mov     bx,ax
   4289	14F5  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4290					;
   4291					;		     miniSO_thread[pcb].status = READY;
   4292					;
   4293	14F9  8B C7			     mov     ax,di
   4294	14FB  BA 001A			     mov     dx,26
   4295	14FE  F7 EA			     imul    dx
   4296	1500  8B D8			     mov     bx,ax
   4297	1502  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   4298	1508			     @33@226:
   4299					;
   4300					;	     }
   4301					;	     enable();
   4302					;
   4303	1508  E8 0000e			     call    near ptr _enable
   4304					;
   4305					;	     return miniSO_OK;
   4306					;
   4307	150B  B8 0001			     mov     ax,1
   4308	150E  E9 FF38			     jmp     @33@86
   4309	1511			     @33@254:
   4310					;
   4311					;    }
   4312					;
   4313	1511  5F			     pop     di
   4314	1512  5E			     pop     si
   4315	1513  8B E5			     mov     sp,bp
   4316	1515  5D			     pop     bp
   4317	1516  C3			     ret
   4318	1517			     _sc_semup	     endp
   4319					;
   4320					;    int sc_semdown (semid_t s)
   4321					;
   4322					     assume  cs:_TEXT
   4323	1517			     _sc_semdown     proc    near
   4324	1517  55			     push    bp
   4325	1518  8B EC			     mov     bp,sp
   4326	151A  83 EC 08			     sub     sp,8
   4327	151D  56			     push    si
   4328	151E  57			     push    di
   4329					;
   4330					;    {
   4331					;	     int sem;
   4332					;	     pcb_t pcb,ant,i,prevthread,nextthread;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 77
scall.ASM



   4333					;
   4334					;	     disable();
   4335					;
   4336	151F  E8 0000e			     call    near ptr _disable
   4337					;
   4338					;	     sem = get_sem_pos(s);
   4339					;
   4340	1522  FF 76 04			     push    word ptr [bp+4]
   4341	1525  E8 FE0A			     call    near ptr get_sem_pos
   4342	1528  59			     pop     cx
   4343	1529  8B F8			     mov     di,ax
   4344					;
   4345					;	     if	     (sem==miniSO_ERROR) {
   4346					;
   4347	152B  83 FF FF			     cmp     di,-1
   4348	152E  75 09			     jne     short @34@114
   4349					;
   4350					;		     enable();
   4351					;
   4352	1530  E8 0000e			     call    near ptr _enable
   4353					;
   4354					;		     return miniSO_ERROR;
   4355					;
   4356	1533  B8 FFFF			     mov     ax,-1
   4357	1536			     @34@86:
   4358	1536  E9 011E			     jmp     @34@534
   4359	1539			     @34@114:
   4360					;
   4361					;	     }
   4362					;	     miniSO_sem[sem].value--;
   4363					;
   4364	1539  8B DF			     mov     bx,di
   4365	153B  B1 03			     mov     cl,3
   4366	153D  D3 E3			     shl     bx,cl
   4367	153F  FF 8F 01ABr		     dec     word ptr DGROUP:_miniSO_sem[bx+4]
   4368					;
   4369					;	     if	     (miniSO_sem[sem].value<0) {
   4370					;
   4371	1543  8B DF			     mov     bx,di
   4372	1545  B1 03			     mov     cl,3
   4373	1547  D3 E3			     shl     bx,cl
   4374	1549  83 BF 01ABr 00		     cmp     word ptr DGROUP:_miniSO_sem[bx+4],0
   4375	154E  7C 03			     jl	     @@10
   4376	1550  E9 00FB			     jmp     @34@478
   4377	1553			     @@10:
   4378					;
   4379					;		     pcb = miniSO_ready;
   4380					;
   4381	1553  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   4382					;
   4383					;		     prevthread	= miniSO_thread[pcb].prev;
   4384					;
   4385	1557  8B C6			     mov     ax,si
   4386	1559  BA 001A			     mov     dx,26
   4387	155C  F7 EA			     imul    dx
   4388	155E  8B D8			     mov     bx,ax
   4389	1560  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 78
scall.ASM



   4390	1564  89 46 FA			     mov     word ptr [bp-6],ax
   4391					;
   4392					;		     nextthread	= miniSO_thread[pcb].next;
   4393					;
   4394	1567  8B C6			     mov     ax,si
   4395	1569  BA 001A			     mov     dx,26
   4396	156C  F7 EA			     imul    dx
   4397	156E  8B D8			     mov     bx,ax
   4398	1570  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4399	1574  89 46 F8			     mov     word ptr [bp-8],ax
   4400					;
   4401					;		     /*	Se eh a	ultima thread ... */
   4402					;		     if	     (pcb == nextthread)
   4403					;
   4404	1577  3B 76 F8			     cmp     si,word ptr [bp-8]
   4405	157A  75 08			     jne     short @34@198
   4406					;
   4407					;			     end_mso("semdown(): nao ha' mais threads executando!");
   4408					;
   4409	157C  B8 01DDr			     mov     ax,offset DGROUP:s@+339
   4410	157F  50			     push    ax
   4411	1580  E8 EEBA			     call    near ptr end_mso
   4412	1583  59			     pop     cx
   4413	1584			     @34@198:
   4414					;
   4415					;		     /*	Coloca o BCP da	thread no final	da lista de espera do semaforo */
   4416					;		     ant = -1;
   4417					;
   4418	1584  C7 46 FE FFFF		     mov     word ptr [bp-2],-1
   4419					;
   4420					;		     i = miniSO_sem[sem].queue;
   4421					;
   4422	1589  8B DF			     mov     bx,di
   4423	158B  B1 03			     mov     cl,3
   4424	158D  D3 E3			     shl     bx,cl
   4425	158F  8B 87 01ADr		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+6]
   4426	1593  EB 14			     jmp     short @34@254
   4427	1595			     @34@226:
   4428					;
   4429					;		     while   (i!=-1) {
   4430					;			     ant = i;
   4431					;
   4432	1595  8B 46 FC			     mov     ax,word ptr [bp-4]
   4433	1598  89 46 FE			     mov     word ptr [bp-2],ax
   4434					;
   4435					;			     i = miniSO_thread[i].next;
   4436					;
   4437	159B  8B 46 FC			     mov     ax,word ptr [bp-4]
   4438	159E  BA 001A			     mov     dx,26
   4439	15A1  F7 EA			     imul    dx
   4440	15A3  8B D8			     mov     bx,ax
   4441	15A5  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4442	15A9			     @34@254:
   4443	15A9  89 46 FC			     mov     word ptr [bp-4],ax
   4444	15AC  83 7E FC FF		     cmp     word ptr [bp-4],-1
   4445	15B0  75 E3			     jne     short @34@226
   4446					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 79
scall.ASM



   4447					;		     }
   4448					;		     if	     (ant==-1) {
   4449					;
   4450	15B2  83 7E FE FF		     cmp     word ptr [bp-2],-1
   4451	15B6  75 1B			     jne     short @34@366
   4452					;
   4453					;			     miniSO_sem[sem].queue = pcb;
   4454					;
   4455	15B8  8B DF			     mov     bx,di
   4456	15BA  B1 03			     mov     cl,3
   4457	15BC  D3 E3			     shl     bx,cl
   4458	15BE  89 B7 01ADr		     mov     word ptr DGROUP:_miniSO_sem[bx+6],si
   4459					;
   4460					;			     miniSO_thread[pcb].prev = -1;
   4461					;
   4462	15C2  8B C6			     mov     ax,si
   4463	15C4  BA 001A			     mov     dx,26
   4464	15C7  F7 EA			     imul    dx
   4465	15C9  8B D8			     mov     bx,ax
   4466	15CB  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4467					;
   4468					;		     }
   4469					;
   4470	15D1  EB 1E			     jmp     short @34@394
   4471	15D3			     @34@366:
   4472					;
   4473					;		     else {
   4474					;			     miniSO_thread[ant].next = pcb;
   4475					;
   4476	15D3  8B 46 FE			     mov     ax,word ptr [bp-2]
   4477	15D6  BA 001A			     mov     dx,26
   4478	15D9  F7 EA			     imul    dx
   4479	15DB  8B D8			     mov     bx,ax
   4480	15DD  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   4481					;
   4482					;			     miniSO_thread[pcb].prev = ant;
   4483					;
   4484	15E1  8B C6			     mov     ax,si
   4485	15E3  BA 001A			     mov     dx,26
   4486	15E6  F7 EA			     imul    dx
   4487	15E8  8B 56 FE			     mov     dx,word ptr [bp-2]
   4488	15EB  8B D8			     mov     bx,ax
   4489	15ED  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4490	15F1			     @34@394:
   4491					;
   4492					;		     }
   4493					;		     miniSO_thread[pcb].next = -1;
   4494					;
   4495	15F1  8B C6			     mov     ax,si
   4496	15F3  BA 001A			     mov     dx,26
   4497	15F6  F7 EA			     imul    dx
   4498	15F8  8B D8			     mov     bx,ax
   4499	15FA  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   4500					;
   4501					;		     /*	Exclui o nodo da lista de prontos */
   4502					;		     miniSO_thread[prevthread].next=nextthread;
   4503					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 80
scall.ASM



   4504	1600  8B 46 FA			     mov     ax,word ptr [bp-6]
   4505	1603  BA 001A			     mov     dx,26
   4506	1606  F7 EA			     imul    dx
   4507	1608  8B 56 F8			     mov     dx,word ptr [bp-8]
   4508	160B  8B D8			     mov     bx,ax
   4509	160D  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4510					;
   4511					;		     miniSO_thread[nextthread].prev=prevthread;
   4512					;
   4513	1611  8B 46 F8			     mov     ax,word ptr [bp-8]
   4514	1614  BA 001A			     mov     dx,26
   4515	1617  F7 EA			     imul    dx
   4516	1619  8B 56 FA			     mov     dx,word ptr [bp-6]
   4517	161C  8B D8			     mov     bx,ax
   4518	161E  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4519					;
   4520					;		     miniSO_thread[pcb].status = WAITSEM;
   4521					;
   4522	1622  8B C6			     mov     ax,si
   4523	1624  BA 001A			     mov     dx,26
   4524	1627  F7 EA			     imul    dx
   4525	1629  8B D8			     mov     bx,ax
   4526	162B  C7 87 000Br 0005		     mov     word ptr DGROUP:_miniSO_thread[bx+4],5
   4527					;
   4528					;		     miniSO_nextthread=nextthread;
   4529					;
   4530	1631  8B 46 F8			     mov     ax,word ptr [bp-8]
   4531	1634  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   4532					;
   4533					;		     enable();
   4534					;
   4535	1637  E8 0000e			     call    near ptr _enable
   4536	163A  EB 00			     jmp     short @34@422
   4537	163C			     @34@422:
   4538					;
   4539					;		     while   (miniSO_thread[pcb].status	== WAITSEM)
   4540					;
   4541	163C  8B C6			     mov     ax,si
   4542	163E  BA 001A			     mov     dx,26
   4543	1641  F7 EA			     imul    dx
   4544	1643  8B D8			     mov     bx,ax
   4545	1645  83 BF 000Br 05		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],5
   4546	164A  74 F0			     je	     short @34@422
   4547					;
   4548					;			     ;
   4549					;	     }
   4550					;
   4551	164C  EB 03			     jmp     short @34@506
   4552	164E			     @34@478:
   4553					;
   4554					;	     else
   4555					;		     enable();
   4556					;
   4557	164E  E8 0000e			     call    near ptr _enable
   4558	1651			     @34@506:
   4559					;
   4560					;	     return miniSO_OK;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 81
scall.ASM



   4561					;
   4562	1651  B8 0001			     mov     ax,1
   4563	1654  E9 FEDF			     jmp     @34@86
   4564	1657			     @34@534:
   4565					;
   4566					;    }
   4567					;
   4568	1657  5F			     pop     di
   4569	1658  5E			     pop     si
   4570	1659  8B E5			     mov     sp,bp
   4571	165B  5D			     pop     bp
   4572	165C  C3			     ret
   4573	165D			     _sc_semdown     endp
   4574					;
   4575					;    int sc_semdestroy (semid_t	s)
   4576					;
   4577					     assume  cs:_TEXT
   4578	165D			     _sc_semdestroy  proc    near
   4579	165D  55			     push    bp
   4580	165E  8B EC			     mov     bp,sp
   4581	1660  56			     push    si
   4582					;
   4583					;    {
   4584					;	     int sem;
   4585					;
   4586					;	     sem = get_sem_pos(s);
   4587					;
   4588	1661  FF 76 04			     push    word ptr [bp+4]
   4589	1664  E8 FCCB			     call    near ptr get_sem_pos
   4590	1667  59			     pop     cx
   4591	1668  8B F0			     mov     si,ax
   4592					;
   4593					;	     if	     (sem==miniSO_ERROR	|| miniSO_sem[sem].queue!=-1)
   4594					;
   4595	166A  83 FE FF			     cmp     si,-1
   4596	166D  74 0D			     je	     short @35@86
   4597	166F  8B DE			     mov     bx,si
   4598	1671  B1 03			     mov     cl,3
   4599	1673  D3 E3			     shl     bx,cl
   4600	1675  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4601	167A  74 05			     je	     short @35@142
   4602	167C			     @35@86:
   4603					;
   4604					;		     return miniSO_ERROR;
   4605					;
   4606	167C  B8 FFFF			     mov     ax,-1
   4607	167F			     @35@114:
   4608	167F  EB 11			     jmp     short @35@170
   4609	1681			     @35@142:
   4610					;
   4611					;	     miniSO_sem[sem].status = FREE;
   4612					;
   4613	1681  8B DE			     mov     bx,si
   4614	1683  B1 03			     mov     cl,3
   4615	1685  D3 E3			     shl     bx,cl
   4616	1687  C7 87 01A7r FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx],-1
   4617					;
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 82
scall.ASM



   4618					;	     return miniSO_OK;
   4619					;
   4620	168D  B8 0001			     mov     ax,1
   4621	1690  EB ED			     jmp     short @35@114
   4622	1692			     @35@170:
   4623					;
   4624					;    }
   4625					;
   4626	1692  5E			     pop     si
   4627	1693  5D			     pop     bp
   4628	1694  C3			     ret
   4629	1695			     _sc_semdestroy  endp
   4630	1695			     _TEXT   ends
   4631	0000			     _BSS    segment word public 'BSS'
   4632	0000			     _miniSO_oldisr  label   dword
   4633	0000  04*(??)			     db	     4 dup (?)
   4634	0004			     _miniSO_nextthread	     label   word
   4635	0004  02*(??)			     db	     2 dup (?)
   4636	0006			     _miniSO_delcurthread    label   byte
   4637	0006  01*(??)			     db	     1 dup (?)
   4638	0007			     _miniSO_thread  label   word
   4639	0007  01A0*(??)			     db	     416 dup (?)
   4640	01A7			     _miniSO_sem     label   word
   4641	01A7  50*(??)			     db	     80	dup (?)
   4642					     ?debug  C E9
   4643					     ?debug  C FA00000000
   4644	01F7			     _BSS    ends
   4645	008A			     _DATA   segment word public 'DATA'
   4646	008A			     s@	     label   byte
   4647	008A  0A			     db	     10
   4648	008B  0A			     db	     10
   4649	008C  00			     db	     0
   4650	008D  50 72 65 73 73 69	6F+	     db	     'Pressione	uma tecla para reiniciar...'
   4651	      6E 65 20 75 6D 61	20+
   4652	      74 65 63 6C 61 20	70+
   4653	      61 72 61 20 72 65	69+
   4654	      6E 69 63 69 61 72	2E+
   4655	      2E 2E
   4656	00B2  0A			     db	     10
   4657	00B3  00			     db	     0
   4658	00B4  6B 69 6C 6C 28 29	3A+	     db	     'kill(): thread 0 excluida!'
   4659	      20 74 68 72 65 61	64+
   4660	      20 30 20 65 78 63	6C+
   4661	      75 69 64 61 21
   4662	00CE  00			     db	     0
   4663	00CF  6B 69 6C 6C 28 29	3A+	     db	     'kill(): nao ha'
   4664	      20 6E 61 6F 20 68	61
   4665	00DD  27			     db	     39
   4666	00DE  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4667	      68 72 65 61 64 73	20+
   4668	      65 78 65 63 75 74	61+
   4669	      6E 64 6F 21
   4670	00F7  00			     db	     0
   4671	00F8  77 61 69 74 70 69	64+	     db	     'waitpid(): nao ha'
   4672	      28 29 3A 20 6E 61	6F+
   4673	      20 68 61
   4674	0109  27			     db	     39
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 83
scall.ASM



   4675	010A  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4676	      68 72 65 61 64 73	20+
   4677	      65 78 65 63 75 74	61+
   4678	      6E 64 6F 21
   4679	0123  00			     db	     0
   4680	0124  77 61 69 74 28 29	3A+	     db	     'wait(): nao ha'
   4681	      20 6E 61 6F 20 68	61
   4682	0132  27			     db	     39
   4683	0133  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4684	      68 72 65 61 64 73	20+
   4685	      65 78 65 63 75 74	61+
   4686	      6E 64 6F 21
   4687	014C  00			     db	     0
   4688	014D  65 78 69 74 28 29	3A+	     db	     'exit(): thread 0 encerrada!'
   4689	      20 74 68 72 65 61	64+
   4690	      20 30 20 65 6E 63	65+
   4691	      72 72 61 64 61 21
   4692	0168  00			     db	     0
   4693	0169  65 78 69 74 28 29	3A+	     db	     'exit(): pai nao encontrado!'
   4694	      20 70 61 69 20 6E	61+
   4695	      6F 20 65 6E 63 6F	6E+
   4696	      74 72 61 64 6F 21
   4697	0184  00			     db	     0
   4698	0185  65 78 69 74 28 29	3A+	     db	     'exit(): nao ha'
   4699	      20 6E 61 6F 20 68	61
   4700	0193  27			     db	     39
   4701	0194  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4702	      68 72 65 61 64 73	20+
   4703	      65 78 65 63 75 74	61+
   4704	      6E 64 6F 21
   4705	01AD  00			     db	     0
   4706	01AE  77 61 69 74 73 69	67+	     db	     'waitsignal(): nao	ha'
   4707	      6E 61 6C 28 29 3A	20+
   4708	      6E 61 6F 20 68 61
   4709	01C2  27			     db	     39
   4710	01C3  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4711	      68 72 65 61 64 73	20+
   4712	      65 78 65 63 75 74	61+
   4713	      6E 64 6F 21
   4714	01DC  00			     db	     0
   4715	01DD  73 65 6D 64 6F 77	6E+	     db	     'semdown(): nao ha'
   4716	      28 29 3A 20 6E 61	6F+
   4717	      20 68 61
   4718	01EE  27			     db	     39
   4719	01EF  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4720	      68 72 65 61 64 73	20+
   4721	      65 78 65 63 75 74	61+
   4722	      6E 64 6F 21
   4723	0208  00			     db	     0
   4724	0209			     _DATA   ends
   4725	1695			     _TEXT   segment byte public 'CODE'
   4726	1695			     _TEXT   ends
   4727				     _get_sem_pos    equ     get_sem_pos
   4728					     extrn   _miniSO_return_addr:near
   4729					     public  _miniSO_contextswitch
   4730					     public  _scall
   4731				     _get_pcb	     equ     get_pcb
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 84
scall.ASM



   4732				     _end_mso	     equ     end_mso
   4733				     _scroll equ     scroll
   4734				     _getCursorPosition	     equ     getCursorPosition
   4735				     _setCursorPosition	     equ     setCursorPosition
   4736					     public  _miniSO_scall_table
   4737					     public  _miniSO_oldisr
   4738					     public  _miniSO_nextthread
   4739					     public  _miniSO_delcurthread
   4740					     public  _miniSO_free
   4741					     public  _miniSO_ready
   4742					     public  _miniSO_thread
   4743				     _nextsemid	     equ     nextsemid
   4744					     public  _miniSO_sem
   4745				     _miniSO_key     equ     miniSO_key
   4746				     _miniSO_iskey   equ     miniSO_iskey
   4747				     _miniSO_pag     equ     miniSO_pag
   4748				     _miniSO_cor     equ     miniSO_cor
   4749				     _miniSO_col     equ     miniSO_col
   4750					     extrn   _putstr:near
   4751					     extrn   _getch:near
   4752					     extrn   _putch:near
   4753					     public  _sc_semdestroy
   4754					     public  _sc_semdown
   4755					     public  _sc_semup
   4756					     public  _sc_semset
   4757					     public  _sc_semcreate
   4758					     public  _sc_waitsignal
   4759					     public  _sc_sendsignal
   4760					     public  _sc_getppid
   4761					     public  _sc_getpid
   4762					     public  _sc_exit
   4763					     public  _sc_waitpid
   4764					     public  _sc_wait
   4765					     public  _sc_kill
   4766					     public  _sc_fork
   4767					     public  _sc_reboot
   4768					     public  _sc_gettime
   4769					     public  _sc_getdate
   4770					     public  _sc_gotoxy
   4771					     public  _sc_wherey
   4772					     public  _sc_wherex
   4773					     public  _sc_setcolor
   4774					     public  _sc_getcolor
   4775					     public  _sc_clrscr
   4776					     public  _sc_getch
   4777					     public  _sc_putch
   4778					     public  _miniSO_init_semtable
   4779					     public  _miniSO_init_proctable
   4780					     extrn   _FP_OFF:near
   4781					     extrn   _FP_SEG:near
   4782					     extrn   _MK_FP:near
   4783					     extrn   _disable:near
   4784					     extrn   _enable:near
   4785					     extrn   _setvect:near
   4786				     _s@     equ     s@
   4787					     end
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 85
Symbol Table




Symbol Name		Type   Value			   Cref	(defined at #)

??DATE			Text   "10/25/17"
??FILENAME		Text   "scall	"
??TIME			Text   "19:54:52"
??VERSION		Number 030A
@10@58			Near   _TEXT:0207		   759	#760
@11@58			Near   _TEXT:0218		   782	#783
@12@58			Near   _TEXT:0244		   828	#829
@13@114			Near   _TEXT:02F3		   950	#951
@14@114			Near   _TEXT:038D		   1059	 #1060
@15@170			Near   _TEXT:03C6		   1104	 #1111
@15@226			Near   _TEXT:0403		   1110	 1138  #1147
@15@254			Near   _TEXT:0435		   1098	 #1180
@15@86			Near   _TEXT:03AC		   1080	 #1090
@17@142			Near   _TEXT:04AD		   #1300  1312
@17@170			Near   _TEXT:04AF		   1288	 1295  #1302
@17@198			Near   _TEXT:04B0		   1277	 #1304
@17@254			Near   _TEXT:04BA		   1301	 #1313
@17@58			Near   _TEXT:0489		   #1278  1306
@18@114			Near   _TEXT:04D0		   1334	 #1344
@18@58			Near   _TEXT:04C3		   #1335  1346
@19@114			Near   _TEXT:0596		   1454	 #1475
@19@58			Near   _TEXT:0576		   #1455  1477
@1@170			Near   _TEXT:0039		   #187	 268
@1@198			Near   _TEXT:0046		   #197	 211  226  242	257
@1@226			Near   _TEXT:0048		   #199	 269
@1@254			Near   _TEXT:0059		   #212	 270
@1@282			Near   _TEXT:006E		   #227	 271
@1@310			Near   _TEXT:0087		   174	184  #243
@1@338			Near   _TEXT:0088		   162	#245
@1@394			Near   _TEXT:0094		   198	#258
@1@58			Near   _TEXT:000D		   #163	 248
@1@C434			Word   _TEXT:0098		   186	#267
@20@114			Near   _TEXT:05D6		   1540	 #1541
@21@114			Near   _TEXT:05ED		   1577	 #1584
@21@142			Near   _TEXT:05F4		   #1595  1632
@21@198			Near   _TEXT:0607		   1608	 #1613
@21@254			Near   _TEXT:0617		   1618	 #1624
@21@282			Near   _TEXT:061B		   1594	 1623  #1630
@21@338			Near   _TEXT:082E		   1583	 #1929
@21@86			Near   _TEXT:05EA		   #1582  1928
@22@1010		Near   _TEXT:0A5B		   2298	 #2344
@22@1038		Near   _TEXT:0A6A		   2257	 #2354
@22@1066		Near   _TEXT:0A7B		   2364	 #2365
@22@1122		Near   _TEXT:0B0A		   2383	 #2448
@22@114			Near   _TEXT:085B		   #1984  2208
@22@1150		Near   _TEXT:0B14		   #2460  2461
@22@1178		Near   _TEXT:0B16		   2459	 #2462
@22@1206		Near   _TEXT:0B1C		   1994	 #2470
@22@142			Near   _TEXT:0861		   #1993  2469
@22@170			Near   _TEXT:0864		   1983	 #1995
@22@198			Near   _TEXT:0866		   #1997  2048
@22@226			Near   _TEXT:08A6		   1996	 #2041
@22@310			Near   _TEXT:08BC		   #2056  2099
@22@394			Near   _TEXT:0906		   2066	 2079  #2095
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 86
Symbol Table



@22@422			Near   _TEXT:0907		   2055	 #2097
@22@562			Near   _TEXT:0945		   #2133  2481	2482
@22@646			Near   _TEXT:0980		   2165	 #2175
@22@674			Near   _TEXT:098B		   2159	 2174  #2186
@22@702			Near   _TEXT:098D		   #2193  2486
@22@730			Near   _TEXT:098F		   #2200  2484	2485
@22@758			Near   _TEXT:0991		   2130	 #2207	2483
@22@786			Near   _TEXT:0994		   2192	 2199  2206  #2209
@22@842			Near   _TEXT:09D5		   2231	 #2258
@22@86			Near   _TEXT:084D		   1961	 #1969
@22@898			Near   _TEXT:0A14		   2277	 #2299
@22@926			Near   _TEXT:0A24		   #2311  2327
@22@954			Near   _TEXT:0A31		   2310	 #2321
@22@C1250		Word   _TEXT:0B22		   2132	 #2480
@23@114			Near   _TEXT:0B6F		   #2543  2811
@23@142			Near   _TEXT:0B72		   2533	 #2545
@23@226			Near   _TEXT:0BB3		   2585	 #2593
@23@254			Near   _TEXT:0C25		   2662	 #2663	2672
@23@310			Near   _TEXT:0C38		   2556	 #2678
@23@394			Near   _TEXT:0C80		   2720	 #2729
@23@422			Near   _TEXT:0C82		   2707	 #2734
@23@450			Near   _TEXT:0C90		   2733	 #2744
@23@506			Near   _TEXT:0CA5		   2749	 #2759
@23@534			Near   _TEXT:0CFB		   2544	 #2812
@23@86			Near   _TEXT:0B69		   2520	 #2534
@24@114			Near   _TEXT:0D54		   2880	 #2888
@24@142			Near   _TEXT:0DBB		   2950	 #2951	2960
@24@198			Near   _TEXT:0DCE		   2853	 #2966
@24@254			Near   _TEXT:0E21		   3000	 #3013
@24@282			Near   _TEXT:0E7B		   3067	 #3068
@25@114			Near   _TEXT:0E9D		   #3110  3160
@25@142			Near   _TEXT:0EDE		   3109	 #3153
@25@226			Near   _TEXT:0EF5		   #3168  3204
@25@310			Near   _TEXT:0F33		   3178	 3191  #3200
@25@338			Near   _TEXT:0F34		   3167	 #3202
@25@422			Near   _TEXT:0F5A		   3221	 #3229
@25@506			Near   _TEXT:0F90		   3252	 #3260
@25@534			Near   _TEXT:0FED		   3245	 3259  #3314
@25@590			Near   _TEXT:101F		   3340	 #3348
@25@646			Near   _TEXT:1074		   3376	 #3398
@25@674			Near   _TEXT:1083		   #3409  3425
@25@702			Near   _TEXT:1090		   3408	 #3419
@25@758			Near   _TEXT:10BF		   3397	 #3443
@25@786			Near   _TEXT:10FE		   #3483  3484
@25@86			Near   _TEXT:0E9B		   3100	 #3108
@26@58			Near   _TEXT:1119		   3512	 #3513
@27@58			Near   _TEXT:112E		   3536	 #3537
@28@114			Near   _TEXT:114F		   3573	 #3584
@28@198			Near   _TEXT:1223		   3606	 3633  #3710
@28@226			Near   _TEXT:122C		   3583	 #3722
@28@86			Near   _TEXT:114C		   #3582  3721
@29@142			Near   _TEXT:12B3		   3824	 #3832
@29@170			Near   _TEXT:130D		   3789	 #3886
@29@226			Near   _TEXT:1318		   3897	 #3898	3907
@29@254			Near   _TEXT:1328		   3896	 #3908
@29@282			Near   _TEXT:132C		   3914	 #3915
@29@86			Near   _TEXT:1279		   3768	 #3790
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 87
Symbol Table



@30@142			Near   _TEXT:1357		   #3959  3970
@30@170			Near   _TEXT:1359		   3948	 3954  #3961
@30@198			Near   _TEXT:135A		   3939	 #3963
@30@254			Near   _TEXT:1364		   3960	 #3971
@30@58			Near   _TEXT:1339		   #3940  3965
@31@114			Near   _TEXT:137E		   #4005  4029
@31@170			Near   _TEXT:138E		   4012	 #4018
@31@198			Near   _TEXT:1392		   4004	 4017  #4024
@31@254			Near   _TEXT:13DF		   #4069  4083
@31@282			Near   _TEXT:13E1		   4003	 #4071
@31@310			Near   _TEXT:13E2		   3994	 #4073
@31@366			Near   _TEXT:13EE		   4070	 #4084
@31@58			Near   _TEXT:136F		   #3995  4076
@32@114			Near   _TEXT:1413		   #4125  4140
@32@142			Near   _TEXT:1415		   4119	 #4127
@32@170			Near   _TEXT:1427		   4126	 #4141
@32@86			Near   _TEXT:1410		   4114	 #4120
@33@114			Near   _TEXT:144C		   4178	 #4189
@33@198			Near   _TEXT:14AB		   4234	 #4246
@33@226			Near   _TEXT:1508		   4206	 #4298
@33@254			Near   _TEXT:1511		   4188	 #4309
@33@86			Near   _TEXT:1449		   #4187  4308
@34@114			Near   _TEXT:1539		   4348	 #4359
@34@198			Near   _TEXT:1584		   4405	 #4413
@34@226			Near   _TEXT:1595		   #4427  4445
@34@254			Near   _TEXT:15A9		   4426	 #4442
@34@366			Near   _TEXT:15D3		   4451	 #4471
@34@394			Near   _TEXT:15F1		   4470	 #4490
@34@422			Near   _TEXT:163C		   4536	 #4537	4546
@34@478			Near   _TEXT:164E		   4376	 #4552
@34@506			Near   _TEXT:1651		   4551	 #4558
@34@534			Near   _TEXT:1657		   4358	 #4564
@34@86			Near   _TEXT:1536		   #4357  4563
@35@114			Near   _TEXT:167F		   #4607  4621
@35@142			Near   _TEXT:1681		   4601	 #4609
@35@170			Near   _TEXT:1692		   4608	 #4622
@35@86			Near   _TEXT:167C		   4596	 #4602
@3@114			Near   _TEXT:00BF		   326	#327
@5@114			Near   _TEXT:010E		   425	#431
@5@142			Near   _TEXT:0111		   430	#437
@5@170			Near   _TEXT:0113		   403	#442
@5@310			Near   _TEXT:0153		   503	#509
@5@338			Near   _TEXT:0156		   441	494  508  #515
@5@366			Near   _TEXT:016A		   536	#537
@6@114			Near   _TEXT:0188		   562	#574
@6@226			Near   _TEXT:01AB		   609	#612
@6@254			Near   _TEXT:01B8		   611	#626
@6@282			Near   _TEXT:01BC		   573	#633
@6@86			Near   _TEXT:0186		   #572	 632
@7@170			Near   _TEXT:01E0		   692	#693
@8@58			Near   _TEXT:01EB		   713	#714
@9@58			Near   _TEXT:01FA		   738	#739
@@0			Near   _TEXT:0090		   247	#249
@@1			Near   _TEXT:03B8		   1097	 #1099
@@10			Near   _TEXT:1553		   4375	 #4377
@@2			Near   _TEXT:0A94		   2382	 #2384
@@3			Near   _TEXT:0B86		   2555	 #2557
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 88
Symbol Table



@@4			Near   _TEXT:0D24		   2852	 #2854
@@5			Near   _TEXT:0F6D		   3244	 #3246
@@6			Near   _TEXT:1172		   3605	 #3607
@@7			Near   _TEXT:11A2		   3632	 #3634
@@8			Near   _TEXT:13E9		   4075	 #4077
@@9			Near   _TEXT:1466		   4205	 #4207
@CPU			Text   0101H
@CURSEG			Text   _TEXT			   #10	#14  #18  #22  #144  #1549  #1553  #4631  #4645	 #4725
@FILENAME		Text   SCALL
@WORDSIZE		Text   2			   #10	#14  #18  #22  #144  #1549  #1553  #4631  #4645	 #4725
B@			Byte   _BSS:0000		   #19
B@W			Word   _BSS:0000		   #20
D@			Byte   _DATA:0000		   #15
D@W			Word   _DATA:0000		   #16	1600  1612  1617  1622	1629
END_MSO			Near   _TEXT:043D		   #1197  1967	2172  2591  2886  3106	3227  3346  3830  4411
GETCURSORPOSITION	Near   _TEXT:00B0		   #306	 407  468  757	778
GET_PCB			Near   _TEXT:0482		   #1267  1601	1975  2224  2510  3214	3565
GET_SEM_POS		Near   _TEXT:1332		   #3929  4026	4107  4171  4341  4589
MINISO_COL		Byte   _DATA:0000		   #23	361  491  664
MINISO_COR		Byte   _DATA:0001		   #25	369  448  711  733
MINISO_ISKEY		Byte   _DATA:0003		   #29	561  566  616
MINISO_KEY		Byte   _DATA:0004		   #31	570  621
MINISO_PAG		Byte   _DATA:0002		   #27	287  313  452
NEXTSEMID		Word   _DATA:0005		   #33	4011  4016  4023  4025	4044  4046
S@			Byte   _DATA:008A		   1219	 1243  1965  2170  2589	 2884  3104  3225  3344	 3828  4409  #4646
SCROLL			Near   _TEXT:00C1		   #338	 436  514
SETCURSORPOSITION	Near   _TEXT:00A0		   #276	 530  686  822
_DISABLE		Near   ----:---- Extern		   1367	 1588  1955  2504  2677	 2839  2965  3094  3559	 3752  4166  4336 +
							   #4783
_ENABLE			Near   ----:---- Extern		   1214	 1500  1529  1923  1988	 2454  2538  2661  2806	 2949  3058  3482 +
							   3577	 3716  3891  4182  4303	 4352  4535  4557  #4784
_END_MSO		Alias  END_MSO			   #4732
_FP_OFF			Near   ----:---- Extern		   1817	 #4780
_FP_SEG			Near   ----:---- Extern		   1802	 #4781
_GETCH			Near   ----:---- Extern		   1251	 #4751
_GETCURSORPOSITION	Alias  GETCURSORPOSITION	   #4734
_GET_PCB		Alias  GET_PCB			   #4731
_GET_SEM_POS		Alias  GET_SEM_POS		   #4727
_MINISO_COL		Alias  MINISO_COL		   #4749
_MINISO_CONTEXTSWITCH	Near   _TEXT:0391		   #1072  4729
_MINISO_COR		Alias  MINISO_COR		   #4748
_MINISO_DELCURTHREAD	Byte   _BSS:0006		   1103	 1109  1491  2185  2458	 3478  #4636  4739
_MINISO_FREE		Word   _DATA:0009		   #39	1449  1576  1638  1642	1647  2023  2029  2247	2253  2787  2794  +
							   3020	 3034  3135  3149  4740
_MINISO_INIT_PROCTABLE	Near   _TEXT:04D7		   #1357  4779
_MINISO_INIT_SEMTABLE	Near   _TEXT:04BC		   #1324  1373	4778
_MINISO_ISKEY		Alias  MINISO_ISKEY		   #4746
_MINISO_KEY		Alias  MINISO_KEY		   #4745
_MINISO_NEXTTHREAD	Word   _BSS:0004		   1079	 1089  1095  1153  1186	 1495  2181  2657  2945	 3474  3881  4531 +
							   #4634  4738
_MINISO_OLDISR		Dword  _BSS:0000		   1205	 1206  1520  1521  #4632  4737
_MINISO_PAG		Alias  MINISO_PAG		   #4747
_MINISO_READY		Word   _DATA:0007		   #36	1084  1096  1117  1125	1133  1142  1154  1158	1167  1175  1378  +
							   1382	 1390  1398  1401  1407	 1410  1416  1424  1432	 1440  1659  1879 +
							   1901	 1915  2158  2164  2389	 2411  2426  2527  2562	 2711  2843  2847 +
							   2878	 3099  3123  3154  3185	 3209  3258  3265  3287	 3301  3320  3329 +
							   3338	 3383  3389  3432  3438	 3448  3456  3464  3507	 3531  3640  3664 +
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 89
Symbol Table



							   3675	 3756  4250  4276  4287	 4381  4741
_MINISO_RETURN_ADDR	Near   ----:---- Extern		   1789	 #4728
_MINISO_SCALL_TABLE	Word   _DATA:000B		   #42	171  182  196  209  223	 240  4736
_MINISO_SEM		Word   _BSS:01A7		   1342	 3947  3952  4002  4037	 4045  4054  4061  4068	 4118  4135  4197 +
							   4204	 4214  4226  4233  4241	 4367  4374  4425  4458	 4600  4616  #4640+
							   4744
_MINISO_THREAD		Word   _BSS:0007		   1088	 1121  1129  1137  1146	 1162  1171  1179  1287	 1293  1386  1394 +
							   1403	 1412  1420  1428  1436	 1444  1465  1473  1482	 1486  1646  1655 +
							   1663	 1670  1811  1826  1834	 1842  1850  1858  1866	 1874  1883  1894 +
							   1903	 1911  1919  2009  2016	 2025  2037  2046  2065	 2071  2078  2087 +
							   2094	 2109  2118  2128  2145	 2154  2223  2240  2249	 2268  2276  2286 +
							   2294	 2309  2320  2326  2335	 2343  2353  2363  2376	 2393  2404  2413 +
							   2422	 2431  2439  2447  2525	 2532  2554  2570  2579	 2602  2610  2618 +
							   2627	 2635  2644  2653  2671	 2693  2702  2715  2728	 2743  2758  2777 +
							   2789	 2802  2851  2863  2872	 2897  2905  2913  2921	 2931  2940  2959 +
							   2976	 2984  2991  2999  3008	 3012  3022  3030  3052	 3066  3121  3128 +
							   3137	 3145  3158  3177  3183	 3190  3199  3213  3243	 3251  3257  3269 +
							   3280	 3289  3297  3305  3313	 3324  3333  3358  3367	 3375  3385  3393 +
							   3407	 3418  3424  3434  3442	 3452  3460  3469  3511	 3535  3595  3604 +
							   3617	 3624  3631  3644  3652	 3660  3668  3677  3685	 3694  3701  3709 +
							   3765	 3777
_MK_FP			Near   ----:---- Extern		   856	977  1684  2765	 3040  #4782
_NEXTSEMID		Alias  NEXTSEMID		   #4743
_PUTCH			Near   ----:---- Extern		   1237	 #4752
_PUTSTR			Near   ----:---- Extern		   1221	 1229  1245  #4750
_S@			Alias  S@			   #4786
_SCALL			Near   _TEXT:0000		   #149	 4730
_SCROLL			Alias  SCROLL			   #4733
_SC_CLRSCR		Near   _TEXT:01C0		   54  #645  4775
_SC_EXIT		Near   _TEXT:0E81		   106	1709  #3082  4762
_SC_FORK		Near   _TEXT:05D8		   90  #1558  4766
_SC_GETCH		Near   _TEXT:0170		   50  #551  4776
_SC_GETCOLOR		Near   _TEXT:01E2		   58  #704  4774
_SC_GETDATE		Near   _TEXT:0248		   78  #842  4769
_SC_GETPID		Near   _TEXT:1106		   110	#3500  4761
_SC_GETPPID		Near   _TEXT:111B		   114	#3524  4760
_SC_GETTIME		Near   _TEXT:02F8		   82  #964  4768
_SC_GOTOXY		Near   _TEXT:021A		   74  #794  4770
_SC_KILL		Near   _TEXT:0834		   94  #1943  4765
_SC_PUTCH		Near   _TEXT:00DA		   46  #384  4777
_SC_REBOOT		Near   _TEXT:05B8		   86  1256  #1512  4767
_SC_SEMCREATE		Near   _TEXT:1366		   126	#3982  4757
_SC_SEMDESTROY		Near   _TEXT:165D		   142	#4578  4753
_SC_SEMDOWN		Near   _TEXT:1517		   138	#4323  4754
_SC_SEMSET		Near   _TEXT:13F1		   130	#4096  4756
_SC_SEMUP		Near   _TEXT:142A		   134	#4153  4755
_SC_SENDSIGNAL		Near   _TEXT:1130		   118	#3548  4759
_SC_SETCOLOR		Near   _TEXT:01ED		   62  #725  4773
_SC_WAIT		Near   _TEXT:0D01		   102	#2826  4764
_SC_WAITPID		Near   _TEXT:0B2E		   98  #2491  4763
_SC_WAITSIGNAL		Near   _TEXT:1230		   122	#3735  4758
_SC_WHEREX		Near   _TEXT:01FC		   66  #750  4772
_SC_WHEREY		Near   _TEXT:0209		   70  #771  4771
_SETCURSORPOSITION	Alias  SETCURSORPOSITION	   #4735
_SETVECT		Near   ----:---- Extern		   1209	 1524  #4785
Turbo Assembler	 Version 3.1	    10/25/17 19:54:53	    Page 90
Symbol Table




Macro Name						   Cref	(defined at #)

$COMM							   #1

Groups & Segments	Bit Size Align	Combine	Class	   Cref	(defined at #)

DGROUP			Group				   #12	13  171	 182  196  209	223  240  287  313  361	 369  448  452	  +
							   491	561  566  570  616  621	 664  711  733	1079  1084  1088  1089	  +
							   1095	 1096  1103  1109  1117	 1121  1125  1129  1133	 1137  1142  1146 +
							   1153	 1154  1158  1162  1167	 1171  1175  1179  1186	 1205  1206  1219 +
							   1243	 1287  1293  1342  1378	 1382  1386  1390  1394	 1398  1401  1403 +
							   1407	 1410  1412  1416  1420	 1424  1428  1432  1436	 1440  1444  1449 +
							   1465	 1473  1482  1486  1491	 1495  1520  1521  1576	 1600  1612  1617 +
							   1622	 1629  1638  1642  1646	 1647  1655  1659  1663	 1670  1811  1826 +
							   1834	 1842  1850  1858  1866	 1874  1879  1883  1894	 1901  1903  1911 +
							   1915	 1919  1965  2009  2016	 2023  2025  2029  2037	 2046  2065  2071 +
							   2078	 2087  2094  2109  2118	 2128  2145  2154  2158	 2164  2170  2181 +
							   2185	 2223  2240  2247  2249	 2253  2268  2276  2286	 2294  2309  2320 +
							   2326	 2335  2343  2353  2363	 2376  2389  2393  2404	 2411  2413  2422 +
							   2426	 2431  2439  2447  2458	 2525  2527  2532  2554	 2562  2570  2579 +
							   2589	 2602  2610
  _BSS			16  01F7 Word	Public	BSS	   12  #18  #4631
  _DATA			16  0209 Word	Public	DATA	   12  #14  #22	 #1549	#4645
_TEXT			16  1695 Byte	Public	CODE	   #10	13  #144  148  275  305	 337  383  550	644  703  724  749  770	  +
							   793	841  963  1071	1196  1266  1323  1356	1511  #1553  1557  1942	  +
							   2490	 2825  3081  3499  3523	 3547  3734  3928  3981	 4095  4152  4322 +
							   4577	 #4725
